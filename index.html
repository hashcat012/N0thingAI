<!DOCTYPE html>
<html lang="tr">
<head>
    <meta name="google-site-verification" content="AQSoYrgNNGutZzf4jpzwVieUI29wYj_CJKfNka2Uk4I" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N0thingAI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%239E9E9E'/><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='70' font-weight='bold' fill='%23FFFFFF' font-family='Arial, sans-serif' dy='.1em'>N</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Değişkenleri - SİYAH/BEYAZ TEMA (ChatGPT Stili) */
        :root {
            /* Varsayılan: Koyu Tema */
            --bg-primary: #202123; /* Ana Arkaplan */
            --sidebar-bg: #0D0D0D; /* Kenar Çubuğu (Daha Koyu) */
            --text-primary: #ECECEC; /* Ana Metin Rengi */
            --text-secondary: #A6A6A6; /* İkincil Metin Rengi */
            --highlight-color: #20C20E; /* N0thingAI Neon Yeşili */
            --active-chat-bg: #2A2A2A; /* Aktif Sohbet Arkaplanı */
            --ai-message-bg: #2A2A2A; /* AI Mesaj Arkaplanı */
            --user-message-bg: #004d00; /* Kullanıcı Mesajı (Koyu Yeşil) */
            --input-bg: #2A2A2A; /* Input Alanı Arkaplanı */
            --input-border: #3A3A3A;
            --shadow-color: rgba(0, 0, 0, 0.3); /* Koyu gölge */
            --modal-bg: #1A1A1A;
            --btn-border: #444;
            --btn-hover: #333;
        }

        /* İSTEK: Varsayılan Gri Arka Plan / Beyaz Yazı */
        .dark-mode {
            --bg-primary: #202123;      /* Koyu Gri Arka Plan */
            --sidebar-bg: #1A1A1A;      /* Daha Koyu Gri Sidebar */
            --text-primary: #ECECEC;      /* Beyazımsı Yazı */
            --text-secondary: #A6A6A6;    /* Soluk Gri Yazı */
            --highlight-color: #9E9E9E; /* Nötr Gri Vurgu */
            --active-chat-bg: #2A2A2A;
            --ai-message-bg: #2A2A2A;
            --user-message-bg: #333333; /* Koyu Gri Kullanıcı Mesajı */
            --input-bg: #2A2A2A;
            --input-border: #3A3A3A;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-bg: #1A1A1A;
            --btn-border: #444;
            --btn-hover: #333;
        }
        
        /* İSTEK: İkincil Beyaz Arka Plan / Gri Yazı */
        .light-mode {
            --bg-primary: #FFFFFF;      /* Beyaz Arka Plan */
            --sidebar-bg: #F9F9F9;
            --text-primary: #333333;      /* Gri Yazı */
            --text-secondary: #555;
            --highlight-color: #555555; /* Koyu Gri Vurgu */
            --active-chat-bg: #EAEAEA;
            --ai-message-bg: #F0F0F0;
            --user-message-bg: #EAEAEA; /* Açık Gri Kullanıcı Mesajı */
            --input-bg: #FFFFFF;
            --input-border: #E0E0E0;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --modal-bg: #FFFFFF;
            --btn-border: #E0E0E0;
            --btn-hover: #F0F0F0;
        }

        /* Genel Stil */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .app-container { 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            transition: padding-left 0.3s ease-in-out;
        }

        /* Sidebar (Geniş ve Katlanmış) */
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 16px;
            border-right: 1px solid var(--input-border);
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out;
            overflow: visible; 
            position: fixed;
            height: 100%;
            z-index: 40;
        }
        .sidebar.collapsed {
            width: 72px;
            padding: 16px 14px;
        }

        .chat-area {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background-color: var(--bg-primary);
            margin-left: 280px;
            transition: margin-left 0.3s ease-in-out;
            width: calc(100% - 280px);
        }
        .sidebar.collapsed + .chat-area {
            margin-left: 72px;
            width: calc(100% - 72px);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-shrink: 0;
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden;
        }
        .logo-svg {
            width: 32px;
            height: 32px;
            background-color: var(--highlight-color); 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--sidebar-bg);
            font-size: 20px;
            padding-bottom: 2px;
            flex-shrink: 0;
        }
        .light-mode .logo-svg { color: #FFFFFF; }
        .dark-mode .logo-svg { color: #FFFFFF; }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--text-primary);
            white-space: nowrap;
        }

        .sidebar.collapsed .logo-text {
            display: none;
        }
        .sidebar.collapsed .sidebar-header {
            justify-content: center;
        }
        
        .toggle-sidebar-btn {
            background-color: var(--btn-hover);
            color: var(--text-secondary);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--input-border);
            position: absolute;
            right: -14px;
            top: 24px;
            z-index: 45;
            transition: transform 0.3s ease, background-color 0.2s;
        }
        .toggle-sidebar-btn:hover {
            background-color: var(--active-chat-bg);
            color: var(--text-primary);
        }
        .sidebar.collapsed .toggle-sidebar-btn {
            transform: rotate(180deg);
        }


        .chat-search-wrapper {
            position: relative;
            margin-bottom: 12px;
            flex-shrink: 0;
            transition: all 0.3s ease-in-out;
        }
        .chat-search-wrapper input {
            width: 100%;
            padding: 8px 12px 8px 34px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease-in-out;
        }
        .chat-search-wrapper i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: opacity 0.2s, left 0.3s ease-in-out, font-size 0.3s ease-in-out;
        }
        .sidebar.collapsed .chat-search-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 44px; 
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid var(--btn-border);
        }
        .sidebar.collapsed .chat-search-wrapper:hover {
            background-color: var(--btn-hover);
        }
        .sidebar.collapsed .chat-search-wrapper input {
            opacity: 0;
            width: 0;
            height: 0;
            padding: 0;
            margin: 0;
            border: none;
            position: absolute;
        }
        .sidebar.collapsed .chat-search-wrapper i {
            opacity: 1;
            position: static;
            transform: none;
            font-size: 1.1rem;
            padding: 0;
            margin: 0;
            left: 0;
        }


        /* Yeni Sohbet Butonu */
        .new-chat-btn-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-shrink: 0;
        }
        .new-chat-btn {
            padding: 8px 16px; 
            background-color: transparent;
            border: 1px solid var(--btn-border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            flex-shrink: 0;
            width: 100%; 
            transition: width 0.3s ease-in-out, height 0.3s ease-in-out, padding 0.3s ease-in-out, flex-grow 0.3s ease-in-out;
            flex-grow: 1;
        }
        .new-chat-btn:hover { background-color: var(--btn-hover); }
        .new-chat-btn i { 
            margin-right: 8px; 
            transition: margin 0.3s ease-in-out;
        }
        .new-chat-btn .btn-text {
            white-space: nowrap;
            transition: opacity 0.2s;
        }
        #temp-chat-btn {
            flex-grow: 0; 
            flex-shrink: 0; 
            padding: 8px 12px;
        }
        #temp-chat-btn i {
            margin-right: 0; 
        }
        #header-temp-chat-btn {
             flex-grow: 0;
             flex-shrink: 0;
             width: auto;
             padding: 8px 12px;
        }
        #header-temp-chat-btn i {
            margin-right: 0;
        }


        /* Sohbet Geçmişi Alanı */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1rem;
            overflow-x: hidden;
        }
        .chat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s;
            color: var(--text-secondary);
        }
        .chat-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            padding-right: 10px;
            transition: opacity 0.2s;
        }
        .chat-item-menu-btn {
            display: none;
            flex-shrink: 0;
            padding: 4px 8px;
            border-radius: 6px;
            background-color: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 5;
        }
        .chat-item:hover .chat-item-menu-btn {
            display: block; 
        }
        .chat-item-menu-btn:hover {
            background-color: var(--btn-hover);
            color: var(--text-primary);
        }
        .context-menu-item {
            transition: background-color 0.2s;
        }
        .context-menu-item:hover {
            background-color: var(--btn-hover);
        }
        .context-menu-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .context-menu-item:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }

        .chat-item.active {
            background-color: var(--active-chat-bg);
            color: var(--text-primary);
            font-weight: 600;
        }
        .chat-item:not(.active):hover {
            background-color: var(--btn-hover);
        }
        
        #current-mode-display {
            display: none; 
            border-color: var(--highlight-color);
            color: var(--highlight-color);
            background-color: color-mix(in srgb, var(--highlight-color) 10%, transparent);
            text-align: center;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.2s;
        }

        /* Profil ve Ayarlar (Dinamik Auth Alanı) */
        .sidebar-footer {
            border-top: 1px solid var(--input-border);
            padding-top: 16px;
            margin-top: auto;
            flex-shrink: 0;
        }
        #auth-container { 
            transition: all 0.3s; 
            overflow: hidden;
        }
        
        #plus-btn {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 10px;
            background-color: var(--highlight-color);
            color: #fff; 
            font-weight: 700;
            transition: background-color 0.2s, opacity 0.3s ease-in-out, left 0.3s ease-in-out, transform 0.3s ease-in-out;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .dark-mode #plus-btn { color: #1A1A1A; }
        .light-mode #plus-btn { color: #FFFFFF; }
        #plus-btn:hover {
            background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }
        #plus-btn i {
             text-shadow: 0 0 8px color-mix(in srgb, var(--highlight-color) 50%, white);
             font-size: 0.8rem;
        }

        #user-profile-view {
            transition: background-color 0.2s;
            overflow: hidden;
            white-space: nowrap;
        }
        #user-profile-view:hover {
            background-color: var(--active-chat-bg);
        }
        #profile-pic {
            background-color: var(--highlight-color);
            color: var(--sidebar-bg);
        }
        .light-mode #profile-pic {
             color: #FFFFFF;
        }
        #profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #user-profile-view .truncate {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            transition: opacity 0.2s;
        }


        #login-btn {
            background-color: #AEAEAE;
            color: #fff;
            font-weight: 700;
            transition: background-color 0.2s, width 0.3s ease-in-out, height 0.3s ease-in-out, padding 0.3s ease-in-out;
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }
        #login-btn .btn-text {
            white-space: nowrap;
            transition: opacity 0.2s;
        }
        #login-btn i {
            margin-right: 8px;
            transition: margin 0.3s ease-in-out;
            font-size: 1.1rem;
        }

        .dark-mode #login-btn {
            color: var(--sidebar-bg);
        }
        .light-mode #login-btn {
            color: var(--sidebar-bg);
        }
        #login-btn:hover {
            background-color: color-mix(in srgb, #AEAEAE 85%, black);
        }

        /* --- YENİ: TÜM KATLANMIŞ STİLLER --- */
        .sidebar.collapsed .chat-history {
            margin-top: 0;
        }
        .sidebar.collapsed .chat-item-title,
        .sidebar.collapsed .chat-item-menu-btn,
        .sidebar.collapsed #current-mode-display {
            display: none;
        }
        .sidebar.collapsed .chat-item {
            justify-content: center;
            padding: 10px 12px;
        }
        .sidebar.collapsed .sidebar-footer {
            padding-top: 12px;
        }
        .sidebar.collapsed #login-btn {
            width: 44px;
            height: 44px;
            padding: 0;
            justify-content: center;
        }
        .sidebar.collapsed #login-btn .btn-text {
            display: none;
        }
        .sidebar.collapsed #login-btn i {
            margin-right: 0;
        }

        .sidebar.collapsed #user-profile-view {
            justify-content: center;
            padding: 0;
        }
        .sidebar.collapsed #user-name,
        .sidebar.collapsed #user-profile-view .fa-cog {
            display: none;
        }
        .sidebar.collapsed #profile-pic {
            width: 44px;
            height: 44px;
            font-size: 1.2rem;
        }


        .sidebar.collapsed .new-chat-btn-wrapper {
            flex-direction: column;
            gap: 8px;
        }
        .sidebar.collapsed .new-chat-btn {
            width: 44px;
            height: 44px; 
            padding: 0;
            justify-content: center;
            flex-grow: 0;
        }
        .sidebar.collapsed .new-chat-btn .btn-text {
            display: none;
        }
        .sidebar.collapsed .new-chat-btn i {
            margin-right: 0;
        }
        
        .sidebar:not(.collapsed) #wrapper-temp-chat-btn {
            display: none;
        }
        .sidebar.collapsed #header-temp-chat-btn {
            display: none;
        }
        /* --- KATLANMIŞ STİLLER SONU --- */


        
        #token-display {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-secondary);
            font-weight: 700;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: opacity 0.3s ease-in-out, right 0.3s ease-in-out;
        }

        #token-symbol {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
            background-color: var(--highlight-color);
            color: white;
        }
        .dark-mode #token-symbol { color: #1A1A1A; }
        
        .messages-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            scroll-behavior: smooth;
            padding-top: 70px; 
            padding-bottom: 120px;
        }

        #scroll-to-bottom-btn {
            display: none;
            position: absolute;
            bottom: 130px; 
            right: 30px;
            z-index: 20;
            background-color: var(--input-bg);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            box-shadow: 0 4px 10px var(--shadow-color);
            transition: all 0.2s;
            cursor: pointer;
        }
        #scroll-to-bottom-btn:hover {
            color: var(--text-primary);
            background-color: var(--btn-hover);
        }

        /* DÜZELTME: Mesaj Balonları Stilleri */
        .chat-bubble {
            padding: 14px 20px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            box-shadow: 0 4px 12px var(--shadow-color);
            max-width: 90%;
            margin-bottom: 24px;
        }
        
        .chat-bubble.ai {
            background-color: var(--ai-message-bg);
            color: var(--text-primary);
            border-top-left-radius: 5px;
            margin-right: auto;
        }

        .chat-bubble.user {
            background-color: var(--user-message-bg);
            color: var(--text-primary); 
            border-top-right-radius: 5px;
            margin-left: auto;
        }
        .light-mode .chat-bubble.user {
             color: #202123;
        }
        .dark-mode .chat-bubble.user {
             color: var(--text-primary);
        }
        
        .system-message-row { 
            display: flex;
            justify-content: center; 
            max-width: 100%; 
            margin-bottom: 24px;
        }
        .system-message-row .message-content {
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
            text-align: center;
            box-shadow: none;
            padding: 0;
        }
        .system-message-row .error {
            color: #FF6B6B;
            font-weight: 500;
        }

        .image-container {
            max-width: 400px;
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--input-border);
        }
        .image-container img { width: 100%; height: auto; display: block; }
        
        .attachment-preview {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            padding: 8px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            box-shadow: 0 -4px 15px var(--shadow-color);
            max-width: 300px;
        }
        .attachment-preview img {
            max-height: 150px;
            width: auto;
            border-radius: 8px;
        }
        .attachment-preview .remove-attachment {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #FF6B6B;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Girdi Kutusu (Input Area) */
        .input-area-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: linear-gradient(to top, var(--bg-primary) 70%, transparent);
            pointer-events: none;
            transition: opacity 0.3s;
        }
        /* YENİ: Sesli moddayken giriş alanını gizle */
        body.voice-chat-active .input-area-wrapper {
            opacity: 0;
            pointer-events: none;
        }

        .input-area {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color);
            pointer-events: auto;
        }
        
        .input-area textarea {
            flex-grow: 1;
            padding: 10px 8px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 150px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .input-area textarea:disabled {
            background-color: transparent;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .icon-btn:hover:not(:disabled) {
            color: var(--text-primary);
            background-color: var(--btn-hover);
        }
        .icon-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        /* Artı Butonu Popover Stilleri */
        .plus-btn-wrapper {
            position: relative;
        }
        #input-popover-menu {
            position: absolute;
            bottom: 120%; /* Butonun üstünde */
            left: 0;
            z-index: 30;
            background-color: var(--modal-bg);
            border: 1px solid var(--input-border);
            border-radius: 8px;
            box-shadow: 0 4px 15px var(--shadow-color);
            width: 220px; /* Genişletildi */
            padding: 8px;
        }
        .popover-btn {
            display: flex;
            align-items: center;
            gap: 10px;
            width: 100%;
            padding: 10px 12px;
            font-size: 0.9rem;
            text-align: left;
            border-radius: 6px;
            transition: background-color 0.2s;
        }
        .popover-btn:hover {
            background-color: var(--btn-hover);
        }
        /* YENİ: Popover butonu engelliyse */
        .popover-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
            background-color: transparent;
        }

        /* Görsel Oluşturma Etiketi (Chip) */
        #image-prompt-tag {
            background-color: #3b82f6; /* Tailwind blue-500 */
            color: white;
            font-size: 0.875rem; /* text-sm */
            font-weight: 500;
            padding: 4px 12px;
            border-radius: 9999px; /* rounded-full */
            margin-right: 8px;
            display: flex;
            align-items: center;
            flex-shrink: 0;
        }
        #image-prompt-tag button {
            margin-left: 8px;
            color: white;
            opacity: 0.7;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: bold;
        }
        #image-prompt-tag button:hover {
            opacity: 1;
        }
        .input-area.image-mode-active #input-plus-btn,
        .input-area.image-mode-active #speech-to-text-btn {
            display: none;
        }
        .input-area:not(.image-mode-active) #image-prompt-tag {
            display: none;
        }


        #speech-to-text-btn.recording {
            color: #FF6B6B;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .send-btn {
            background-color: var(--highlight-color);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin-left: 8px;
            font-weight: 700;
        }
        .dark-mode .send-btn {
            color: #1A1A1A;
        }
        .send-btn:disabled {
            background-color: var(--text-secondary);
            opacity: 0.6;
        }
        .send-btn:not(:disabled):hover {
             background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }

        .ai-typing-indicator {
            display: none; 
            align-items: center;
            height: 20px;
            margin: 5px 0 15px 0;
        }
        .ai-typing-indicator.visible { display: flex; }
        .dot {
            width: 8px; height: 8px; background-color: var(--highlight-color); border-radius: 50%;
            margin-right: 5px; animation: bounce 0.8s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.1s; }
        .dot:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Modal Stilleri */
        .modal { z-index: 50; }
        .modal-overlay {
            backdrop-filter: blur(5px);
            transition: opacity 0.3s;
        }
        .modal-content {
            background-color: var(--modal-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid var(--input-border);
        }
        .modal-content .verify-btn {
            background-color: var(--highlight-color);
            color: var(--sidebar-bg);
            font-weight: 600;
            padding: 10px;
            border-radius: 8px;
            transition: background-color 0.2s;
        }
        .modal-content .verify-btn:hover {
             background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }
        .modal-content .verify-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .modal input, .modal select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        /* YENİ: Şifre göz ikonu */
        .password-wrapper {
            position: relative;
        }
        .password-wrapper input {
            padding-right: 40px; /* İkon için yer aç */
        }
        .password-toggle-btn {
            position: absolute;
            right: 0;
            top: 0;
            bottom: 0;
            width: 40px;
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
        }

        .social-btn {
            border: 1px solid var(--btn-border);
            transition: background-color 0.2s;
        }
        .social-btn:hover { background-color: var(--btn-hover); }
        .light-mode .social-btn:hover { background-color: #E0E0E0; }

        .text-green-500 { color: #22c55e; }
        .text-red-500 { color: #ef4444; }

        /* YENİ: Sesli Konuşma Baloncuğu */
        #voice-chat-bubble {
            position: absolute;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 30;
            display: none; /* Varsayılan olarak gizli */
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color);
            transition: opacity 0.3s;
        }
        body.voice-chat-active #voice-chat-bubble {
            display: flex;
        }
        #voice-chat-bubble-btn {
            width: 44px;
            height: 44px;
            border-radius: 50%;
            background-color: var(--highlight-color);
            color: #1A1A1A;
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #voice-chat-bubble-btn.recording {
            background-color: #FF6B6B;
            animation: pulse 1.5s infinite;
        }
        #voice-chat-status {
            color: var(--text-secondary);
            font-weight: 500;
        }
        #voice-chat-close-btn {
            font-size: 1.4rem;
            color: var(--text-secondary);
        }
        #voice-chat-close-btn:hover {
            color: var(--text-primary);
        }


        /* Responsive Tasarım */
        @media (max-width: 768px) {
            .sidebar {
                left: -280px;
                transition: left 0.3s ease-in-out;
            }
            .sidebar.open {
                left: 0;
            }
            .chat-area {
                margin-left: 0;
                width: 100%;
            }
            .sidebar.collapsed + .chat-area {
                margin-left: 0;
                width: 100%;
            }
            
            .toggle-sidebar-btn {
                display: none;
            }

            .hamburger-btn {
                display: block; 
                position: absolute;
                top: 15px;
                left: 15px;
                z-index: 30;
                background-color: var(--input-bg);
                border: 1px solid var(--input-border);
                border-radius: 8px;
                padding: 8px 10px;
                box-shadow: 0 4px 10px var(--shadow-color);
            }
            .mobile-overlay {
                position: absolute;
                inset: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 39;
                display: none;
            }
            .sidebar.open ~ .chat-area .mobile-overlay {
                display: block;
            }

            .input-area-wrapper { padding: 12px; }
            .input-area { padding: 6px 8px; }
            .messages-container {
                padding: 10px;
                padding-top: 70px;
                padding-bottom: 100px;
            }
            .chat-bubble { max-width: 95%; }

            #token-display {
                top: 15px;
                right: 15px;
                left: auto;
            }
            #scroll-to-bottom-btn {
                bottom: 110px;
                right: 15px;
            }
            #plus-btn {
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
            }

            /* YENİ: Ses baloncuğu mobil */
            #voice-chat-bubble {
                width: calc(100% - 24px); /* Kenarlardan 12px padding */
                bottom: 12px;
                justify-content: space-between;
            }
        }
        @media (min-width: 769px) {
            .hamburger-btn {
                display: none;
            }
            .mobile-overlay {
                display: none;
            }

            .sidebar.collapsed + .chat-area #collapsed-logo-text {
                display: block;
            }
        }
    </style>
</head>
<body class="dark-mode"> 
    <div class="app-container">
        <!-- Sol Kenar Çubuğu -->
        <aside class="sidebar" id="sidebar">
            <header class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-svg">N</div>
                    <span class="logo-text">N0thingAI</span>
                </div>
                <button class="new-chat-btn temp-chat-trigger" id="header-temp-chat-btn" title="Geçici Sohbet Başlat (Kaydedilmez)">
                    <i class="fas fa-user-secret" style="margin-right: 0;"></i>
                </button>
            </header>

            <button class="toggle-sidebar-btn" id="toggle-sidebar-btn">
                <i class="fas fa-chevron-left"></i>
            </button>

            <div class="chat-search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="chat-search-input" placeholder="Sohbetleri ara..." data-translate="search-chats">
            </div>

            <div class="flex items-center gap-2 new-chat-btn-wrapper">
                <button class="new-chat-btn flex-grow" id="new-chat-btn">
                    <i class="fas fa-plus"></i>
                    <span class="btn-text" data-translate="new-chat"> Yeni Sohbet</span>
                </button>
                <button class="new-chat-btn temp-chat-trigger" id="wrapper-temp-chat-btn" title="Geçici Sohbet Başlat (Kaydedilmez)" data-translate-title="temp-chat-title">
                    <i class="fas fa-user-secret" style="margin-right: 0;"></i>
                    <span class="btn-text hidden"></span> 
                </button>
            </div>
            
            <nav class="chat-history">
                <ul id="chat-history-list" class="space-y-1">
                    <li id="current-mode-display" class="text-xs px-3 py-2 rounded-lg font-semibold border" style="display: none;" data-translate="temp-chat-active">
                        Geçici Sohbet
                    </li>
                </ul>
            </nav>
            
            <footer class="sidebar-footer">
                <div id="auth-container" class="w-full">
                    <div id="user-profile-view" class="hidden flex items-center justify-between cursor-pointer p-2 rounded-lg" onclick="window.openSettingsModal()">
                        <div class="flex items-center space-x-3 min-w-0">
                            <span id="profile-pic" class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm"></span>
                            <span id="user-name" class="text-sm font-semibold truncate"></span>
                        </div>
                        <i class="fas fa-cog text-lg opacity-70"></i>
                    </div>
                    
                    <div id="login-view" class="">
                        <button id="login-btn" class="w-full py-3 login-btn rounded-xl font-semibold" onclick="window.openSettingsModal()">
                            <i class="fas fa-sign-in-alt"></i>
                            <span class="btn-text" data-translate="login-signup"> Giriş Yap / Kayıt Ol</span>
                        </button>
                    </div>

                </div>
            </footer>
        </aside>

        <!-- Sohbet Alanı -->
        <main class="chat-area">
            <button class="icon-btn hamburger-btn md:hidden" id="open-sidebar-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <span id="collapsed-logo-text" class="hidden md:hidden text-lg font-bold" 
                  style="position: absolute; top: 15px; left: 20px; z-index: 20; color: var(--text-primary); white-space: nowrap;">
                N0thingAI
            </span>

            <button id="plus-btn" class="">
                <i class="fas fa-star"></i> Plus
            </button>

            <div id="token-display" class="">
                <span id="token-symbol">N</span>
                <span id="token-count">...</span>
            </div>

            <div class="mobile-overlay md:hidden" id="mobile-overlay"></div>

            <button id="scroll-to-bottom-btn" class="items-center justify-center">
                <i class="fas fa-arrow-down"></i>
            </button>

            <div class="messages-container" id="messages-container">
                <!-- Mesajlar buraya gelecek -->
            </div>
            
            <div class="ai-typing-indicator" id="typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span id="loading-text" class="ml-2 text-sm" style="color: var(--text-secondary);"></span>
            </div>

            <div class="attachment-preview" id="attachment-preview">
                <img id="preview-image" src="" alt="Ek önizlemesi">
                <button class="remove-attachment" id="remove-attachment-btn">&times;</button>
            </div>

            <div class="input-area-wrapper">
                <div class="input-area" id="input-area">
                    
                    <div class="plus-btn-wrapper">
                        <button class="icon-btn" id="input-plus-btn" title="Seçenekler" data-translate-title="options">
                            <i class="fas fa-plus"></i>
                        </button>
                        <div id="input-popover-menu" class="hidden">
                             <button id="popover-upload-btn" class="popover-btn">
                                 <i class="fas fa-paperclip w-4"></i> <span data-translate="upload-file">Dosya / Fotoğraf Yükle</span>
                             </button>
                             <button id="popover-image-btn" class="popover-btn">
                                 <i class="fas fa-palette w-4"></i> <span data-translate="create-image">Görsel Oluştur</span>
                             </button>
                             <button id="popover-voice-btn" class="popover-btn">
                                 <i class="fas fa-headset w-4"></i> <span data-translate="voice-chat">Sesli Konuşma</span>
                             </button>
                        </div>
                    </div>
                    <input type="file" id="file-input" accept="image/*" class="hidden" multiple>

                    <div id="image-prompt-tag" class="hidden">
                        <span data-translate="image-prompt-tag">Görsel oluştur:</span>
                        <button id="cancel-image-prompt">&times;</button>
                    </div>

                    <textarea id="chat-input" placeholder="N0thingAI'a bir mesaj gönder..." rows="1" data-translate-placeholder="send-message-placeholder"></textarea>
                    
                    <button class="icon-btn" id="speech-to-text-btn" title="Sesli Yazma" data-translate-title="speech-to-text">
                        <i class="fas fa-microphone"></i>
                    </button>

                    <button class="send-btn icon-btn" title="Gönder" data-translate-title="send">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Ayarlar ve Giriş Modalı -->
    <div id="settings-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-md modal-content relative">
            
            <div id="modal-login-view" class="">
                <h2 class="text-xl font-bold mb-4 text-center" data-translate="login">Giriş Yap</h2>
                <p class="text-center text-sm opacity-80 mb-4" style="color: var(--text-secondary);" data-translate="login-desc">Ayarlarınıza erişmek için giriş yapın.</p>
                
                <p id="auth-error-message" class="text-center text-sm text-red-500 mb-4 hidden"></p>

                <div class="space-y-4">
                    <input id="email-input" type="email" placeholder="Email adresiniz" class="w-full p-3 rounded-lg border" data-translate-placeholder="email-placeholder">
                    <!-- YENİ: Şifre Görünürlüğü Eklendi -->
                    <div class="password-wrapper">
                        <input id="password-input" type="password" placeholder="Şifreniz" class="w-full p-3 rounded-lg border" data-translate-placeholder="password-placeholder">
                        <button class="password-toggle-btn" type="button" aria-label="Toggle password visibility">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>
                    
                    <div class="text-right">
                        <button id="show-reset-btn" class="text-xs font-medium hover:underline" style="color: var(--text-secondary);" data-translate="forgot-password">Şifrenizi mi unuttunuz?</button>
                    </div>
                    
                    <button id="email-signin-btn" class="w-full py-3 login-btn rounded-xl font-semibold" style="background-color: var(--highlight-color); color: var(--sidebar-bg);" data-translate="login-email">
                        Email ile Giriş Yap
                    </button>

                    <!-- YENİ: Google ile Devam Et Butonu -->
                    <button id="google-signin-btn" class="w-full py-3 login-btn rounded-xl font-semibold flex items-center justify-center" style="background-color: var(--highlight-color); color: var(--sidebar-bg);">
                        <i class="fab fa-google mr-2"></i> Google ile Devam Et
                    </button>

                    <p class="text-xs text-center" style="color: var(--text-secondary);">
                        <span data-translate="no-account">Hesabınız yok mu?</span>
                        <button id="show-signup-btn" class="font-bold underline hover:opacity-100" style="color: var(--text-primary);" data-translate="create-account-link">Yeni Hesap Oluşturun</button>
                    </p>
                </div>
            </div>

            <div id="modal-signup-view" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center" data-translate="create-account">Yeni Hesap Oluştur</h2>
                <p id="signup-error-message" class="text-center text-sm text-red-500 mb-4 hidden"></p>

                <!-- YENİ: Kullanıcı Adı Eklendi -->
                <input id="signup-username-input" type="text" placeholder="Kullanıcı Adı" class="w-full p-3 rounded-lg border mb-4" data-translate-placeholder="username-placeholder">
                <input id="signup-email-input" type="email" placeholder="Email adresiniz" class="w-full p-3 rounded-lg border mb-4" data-translate-placeholder="email-placeholder">
                <!-- YENİ: Şifre Görünürlüğü Eklendi -->
                <div class="password-wrapper">
                    <input id="signup-password-input" type="password" placeholder="Yeni şifreniz" class="w-full p-3 rounded-lg border mb-4" data-translate-placeholder="new-password-placeholder">
                    <button class="password-toggle-btn" type="button" aria-label="Toggle password visibility">
                        <i class="fas fa-eye"></i>
                    </button>
                </div>
                <button id="signup-btn" class="w-full py-3 login-btn rounded-xl font-semibold" style="background-color: var(--highlight-color); color: var(--sidebar-bg);" data-translate="signup-btn">
                    Kayıt Ol (Sign Up)
                </button>

                <!-- YENİ: Google ile Devam Et Butonu (Kayıt için de) -->
                <button id="google-signup-btn" class="w-full py-3 login-btn rounded-xl font-semibold flex items-center justify-center mt-4" style="background-color: var(--highlight-color); color: var(--sidebar-bg);">
                    <i class="fab fa-google mr-2"></i> Google ile Devam Et
                </button>

                <p class="text-xs text-center mt-4" style="color: var(--text-secondary);">
                    <span data-translate="have-account">Zaten bir hesabınız var mı?</span>
                    <button id="show-signin-btn" class="font-bold underline hover:opacity-100" style="color: var(--text-primary);" data-translate="login-link">Giriş Yapın</button>
                </p>
            </div>

            <div id="modal-reset-view" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center" data-translate="reset-password">Şifremi Sıfırla</h2>
                <p class="text-center text-sm opacity-80 mb-4" style="color: var(--text-secondary);" data-translate="reset-desc">Sıfırlama linki göndermek için e-postanızı girin.</p>
                
                <p id="reset-message" class="text-center text-sm text-red-500 mb-4 hidden"></p>

                <div class="space-y-4">
                    <input id="reset-email-input" type="email" placeholder="Email adresiniz" class="w-full p-3 rounded-lg border" data-translate-placeholder="email-placeholder">
                    
                    <button id="reset-btn" class="w-full py-3 login-btn rounded-xl font-semibold" style="background-color: var(--highlight-color); color: var(--sidebar-bg);" data-translate="send-reset-link">
                        Sıfırlama Linki Gönder
                    </button>
                    <p class="text-xs text-center" style="color: var(--text-secondary);">
                        <button id="show-signin-btn-from-reset" class="font-bold underline hover:opacity-100" style="color: var(--text-primary);" data-translate="back-to-login">Giriş Yap'a Geri Dön</button>
                    </p>
                </div>
            </div>


            <div id="modal-settings-view" class="hidden">
                 <h2 class="text-xl font-bold mb-6" id="modal-title-settings" data-translate="settings">Ayarlar</h2>
                 
                 <div class="mb-4">
                      <label for="language-selector" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);" data-translate="language-select">Dil Seçimi</label>
                      <select id="language-selector" class="w-full p-3 rounded-lg border">
                          <option value="tr">Türkçe</option> 
                          <option value="en">English</option>
                      </select>
                 </div>
                 
                 <div class="mb-4">
                      <label for="theme-selector" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);" data-translate="theme-select">Tema Seçimi</label>
                      <select id="theme-selector" class="w-full p-3 rounded-lg border">
                          <option value="dark-mode" data-translate="dark-theme">Koyu Tema (Gri/Beyaz)</option> 
                          <option value="light-mode" data-translate="light-theme">Açık Tema (Beyaz/Gri)</option>
                      </select>
                 </div>

                 <!-- YENİ: Ses Seçimi Eklendi -->
                 <div class="mb-4">
                    <label for="voice-selector" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);" data-translate="voice-select">Ses Seçimi (TTS)</label>
                    <div class="flex items-center gap-2">
                        <select id="voice-selector" class="w-full p-3 rounded-lg border">
                            <option value="Puck">Erkek (Canlı)</option>
                            <option value="Kore">Kadın (Resmi)</option>
                            <option value="Zephyr">Kadın (Parlak)</option>
                            <option value="Charon">Erkek (Bilgilendirici)</option>
                            <option value="Leda">Kadın (Genç)</option>
                        </select>
                        <button id="sample-voice-btn" class="p-3 rounded-lg border" style="border-color: var(--btn-border);"><i class="fas fa-play"></i></button>
                    </div>
                 </div>

                 <button id="signout-btn" class="w-full p-3 mt-4 rounded-lg font-semibold border" style="border-color: var(--btn-border); transition: background-color 0.2s;">
                    <i class="fas fa-sign-out-alt mr-2"></i> <span data-translate="logout">Çıkış Yap</span>
                 </button>
            </div>
            
            <button onclick="window.closeSettingsModal()" class="absolute top-4 right-4 text-xl opacity-70 hover:opacity-100" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- PREMIUM MODALI -->
    <div id="premium-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-2xl modal-content relative">
            <h2 class="text-xl font-bold mb-4 text-center" data-translate="plans-title">
                <i class="fas fa-star-half-alt mr-2" style="color: var(--highlight-color);"></i>
                N0thingAI Planları
            </h2>
            <p class="text-center text-sm opacity-80 mb-6" style="color: var(--text-secondary);" data-translate="plans-desc">
                Limitlerinizi yükseltin ve N0thingAI'ı tam potansiyelinde kullanın.
            </p>
            
            <table class="w-full text-sm text-left mb-6">
                <thead style="background-color: var(--input-bg);">
                    <tr>
                        <th class="p-3 rounded-tl-lg" data-translate="feature">Özellik</th>
                        <th class="p-3 text-center" data-translate="normal">Normal</th>
                        <th class="p-3 text-center">Plus (25 TL/Ay)</th>
                        <th class="p-3 text-center">Premium (35 TL/Ay)</th>
                    </tr>
                </thead>
                <tbody style="color: var(--text-secondary);">
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold" data-translate="daily-token">Günlük Token</td>
                        <td class="p-3 text-center">150 Token</td>
                        <td class="p-3 text-center">500 Token</td>
                        <td class="p-3 text-center rounded-tr-lg">1000 Token</td>
                    </tr>
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold" data-translate="message-cost">Mesaj (10 Token)</td>
                        <td class="p-3 text-center">(~15 <span data-translate="messages">Mesaj</span>)</td>
                        <td class="p-3 text-center">(~50 <span data-translate="messages">Mesaj</span>)</td>
                        <td class="p-3 text-center">(~100 <span data-translate="messages">Mesaj</span>)</td>
                    </tr>
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold" data-translate="image-cost">Görsel (20 Token)</td>
                        <td class="p-3 text-center">(~7 <span data-translate="images">Görsel</span>)</td>
                        <td class="p-3 text-center">(~25 <span data-translate="images">Görsel</span>)</td>
                        <td class="p-3 text-center">(~50 <span data-translate="images">Görsel</span>)</td>
                    </tr>
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold" data-translate="file-cost">Dosya (15 Token)</td>
                        <td class="p-3 text-center">(~10 <span data-translate="files">Dosya</span>)</td>
                        <td class="p-3 text-center">(~33 <span data-translate="files">Dosya</span>)</td>
                        <td class="p-3 text-center">(~66 <span data-translate="files">Dosya</span>)</td>
                    </tr>
                </tbody>
            </table>

            <p class="text-xs text-center mt-4" style="color: var(--text-secondary);">
                <span data-translate="upgrade-contact">Üyeliğinizi yükseltmek için:</span>
                <a href="mailto:n0thingaiofficial@gmail.com" class="font-bold underline" style="color: var(--highlight-color);">n0thingaiofficial@gmail.com</a>
            </p>
            
            <button onclick="window.closePremiumModal()" class="absolute top-4 right-4 text-xl opacity-70 hover:opacity-100" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- GÖRSEL DÜZENLEYİCİ MODALI -->
    <div id="image-editor-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-4 rounded-xl shadow-2xl w-full max-w-lg modal-content relative">
             <h2 class="text-lg font-bold mb-4" data-translate="confirm-image">Görseli Onayla</h2>
             <div id="editor-container" class="relative w-full h-96 overflow-auto mb-4 border border-gray-700 rounded-lg flex items-center justify-center" style="background-color: var(--input-bg);">
                 <img id="editor-image-preview" src="" class="max-w-full max-h-full">
             </div>
             <p class="text-xs text-center mb-4" style="color: var(--text-secondary);" data-translate="editing-soon">
                 (Görsel düzenleme araçları yakında eklenecektir)
             </p>
             <div class="flex justify-end gap-4">
                 <button id="cancel-image-edit" class="py-2 px-4 rounded-lg font-semibold border" style="border-color: var(--btn-border);" data-translate="cancel">İptal</button>
                 <button id="confirm-image-edit" class="py-2 px-4 rounded-lg font-semibold" style="background-color: var(--highlight-color); color: var(--sidebar-bg);" data-translate="add-image">Görseli Ekle</button>
             </div>
        </div>
    </div>

    <!-- Sohbet Geçmişi İçerik Menüsü (Popover) -->
    <div id="chat-context-menu" class="hidden absolute z-50 w-48 rounded-lg shadow-xl" style="background-color: var(--modal-bg); border: 1px solid var(--input-border);">
        <button id="rename-chat-btn" class="context-menu-item w-full text-left px-4 py-2 text-sm" data-translate="rename">
            <i class="fas fa-pencil-alt w-4 mr-2"></i> Yeniden Adlandır
        </button>
        <button id="delete-chat-btn" class="context-menu-item w-full text-left px-4 py-2 text-sm text-red-500" data-translate="delete-chat">
            <i class="fas fa-trash-alt w-4 mr-2"></i> Sohbeti Sil
        </button>
    </div>

    <!-- Sohbet Silme Onay Modalı -->
    <div id="delete-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-sm modal-content relative">
            <h2 class="text-lg font-bold mb-4" data-translate="delete-chat">Sohbeti Sil</h2>
            <p class="text-sm mb-6" style="color: var(--text-secondary);" data-translate="delete-confirm-msg">
                Bu sohbeti kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.
            </p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="py-2 px-4 rounded-lg font-semibold border" style="border-color: var(--btn-border);" data-translate="cancel">İptal</button>
                <button id="confirm-delete-btn" class="py-2 px-4 rounded-lg font-semibold bg-red-600 text-white" data-translate="delete">Sil</button>
            </div>
        </div>
    </div>

    <!-- E-POSTA DOĞRULAMA MODALI -->
    <div id="email-verify-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay" style="z-index: 100;">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-md modal-content relative text-center">
            <i class="fas fa-envelope-open-text text-4xl mb-4" style="color: var(--highlight-color);"></i>
            <h2 class="text-xl font-bold mb-4" data-translate="verify-email-title">Lütfen E-postanızı Doğrulayın</h2>
            <p class="text-sm mb-6" style="color: var(--text-secondary);" data-translate="verify-email-desc">
                Kayıt olduğunuz e-posta adresine bir doğrulama linki gönderdik. 
                Lütfen linke tıkladıktan sonra "Kontrol Et" butonuna basın. (Gözükmezse **spam kutunuzu** kontrol etmeyi unutmayın)
            </p>
            <div class="space-y-3">
                <button id="check-verify-btn" class="w-full verify-btn" data-translate="verify-email-check">
                    Doğruladım, Kontrol Et
                </button>
                <button id="resend-verify-btn" class="w-full py-2 px-4 rounded-lg font-semibold border" style="border-color: var(--btn-border);" data-translate="verify-email-resend">
                    E-postayı Tekrar Gönder
                </button>
                <button id="signout-from-verify-btn" class="w-full py-2 px-4 text-xs" style="color: var(--text-secondary);" data-translate="logout">
                    Çıkış Yap
                </button>
            </div>
        </div>
    </div>

    <!-- YENİ: Ses Oynatıcı -->
    <audio id="tts-audio-player" class="hidden"></audio>
    <!-- YENİ: Örnek Ses Oynatıcı (Ayarlar için) -->
    <audio id="sample-audio-player" class="hidden"></audio>

    <!-- YENİ: Sesli Konuşma Baloncuğu -->
    <div id="voice-chat-bubble" class="hidden">
        <button id="voice-chat-bubble-btn" class="icon-btn">
            <i class="fas fa-microphone"></i>
        </button>
        <span id="voice-chat-status" class="text-sm" data-translate="tap-to-speak">Konuşmak için dokun</span>
        <button id="voice-chat-close-btn" class="icon-btn">
            <i class="fas fa-times"></i>
        </button>
    </div>

    
    <script type="module">
        // Firebase ve Google API Entegrasyonu
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, 
            onAuthStateChanged, signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            setPersistence, browserLocalPersistence,
            sendEmailVerification,
            sendPasswordResetEmail,
            GoogleAuthProvider, // YENİ
            signInWithPopup // YENİ
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, addDoc, collection, onSnapshot, 
            query, orderBy, serverTimestamp, getDoc,
            Timestamp, updateDoc, getDocs,
            deleteDoc,
            runTransaction, 
            writeBatch,
            limit // YENİ: Silme işlemi için eklendi
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // API Keys ve Modeller
        const GEMINI_API_KEY = "AIzaSyCx4u1qHGlysIGpm1Zw0YBfXlqEXJ1BlvM"; 
        const CHAT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const IMAGE_GEN_MODEL = "https://image.pollinations.ai/prompt/";
        
       // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
  apiKey: "AIzaSyCXwaj4fnXkeWTxdXgP61cJl2MamPkLVRE",
  authDomain: "n0thingai-fbb72.firebaseapp.com",
  projectId: "n0thingai-fbb72",
  storageBucket: "n0thingai-fbb72.firebasestorage.app",
  messagingSenderId: "492314217752",
  appId: "1:492314217752:web:7f1be6fa29dacad0d5a26d",
  measurementId: "G-L9W75KHVTH"
};
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase başarıyla başlatıldı.");
        } catch (e) {
            console.error("Firebase başlatılamadı:", e);
            renderSystemMessage("**HATA:** Kimlik doğrulama servisi yüklenemedi.", "error");
        }
        
        // --- DOM Elements ---
        const MESSAGES_CONTAINER = document.getElementById('messages-container');
        const CHAT_INPUT = document.getElementById('chat-input');
        const SEND_BTN = document.getElementById('send-btn');
        const NEW_CHAT_BTN = document.getElementById('new-chat-btn');
        const CURRENT_MODE_DISPLAY = document.getElementById('current-mode-display');
        const TYPING_INDICATOR = document.getElementById('typing-indicator');
        const LOADING_TEXT = document.getElementById('loading-text');
        
        const CHAT_HISTORY_LIST = document.getElementById('chat-history-list');
        const CHAT_SEARCH_INPUT = document.getElementById('chat-search-input');

        const INPUT_AREA = document.getElementById('input-area');
        const INPUT_PLUS_BTN = document.getElementById('input-plus-btn');
        const INPUT_POPOVER_MENU = document.getElementById('input-popover-menu');
        const POPOVER_UPLOAD_BTN = document.getElementById('popover-upload-btn');
        const POPOVER_IMAGE_BTN = document.getElementById('popover-image-btn');
        const POPOVER_VOICE_BTN = document.getElementById('popover-voice-btn');
        const IMAGE_PROMPT_TAG = document.getElementById('image-prompt-tag');
        const CANCEL_IMAGE_PROMPT_BTN = document.getElementById('cancel-image-prompt');

        const FILE_INPUT = document.getElementById('file-input');
        const ATTACHMENT_PREVIEW = document.getElementById('attachment-preview');
        const PREVIEW_IMAGE = document.getElementById('preview-image');
        const REMOVE_ATTACHMENT_BTN = document.getElementById('remove-attachment-btn');
        
        const AUTH_CONTAINER = document.getElementById('auth-container');
        const USER_PROFILE_VIEW = document.getElementById('user-profile-view');
        const PROFILE_PIC = document.getElementById('profile-pic');
        const USER_NAME = document.getElementById('user-name');
        const LOGIN_VIEW = document.getElementById('login-view'); 
        
        const SETTINGS_MODAL = document.getElementById('settings-modal');
        const MODAL_LOGIN_VIEW = document.getElementById('modal-login-view');
        const MODAL_SIGNUP_VIEW = document.getElementById('modal-signup-view');
        const MODAL_SETTINGS_VIEW = document.getElementById('modal-settings-view');
        const MODAL_RESET_VIEW = document.getElementById('modal-reset-view');
        const LANGUAGE_SELECTOR = document.getElementById('language-selector');
        const THEME_SELECTOR = document.getElementById('theme-selector');
        const VOICE_SELECTOR = document.getElementById('voice-selector');
        const SAMPLE_VOICE_BTN = document.getElementById('sample-voice-btn');
        const SAMPLE_AUDIO_PLAYER = document.getElementById('sample-audio-player');
        
        const PREMIUM_MODAL = document.getElementById('premium-modal');
        const PLUS_BTN = document.getElementById('plus-btn');

        const AUTH_ERROR_MESSAGE = document.getElementById('auth-error-message');
        const SIGNUP_ERROR_MESSAGE = document.getElementById('signup-error-message');
        const RESET_MESSAGE = document.getElementById('reset-message');

        const EMAIL_INPUT = document.getElementById('email-input');
        const PASSWORD_INPUT = document.getElementById('password-input');
        const EMAIL_SIGNIN_BTN = document.getElementById('email-signin-btn');
        const SIGNUP_USERNAME_INPUT = document.getElementById('signup-username-input'); // YENİ
        const SIGNUP_EMAIL_INPUT = document.getElementById('signup-email-input');
        const SIGNUP_PASSWORD_INPUT = document.getElementById('signup-password-input');
        const SIGNUP_BTN = document.getElementById('signup-btn');
        const SIGNOUT_BTN = document.getElementById('signout-btn');
        const SHOW_SIGNUP_BTN = document.getElementById('show-signup-btn');
        const SHOW_SIGNIN_BTN = document.getElementById('show-signin-btn');
        const SHOW_RESET_BTN = document.getElementById('show-reset-btn');
        const SHOW_SIGNIN_BTN_FROM_RESET = document.getElementById('show-signin-btn-from-reset');
        const RESET_EMAIL_INPUT = document.getElementById('reset-email-input');
        const RESET_BTN = document.getElementById('reset-btn');

        const SIDEBAR = document.getElementById('sidebar');
        const TOGGLE_SIDEBAR_BTN = document.getElementById('toggle-sidebar-btn');
        const CHAT_AREA = document.querySelector('.chat-area');
        const OPEN_SIDEBAR_BTN = document.getElementById('open-sidebar-btn');
        const MOBILE_OVERLAY = document.getElementById('mobile-overlay');
        
        const SCROLL_TO_BOTTOM_BTN = document.getElementById('scroll-to-bottom-btn');
        
        const SPEECH_TO_TEXT_BTN = document.getElementById('speech-to-text-btn');
        let recognition;
        
        const IMAGE_EDITOR_MODAL = document.getElementById('image-editor-modal');
        const EDITOR_IMAGE_PREVIEW = document.getElementById('editor-image-preview');
        const CANCEL_IMAGE_EDIT_BTN = document.getElementById('cancel-image-edit');
        const CONFIRM_IMAGE_EDIT_BTN = document.getElementById('confirm-image-edit');
        let tempImageBlob = null;
        
        const TOKEN_DISPLAY = document.getElementById('token-display');
        const TOKEN_COUNT = document.getElementById('token-count');

        const CHAT_CONTEXT_MENU = document.getElementById('chat-context-menu');
        const RENAME_CHAT_BTN = document.getElementById('rename-chat-btn');
        const DELETE_CHAT_BTN = document.getElementById('delete-chat-btn');
        const DELETE_CONFIRM_MODAL = document.getElementById('delete-confirm-modal');
        const CANCEL_DELETE_BTN = document.getElementById('cancel-delete-btn');
        const CONFIRM_DELETE_BTN = document.getElementById('confirm-delete-btn');
        const EMAIL_VERIFY_MODAL = document.getElementById('email-verify-modal');
        const TEMP_CHAT_BUTTONS = document.querySelectorAll('.temp-chat-trigger');

        const TTS_AUDIO_PLAYER = document.getElementById('tts-audio-player');
        const VOICE_CHAT_BUBBLE = document.getElementById('voice-chat-bubble');
        const VOICE_CHAT_BUBBLE_BTN = document.getElementById('voice-chat-bubble-btn');
        const VOICE_CHAT_STATUS = document.getElementById('voice-chat-status');
        const VOICE_CHAT_CLOSE_BTN = document.getElementById('voice-chat-close-btn');

        // --- KOTA LİMİTLERİ (TOKEN) ---
        const QUOTAS = {
            anonymous: { tokens: 50 },
            normal: { tokens: 150 },
            plus: { tokens: 500 },
            premium: { tokens: 1000 },
            admin: { tokens: Infinity }
        };
        const COSTS = {
            message: 10,
            image: 20,
            file: 15
        };

        // --- Global State ---
        let isWaitingForResponse = false;
        let attachedImageBase64 = null;
        
        let currentUserId = null;
        let currentChatId = null;
        let unsubscribeChat = null;
        let unsubscribeHistory = null;
        
        let currentUserRole = 'anonymous';
        let dailyUsage = { tokens: 0 }; 

        let contextMenuChatId = null;
        let isTemporaryChat = false;
        let isVoiceChatActive = false;
        let currentLang = 'tr'; // YENİ: Dil durumu

        // --- YENİ: ÇEVİRİ SİSTEMİ ---
        const translations = {
            'tr': {
                'search-chats': 'Sohbetleri ara...',
                'new-chat': 'Yeni Sohbet',
                'temp-chat-title': 'Geçici Sohbet Başlat (Kaydedilmez)',
                'temp-chat-active': 'Geçici Sohbet (Kaydedilmiyor)',
                'login-signup': 'Giriş Yap / Kayıt Ol',
                'options': 'Seçenekler',
                'upload-file': 'Dosya / Fotoğraf Yükle',
                'create-image': 'Görsel Oluştur',
                'voice-chat': 'Sesli Konuşma',
                'image-prompt-tag': 'Görsel oluştur:',
                'send-message-placeholder': "N0thingAI'a bir mesaj gönder...",
                'speech-to-text': 'Sesli Yazma',
                'send': 'Gönder',
                'login': 'Giriş Yap',
                'login-desc': 'Ayarlarınıza erişmek için giriş yapın.',
                'email-placeholder': 'Email adresiniz',
                'password-placeholder': 'Şifreniz',
                'forgot-password': 'Şifrenizi mi unuttunuz?',
                'login-email': 'Email ile Giriş Yap',
                'no-account': 'Hesabınız yok mu?',
                'create-account-link': 'Yeni Hesap Oluşturun',
                'create-account': 'Yeni Hesap Oluştur',
                'username-placeholder': 'Kullanıcı Adı',
                'new-password-placeholder': 'Yeni şifreniz',
                'signup-btn': 'Kayıt Ol (Sign Up)',
                'have-account': 'Zaten bir hesabınız var mı?',
                'login-link': 'Giriş Yapın',
                'reset-password': 'Şifremi Sıfırla',
                'reset-desc': 'Sıfırlama linki göndermek için e-postanızı girin.',
                'send-reset-link': 'Sıfırlama Linki Gönder',
                'back-to-login': "Giriş Yap'a Geri Dön",
                'settings': 'Ayarlar',
                'language-select': 'Dil Seçimi',
                'theme-select': 'Tema Seçimi',
                'dark-theme': 'Koyu Tema (Gri/Beyaz)',
                'light-theme': 'Açık Tema (Beyaz/Gri)',
                'voice-select': 'Ses Seçimi (TTS)',
                'logout': 'Çıkış Yap',
                'plans-title': 'N0thingAI Planları',
                'plans-desc': 'Limitlerinizi yükseltin ve N0thingAI\'ı tam potansiyelinde kullanın.',
                'feature': 'Özellik',
                'normal': 'Normal',
                'daily-token': 'Günlük Token',
                'message-cost': 'Mesaj (10 Token)',
                'messages': 'Mesaj',
                'image-cost': 'Görsel (20 Token)',
                'images': 'Görsel',
                'file-cost': 'Dosya (15 Token)',
                'files': 'Dosya',
                'upgrade-contact': 'Üyeliğinizi yükseltmek için:',
                'confirm-image': 'Görseli Onayla',
                'editing-soon': '(Görsel düzenleme araçları yakında eklenecektir)',
                'cancel': 'İptal',
                'add-image': 'Görseli Ekle',
                'rename': 'Yeniden Adlandır',
                'delete-chat': 'Sohbeti Sil',
                'delete-confirm-msg': 'Bu sohbeti kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.',
                'delete': 'Sil',
                'verify-email-title': 'Lütfen E-postanızı Doğrulayın',
                'verify-email-desc': 'Kayıt olduğunuz e-posta adresine bir doğrulama linki gönderdik. Lütfen linke tıkladıktan sonra "Kontrol Et" butonuna basın. (Gözükmezse **spam kutunuzu** kontrol etmeyi unutmayın)',
                'verify-email-check': 'Doğruladım, Kontrol Et',
                'verify-email-resend': 'E-postayı Tekrar Gönder',
                'tap-to-speak': 'Konuşmak için dokun',
                // Sistem Mesajları
                'thinking': 'N0thingAI düşünüyor...',
                'image-optimizing': 'Görsel tanımı optimize ediliyor...',
                'image-creating': 'Görsel oluşturuluyor: "{prompt}"',
                'voice-chat-started': 'Sesli konuşma başlatıldı. Konuşmak için mikrofon simgesine dokunun.',
                'voice-chat-ended': 'Sesli konuşma sonlandırıldı.',
                'voice-speaking': 'Yapay zeka konuşuyor...',
                'voice-listening': 'Dinleniyor...',
                'voice-tap-to-speak': 'Konuşmak için dokun',
                // Hata Mesajları
                'error-auth-failed': 'Kimlik doğrulama hizmeti yüklenemedi.',
                'error-invalid-api-model': 'Hata: Geçersiz API modeli.',
                'error-api-fail': 'API Hatası ({status}): {message}',
                'error-unknown-api': 'Bilinmeyen Hata',
                'error-system-message': '**HATA:** {message}',
                'error-chat-load': '**HATA:** Sohbet yüklenemedi. {message}',
                'error-chat-save': '**HATA:** Mesajınız veritabanına kaydedilemedi. {message}',
                'error-prompt-translate': 'Prompt Çeviri/Optimizasyon Hatası:',
                'error-image-api': 'Görsel API Çağrısı Hatası:',
                'error-image-fail': 'Görsel oluşturma başarısız oldu. Lütfen daha açıklayıcı bir tanım deneyin.',
                'error-image-no-blob': "API'den görsel alınamadı, ancak hata da dönmedi. Lütfen tekrar deneyin.",
                'error-gemini-fail': 'API\'den geçerli bir yanıt alınamadı.',
                'error-gemini-generic': 'Gemini Hatası:',
                'error-token-limit-anonymous': 'Tek seferlik 50 token limitinize ulaştınız ({current}/{max}). Lütfen giriş yapın veya Plus\'a geçin.',
                'error-token-limit-user': 'Günlük token limitinize ulaştınız ({current}/{max}). Bu eylem {cost} token gerektiriyor. Lütfen yarın tekrar deneyin veya N0thingAI Plus\'a geçin.',
                'error-send-no-auth': 'Mesaj göndermek için lütfen giriş yapın.',
                'error-image-no-auth': 'Görsel oluşturmak için lütfen giriş yapın.',
                'error-no-email-verify': 'Mesaj göndermek için lütfen e-postanızı doğrulayın.',
                'error-upload-no-auth': 'Dosya yüklemek için lütfen giriş yapın.',
                'error-upload-no-verify': 'Dosya yüklemek için lütfen e-postanızı doğrulayın.',
                'error-upload-not-image': 'Hata: Yalnızca resim dosyaları yüklenebilir.',
                'error-upload-multi': "Şu anda sadece 1 görsel yüklenebilir. İlk görsel ('{filename}') seçildi.",
                'error-auth-unknown': 'Bilinmeyen bir hata oluştu.',
                'error-auth-wrong-password': 'Girdiğiniz e-posta veya şifre yanlış.',
                'error-auth-not-verified': 'Hesap kayıtlı ancak e-posta doğrulanmamış. Lütfen gelen kutunuzu (ve spam) kontrol edin.',
                'error-auth-email-in-use': 'Bu e-posta adresi zaten kayıtlı.',
                'error-auth-weak-password': 'Şifre en az 6 karakter olmalıdır.',
                'error-auth-invalid-email': 'Geçersiz e-posta adresi formatı.',
                'error-auth-no-method': "Giriş yöntemi (Email) Firebase'de etkin değil.",
                'error-auth-missing-fields': 'Email ve şifre alanları boş bırakılamaz.',
                'error-signup-missing-fields': 'Kullanıcı adı, email ve şifre alanları boş bırakılamaz.',
                'error-logout': 'Çıkış Hatası:',
                'error-history-load': 'Geçmiş listesi dinlenirken hata:',
                'error-auth-init-fail': 'Firebase Auth bulunamadı, giriş yapılamaz.',
                'error-auth-init-anon': 'Kimlik doğrulama hizmeti yüklenemedi. Lütfen giriş yapmayı denemeyin.',
                'error-stt-unsupported': 'Tarayıcınız ses tanımayı desteklemiyor.',
                'error-stt-not-allowed': 'Mikrofon izni vermediniz.',
                'error-stt-no-speech': 'Ses algılanmadı.',
                'error-stt-fail': 'Ses tanıma başlatılamadı:',
                'error-chat-rename': 'Başlık güncellenirken bir hata oluştu.',
                'error-chat-delete': 'Sohbet silinirken bir hata oluştu: {message}',
                'error-chat-delete-permission': 'HATA: Sohbeti silme izniniz yok. (Güvenlik Kuralı)',
                'error-password-reset-email': 'Lütfen e-posta adresinizi girin.',
                'error-password-reset-fail': 'Şifre Sıfırlama Hatası:',
                'error-email-resend-wait': 'Lütfen tekrar göndermeden önce bekleyin.',
                'error-email-resend-fail': 'E-posta tekrar gönderilemedi:',
                'error-email-resend-limit': 'Çok fazla istek gönderildi. Lütfen daha sonra tekrar deneyin.',
                'error-email-check-fail': 'E-posta hala doğrulanmamış görünüyor. Lütfen linke tıkladığınızdan emin olun.',
                'error-voice-chat-no-auth': 'Sesli konuşma için lütfen giriş yapın.',
                'error-voice-chat-no-verify': 'Sesli konuşma için lütfen e-postanızı doğrulayın.',
                'error-tts-play': 'Ses oynatma hatası:',
                'error-tts-no-data': 'API yanıtında ses verisi bulunamadı veya format yanlış.',
                'error-tts-no-rate': "MimeType'da sampleRate bulunamadı.",
                'error-tts-fail': 'Ses üretilemedi veya oynatılamadı.',
                // Başarı Mesajları
                'success-signup': '**Kayıt başarılı!** Lütfen e-postanıza gönderilen doğrulama linkine tıklayın. (Gözükmezse **spam kutunuzu** kontrol edin)',
                'success-signup-no-email': "**Kayıt başarılı, ancak doğrulama e-postası gönderilemedi.** Lütfen 'Ayarlar' bölümünden tekrar göndermeyi deneyin.",
                'success-logout': 'Başarıyla çıkış yaptınız.',
                'success-password-reset': 'Sıfırlama linki gönderildi. Gelen kutunuzu (ve spam) kontrol edin.',
                'success-email-resend': 'Doğrulama e-postası tekrar gönderildi.',
                'success-email-verified': 'E-posta doğrulandı! Sayfa yeniden yükleniyor...',
                'success-new-chat': 'Yeni Sohbet Başlatıldı. (Kalan Token: {remainingTokens})',
                'success-temp-chat': 'Geçici Sohbet Başlatıldı. Bu sohbet geçmişe kaydedilmeyecek. (Kalan Token: {remainingTokens})',
            }
        };
        translations['en'] = {
            'search-chats': 'Search chats...',
            'new-chat': 'New Chat',
            'temp-chat-title': 'Start Temporary Chat (Not Saved)',
            'temp-chat-active': 'Temporary Chat (Not Saved)',
            'login-signup': 'Login / Sign Up',
            'options': 'Options',
            'upload-file': 'Upload File / Photo',
            'create-image': 'Create Image',
            'voice-chat': 'Voice Chat',
            'image-prompt-tag': 'Create image:',
            'send-message-placeholder': 'Send a message to N0thingAI...',
            'speech-to-text': 'Speech-to-Text',
            'send': 'Send',
            'login': 'Login',
            'login-desc': 'Login to access your settings.',
            'email-placeholder': 'Your email address',
            'password-placeholder': 'Your password',
            'forgot-password': 'Forgot your password?',
            'login-email': 'Login with Email',
            'no-account': "Don't have an account?",
            'create-account-link': 'Create a new account',
            'create-account': 'Create New Account',
            'username-placeholder': 'Username',
            'new-password-placeholder': 'Your new password',
            'signup-btn': 'Sign Up',
            'have-account': 'Already have an account?',
            'login-link': 'Login',
            'reset-password': 'Reset Password',
            'reset-desc': 'Enter your email to send a reset link.',
            'send-reset-link': 'Send Reset Link',
            'back-to-login': 'Back to Login',
            'settings': 'Settings',
            'language-select': 'Language Selection',
            'theme-select': 'Theme Selection',
            'dark-theme': 'Dark Theme (Gray/White)',
            'light-theme': 'Light Theme (White/Gray)',
            'voice-select': 'Voice Selection (TTS)',
            'logout': 'Logout',
            'plans-title': 'N0thingAI Plans',
            'plans-desc': 'Upgrade your limits and use N0thingAI to its full potential.',
            'feature': 'Feature',
            'normal': 'Normal',
            'daily-token': 'Daily Token',
            'message-cost': 'Message (10 Tokens)',
            'messages': 'Messages',
            'image-cost': 'Image (20 Tokens)',
            'images': 'Images',
            'file-cost': 'File (15 Tokens)',
            'files': 'Files',
            'upgrade-contact': 'To upgrade your membership:',
            'confirm-image': 'Confirm Image',
            'editing-soon': '(Image editing tools will be added soon)',
            'cancel': 'Cancel',
            'add-image': 'Add Image',
            'rename': 'Rename',
            'delete-chat': 'Delete Chat',
            'delete-confirm-msg': 'Are you sure you want to permanently delete this chat? This action cannot be undone.',
            'delete': 'Delete',
            'verify-email-title': 'Please Verify Your Email',
            'verify-email-desc': 'We sent a verification link to your registered email address. Please click the link, then press "Check". (Don\'t forget to check your **spam folder**)',
            'verify-email-check': 'I\'ve Verified, Check Now',
            'verify-email-resend': 'Resend Email',
            'tap-to-speak': 'Tap to speak',
            // Sistem Mesajları
            'thinking': 'N0thingAI is thinking...',
            'image-optimizing': 'Optimizing image prompt...',
            'image-creating': 'Creating image: "{prompt}"',
            'voice-chat-started': 'Voice chat started. Tap the microphone icon to speak.',
            'voice-chat-ended': 'Voice chat ended.',
            'voice-speaking': 'AI is speaking...',
            'voice-listening': 'Listening...',
            'voice-tap-to-speak': 'Tap to speak',
            // Hata Mesajları
            'error-auth-failed': 'Authentication service could not be loaded.',
            'error-invalid-api-model': 'Error: Invalid API model.',
            'error-api-fail': 'API Error ({status}): {message}',
            'error-unknown-api': 'Unknown Error',
            'error-system-message': '**ERROR:** {message}',
            'error-chat-load': '**ERROR:** Could not load chat. {message}',
            'error-chat-save': '**ERROR:** Your message could not be saved to the database. {message}',
            'error-prompt-translate': 'Prompt Translation/Optimization Error:',
            'error-image-api': 'Image API Call Error:',
            'error-image-fail': 'Image generation failed. Please try a more descriptive prompt.',
            'error-image-no-blob': 'Received no image from API, but no error either. Please try again.',
            'error-gemini-fail': 'Could not get a valid response from the API.',
            'error-gemini-generic': 'Gemini Error:',
            'error-token-limit-anonymous': 'You have reached your one-time 50 token limit ({current}/{max}). Please log in or upgrade to Plus.',
            'error-token-limit-user': 'You have reached your daily token limit ({current}/{max}). This action requires {cost} tokens. Please try again tomorrow or upgrade to N0thingAI Plus.',
            'error-send-no-auth': 'Please log in to send a message.',
            'error-image-no-auth': 'Please log in to create images.',
            'error-no-email-verify': 'Please verify your email to send messages.',
            'error-upload-no-auth': 'Please log in to upload files.',
            'error-upload-no-verify': 'Please verify your email to upload files.',
            'error-upload-not-image': 'Error: Only image files can be uploaded.',
            'error-upload-multi': "Only 1 image can be uploaded at this time. The first image ('{filename}') was selected.",
            'error-auth-unknown': 'An unknown error occurred.',
            'error-auth-wrong-password': 'The email or password you entered is incorrect.',
            'error-auth-not-verified': 'Account is registered but email is not verified. Please check your inbox (and spam).',
            'error-auth-email-in-use': 'This email address is already registered.',
            'error-auth-weak-password': 'Password must be at least 6 characters.',
            'error-auth-invalid-email': 'Invalid email address format.',
            'error-auth-no-method': 'The (Email) sign-in method is not enabled in Firebase.',
            'error-auth-missing-fields': 'Email and password fields cannot be empty.',
            'error-signup-missing-fields': 'Username, email, and password fields cannot be empty.',
            'error-logout': 'Logout Error:',
            'error-history-load': 'Error listening to chat history:',
            'error-auth-init-fail': 'Firebase Auth not found, cannot log in.',
            'error-auth-init-anon': 'Could not load authentication service. Please do not attempt to log in.',
            'error-stt-unsupported': 'Your browser does not support speech recognition.',
            'error-stt-not-allowed': 'You did not grant microphone permission.',
            'error-stt-no-speech': 'No speech was detected.',
            'error-stt-fail': 'Could not start speech recognition:',
            'error-chat-rename': 'An error occurred while renaming the chat.',
            'error-chat-delete': 'An error occurred while deleting the chat: {message}',
            'error-chat-delete-permission': 'ERROR: You do not have permission to delete this chat. (Security Rule)',
            'error-password-reset-email': 'Please enter your email address.',
            'error-password-reset-fail': 'Password Reset Error:',
            'error-email-resend-wait': 'Please wait before resending.',
            'error-email-resend-fail': 'Could not resend email:',
            'error-email-resend-limit': 'Too many requests sent. Please try again later.',
            'error-email-check-fail': 'Email still appears unverified. Please make sure you clicked the link.',
            'error-voice-chat-no-auth': 'Please log in for voice chat.',
            'error-voice-chat-no-verify': 'Please verify your email for voice chat.',
            'error-tts-play': 'Audio playback error:',
            'error-tts-no-data': 'No audio data found in API response or format is incorrect.',
            'error-tts-no-rate': 'Could not find sampleRate in mimeType.',
            'error-tts-fail': 'Could not generate or play audio.',
            // Başarı Mesajları
            'success-signup': '**Registration successful!** Please click the verification link sent to your email. (Don\'t forget to check your **spam folder**)',
            'success-signup-no-email': '**Registration successful, but verification email could not be sent.** Please try resending from the \'Settings\' menu.',
            'success-logout': 'Successfully logged out.',
            'success-password-reset': 'Reset link sent. Check your inbox (and spam).',
            'success-email-resend': 'Verification email sent again.',
            'success-email-verified': 'Email verified! Reloading page...',
            'success-new-chat': 'New Chat Started. (Remaining Tokens: {remainingTokens})',
            'success-temp-chat': 'Temporary Chat Started. This chat will not be saved. (Remaining Tokens: {remainingTokens})',
        };

        function getTranslation(key, params = {}) {
            const lang = currentLang || 'tr';
            let text = translations[lang][key] || translations['tr'][key] || `[${key}]`; // Fallback to 'tr' then key
            
            // Parametreleri değiştir
            for (const param in params) {
                text = text.replace(`{${param}}`, params[param]);
            }
            return text;
        }

        function applyLanguage(lang) {
            if (lang !== 'tr' && lang !== 'en') {
                lang = 'tr';
            }
            currentLang = lang;
            localStorage.setItem('n0thingai_lang', lang);
            
            // Tüm data-translate elementlerini güncelle
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.dataset.translate;
                el.textContent = getTranslation(key);
            });
            
            // Tüm data-translate-placeholder elementlerini güncelle
            document.querySelectorAll('[data-translate-placeholder]').forEach(el => {
                const key = el.dataset.translatePlaceholder;
                el.placeholder = getTranslation(key);
            });

            // Tüm data-translate-title elementlerini güncelle
            document.querySelectorAll('[data-translate-title]').forEach(el => {
                const key = el.dataset.translateTitle;
                el.title = getTranslation(key);
            });
            
            // Özel durumlar (e.g. recognition lang)
            if (recognition) {
                recognition.lang = (lang === 'en') ? 'en-US' : 'tr-TR';
            }
        }
        // --- ÇEVİRİ SİSTEMİ SONU ---

        /**
         * API Çağrısını Üstlenir (HİBRİT: Gemini ve Pollinations)
         */
        async function fetchWithRetry(model, payload, apiKey, isTitleGeneration = false) {
            let url = '';
            let headers = { 'Content-Type': 'application/json' };
            let responseType = 'json'; 
            
            let fetchOptions = {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            };

            if (model === 'gemini') {
                url = `https://generativelanguage.googleapis.com/v1beta/models/${CHAT_MODEL}:generateContent?key=${apiKey}`;
            } else if (model === 'pollinations') {
                const prompt = encodeURIComponent(payload.inputs); 
                url = `${IMAGE_GEN_MODEL}${prompt}`;
                responseType = 'blob';
                fetchOptions = { method: 'GET' };
                headers = {};
            } else {
                renderSystemMessage(getTranslation('error-invalid-api-model'), "error");
                return null;
            }

            const MAX_RETRIES = isTitleGeneration ? 1 : 3;
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(url, fetchOptions);

                    if (!response.ok) {
                        if (responseType === 'blob') {
                            const errorText = await response.text();
                            throw new Error(getTranslation('error-api-fail', {status: response.status, message: errorText}));
                        }
                        const errorData = await response.json();
                        throw new Error(getTranslation('error-api-fail', {status: response.status, message: errorData.error?.message || getTranslation('error-unknown-api')}));
                    }
                    
                    if (responseType === 'json') {
                        return await response.json();
                    } else if (responseType === 'blob') {
                        return await response.blob();
                    }

                } catch (error) {
                    attempt++;
                    console.error(`API Denemesi ${attempt} başarısız:`, error);
                    if (attempt >= MAX_RETRIES) {
                        if (!isTitleGeneration) {
                            renderSystemMessage(getTranslation('error-system-message', {message: error.message}), "error");
                        }
                        return null;
                    }
                }
            }
            return null;
        }

        // --- UI Helper Functions ---

        function autoScroll() {
            if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.scrollTop = MESSAGES_CONTAINER.scrollHeight;
            if (SCROLL_TO_BOTTOM_BTN) SCROLL_TO_BOTTOM_BTN.style.display = 'none';
        }

        function showTypingIndicator(text = "") {
            isWaitingForResponse = true;
            if (!isVoiceChatActive) {
                toggleInput(true);
            }
            if(LOADING_TEXT) LOADING_TEXT.textContent = text || getTranslation('thinking');
            if(TYPING_INDICATOR) TYPING_INDICATOR.classList.add('visible');
            if(MESSAGES_CONTAINER) MESSAGES_CONTAINER.appendChild(TYPING_INDICATOR);
            autoScroll();
        }

        function hideTypingIndicator() {
            isWaitingForResponse = false;
            if (!isVoiceChatActive) {
                toggleInput(false);
            }
            if(TYPING_INDICATOR) TYPING_INDICATOR.classList.remove('visible');
        }

        function toggleInput(disabled) {
            if (CHAT_INPUT) CHAT_INPUT.disabled = disabled;
            if (SEND_BTN) SEND_BTN.disabled = disabled;
            if (INPUT_PLUS_BTN) INPUT_PLUS_BTN.disabled = disabled;
            if (SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.disabled = disabled;
            if (CANCEL_IMAGE_PROMPT_BTN) CANCEL_IMAGE_PROMPT_BTN.disabled = disabled;
            
            if (disabled) {
                if (CHAT_INPUT) CHAT_INPUT.placeholder = getTranslation('thinking');
            } else {
                if (IMAGE_PROMPT_TAG && IMAGE_PROMPT_TAG.classList.contains('hidden')) {
                    if (CHAT_INPUT) CHAT_INPUT.placeholder = getTranslation('send-message-placeholder');
                } else {
                    if (CHAT_INPUT) CHAT_INPUT.placeholder = getTranslation('image-prompt-tag');
                }
            }
        }

        function renderSystemMessage(text, type = "info") {
             const systemMessageHTML = `
                 <div class="message-row system-message-row">
                     <div class="message-content ${type === 'error' ? 'error' : ''}">
                         ${text}
                     </div>
                 </div>
               `;
             if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', systemMessageHTML);
             autoScroll();
        }

        function addMessageToUI(text, sender) {
             const messageClass = sender === 'user' ? 'user' : 'ai';
             const safeText = document.createTextNode(text).textContent;
             
             const messageHTML = `
                 <div class="chat-bubble ${messageClass}">
                     ${safeText.replace(/\n/g, '<br>')}
                 </div>
               `;
             if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', messageHTML);
        }
        
        function addImageToUI(imageUrl, altText) {
             const imageHTML = `
                 <div class="chat-bubble ai">
                     <p class="text-sm italic mb-2" style="color: var(--text-secondary);">${altText}</p>
                     <div class="image-container">
                         <img src="${imageUrl}" alt="${altText}" loading="lazy" />
                     </div>
                 </div>
               `;
             if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', imageHTML);
        }
        
        // --- Core Application Logic (Firestore Eklendi) ---

        async function startNewChat(isTemporary = false) {
            if (isWaitingForResponse) return;
            stopVoiceChat(); 

            isTemporaryChat = isTemporary; 
            
            if (unsubscribeChat) unsubscribeChat();
            unsubscribeChat = null;
            currentChatId = null;
            
            if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.innerHTML = '';
            removeAttachment();
            cancelImagePrompt();
            
            const maxTokens = QUOTAS[currentUserRole]?.tokens || 0;
            const remainingTokens = maxTokens === Infinity ? "Sınırsız" : (maxTokens - (dailyUsage.tokens || 0));

            if (isTemporaryChat) {
                renderSystemMessage(getTranslation('success-temp-chat', {remainingTokens: remainingTokens}));
                if (CURRENT_MODE_DISPLAY) {
                    CURRENT_MODE_DISPLAY.textContent = getTranslation('temp-chat-active');
                    CURRENT_MODE_DISPLAY.style.display = 'block';
                }
            } else {
                renderSystemMessage(getTranslation('success-new-chat', {remainingTokens: remainingTokens}));
                if (CURRENT_MODE_DISPLAY) {
                    CURRENT_MODE_DISPLAY.textContent = "";
                    CURRENT_MODE_DISPLAY.style.display = 'none';
                }
            }
            
            document.querySelectorAll('#chat-history-list .chat-item.active').forEach(item => {
                item.classList.remove('active');
            });

            if (SIDEBAR && SIDEBAR.classList.contains('open')) {
                toggleSidebar(false);
            }
        }
        
        async function generateChatTitle(firstMessage) {
            if (isTemporaryChat || !db || !auth.currentUser || auth.currentUser.isAnonymous || !currentChatId) return;
            
            const userId = auth.currentUser.uid;
            const chatId = currentChatId;
            
            console.log("Sohbet başlığı oluşturuluyor...");
            
            const systemInstruction = "Kullanıcının ilk mesajına bakarak bu sohbet için 3-5 kelimelik kısa bir başlık oluştur. Sadece başlığı döndür, başka hiçbir şey yazma. Örnek: 'İtalyan Mutfağı Tarifleri'";
            const payload = {
                contents: [
                    { parts: [{ text: `Kullanıcının ilk mesajı: "${firstMessage}"` }] }
                ],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY, true);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    let title = text.trim().replace(/^['"]|['"]$/g, '');
                    title = title.substring(0, 30);
                    
                    const chatRef = doc(db, "users", userId, "chats", chatId);
                    await updateDoc(chatRef, {
                        title: title
                    });
                    console.log("Sohbet başlığı güncellendi:", title);
                }
            } catch (error) {
                console.error('Sohbet başlığı oluşturulamadı:', error);
            }
        }
        
        async function saveMessage(text, sender, imageUrl = null) {
            if (imageUrl) addImageToUI(imageUrl, text);
            else addMessageToUI(text, sender);

            if (currentUserRole === 'anonymous' || isTemporaryChat || !db || !auth.currentUser) {
                return;
            }

            const userId = auth.currentUser.uid;
            let chatToUse = currentChatId;
            let isFirstMessage = false;

            try {
                if (!chatToUse) {
                    isFirstMessage = true;
                    const chatRef = await addDoc(collection(db, "users", userId, "chats"), {
                        title: text.substring(0, 30) + "...",
                        createdAt: serverTimestamp()
                    });
                    chatToUse = chatRef.id;
                    currentChatId = chatToUse;
                    
                    listenToChat(userId, chatToUse); 
                }

                await addDoc(collection(db, "users", userId, "chats", chatToUse, "messages"), {
                    sender: sender,
                    text: text,
                    imageUrl: imageUrl || null,
                    createdAt: serverTimestamp()
                });
                
                if (isFirstMessage && sender === 'user') {
                    generateChatTitle(text); 
                }

            } catch (error) {
                console.error("Mesaj kaydedilemedi:", error);
                renderSystemMessage(getTranslation('error-chat-save', {message: error.message}), "error");
            }
        }
        
        // --- GÖRSEL OLUŞTURMA (Pollinations) ---
        
        async function translateAndOptimizePrompt(turkishPrompt) {
            showTypingIndicator(getTranslation('image-optimizing'));

            const cleanPrompt = turkishPrompt.toLowerCase().startsWith('oluştur:') 
                ? turkishPrompt.substring(8).trim() 
                : turkishPrompt;

            const systemInstruction = `You are a professional prompt engineer specializing in image generation (like Midjourney/DALL-E). Your task is to take the user's Turkish description and turn it into a single, detailed, highly descriptive English prompt, optimized for quality image output. 
            Do not add any conversational text, just the prompt.`;

            const payload = {
                contents: [{ parts: [{ text: `Translate and optimize this Turkish prompt for image generation: ${cleanPrompt}` }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY, true);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                     return text.trim().replace(/^['"]|['"]$/g, '');
                }
                return cleanPrompt;
            } catch (error) {
                console.error(getTranslation('error-prompt-translate'), error);
                return cleanPrompt; 
            }
        }
        
        async function generateImage(userPrompt, bypassOptimization = false, isFromVoice = false) {
            let optimizedPrompt;

            if (bypassOptimization) {
                console.log("Kullanıcı görsel modunda, optimizasyon atlanıyor.");
                optimizedPrompt = userPrompt.toLowerCase().startsWith('oluştur:') 
                    ? userPrompt.substring(8).trim() 
                    : userPrompt;
            } else {
                optimizedPrompt = await translateAndOptimizePrompt(userPrompt);
            }

            showTypingIndicator(getTranslation('image-creating', {prompt: optimizedPrompt.substring(0, 40)}));
            
            const payload = { 
                inputs: optimizedPrompt
            };

            let generatedBase64 = null;
            let aiMessage = getTranslation('error-image-fail');

            try {
                const imageBlob = await fetchWithRetry('pollinations', payload, null);
                
                if (imageBlob && imageBlob.size > 0) {
                    generatedBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageBlob);
                    });
                } else if (imageBlob) {
                    aiMessage = getTranslation('error-image-no-blob');
                    await saveMessage(aiMessage, 'ai');
                }

            } catch (error) {
                console.error(getTranslation('error-image-api'), error);
            } finally {
                if (!isFromVoice) {
                    hideTypingIndicator();
                }
                
                if (generatedBase64) {
                    await saveMessage(optimizedPrompt, 'ai', generatedBase64);
                }
            }
        }
        
        async function _getGeminiText(userPrompt) {
            let parts = [{ "text": userPrompt }];
            
            if (attachedImageBase64) {
                parts.unshift({
                    "inline_data": {
                        "mime_type": "image/jpeg",
                        "data": attachedImageBase64
                    }
                });
            }

            let history = [];
            if (currentUserId && currentChatId && !auth.currentUser.isAnonymous && !isTemporaryChat) {
                try {
                    const messagesRef = collection(db, "users", currentUserId, "chats", currentChatId, "messages");
                    const q = query(messagesRef, orderBy("createdAt", "desc"));
                    const historySnapshot = await getDocs(q);
                    
                    let tempHistory = [];
                    historySnapshot.forEach(doc => {
                        const msg = doc.data();
                        if (msg.text && !msg.imageUrl) {
                             tempHistory.push({
                                 role: msg.sender === 'user' ? 'user' : 'model',
                                 parts: [{ text: msg.text }]
                             });
                        }
                    });
                    history = tempHistory.reverse().slice(-10);
                } catch (e) {
                    console.error(getTranslation('error-history-load'), e);
                }
            }

            const payload = {
                "contents": [
                    ...history,
                    { "role": "user", "parts": parts }
                ],
            };

            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY);
                if (result && result.candidates && result.candidates[0].content) {
                    return result.candidates[0].content.parts[0].text;
                } else {
                    return getTranslation('error-gemini-fail');
                }
            } catch (error) {
                console.error(getTranslation('error-gemini-generic'), error);
                return `${getTranslation('error-gemini-generic')} ${error.message}`;
            }
        }

        // --- TTS Fonksiyonları ---
        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) {
                bytes[i] = binaryString.charCodeAt(i);
            }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const headerLength = 44;
            const dataLength = pcmData.length * 2;
            const buffer = new ArrayBuffer(headerLength + dataLength);
            const view = new DataView(buffer);
            function writeString(view, offset, string) {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            }
            writeString(view, 0, 'RIFF');
            view.setUint32(4, 36 + dataLength, true);
            writeString(view, 8, 'WAVE');
            writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(view, 36, 'data');
            view.setUint32(40, dataLength, true);
            let offset = headerLength;
            for (let i = 0; i < pcmData.length; i++, offset += 2) {
                view.setInt16(offset, pcmData[i], true);
            }
            return new Blob([view], { type: 'audio/wav' });
        }

        async function _fetchTTSAudio(text, voiceName, audioPlayerElement) {
            const shortText = (text.split('.')[0] + ".").substring(0, 150); // İlk cümle, max 150 karakter
            console.log(`TTS için gönderiliyor (${voiceName}): "${shortText}"`);
            
            const apiKey = GEMINI_API_KEY;
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
            
            const payload = {
                contents: [{ parts: [{ text: `Seslendir: ${shortText}` }] }],
                generationConfig: {
                    responseModalities: ["AUDIO"],
                    speechConfig: {
                        voiceConfig: {
                            prebuiltVoiceConfig: { voiceName: voiceName }
                        }
                    }
                },
                model: "gemini-2.5-flash-preview-tts"
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`TTS API Hatası (${response.status}): ${errorData.error?.message || 'Bilinmeyen Hata'}`);
                }
                const result = await response.json();
                const part = result?.candidates?.[0]?.content?.parts?.[0];
                const audioData = part?.inlineData?.data;
                const mimeType = part?.inlineData?.mimeType;

                if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
                    const sampleRateMatch = mimeType.match(/rate=(\d+)/);
                    if (!sampleRateMatch) throw new Error(getTranslation('error-tts-no-rate'));
                    
                    const sampleRate = parseInt(sampleRateMatch[1], 10);
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, sampleRate);
                    const audioUrl = URL.createObjectURL(wavBlob);

                    audioPlayerElement.src = audioUrl;
                    await audioPlayerElement.play();
                } else {
                    throw new Error(getTranslation('error-tts-no-data'));
                }
            } catch (e) {
                console.error(getTranslation('error-tts-play'), e);
                if (audioPlayerElement === TTS_AUDIO_PLAYER) {
                    hideTypingIndicator();
                    renderSystemMessage(getTranslation('error-system-message', {message: e.message}), "error");
                } else if (SAMPLE_VOICE_BTN) {
                    alert(getTranslation('error-tts-fail'));
                    SAMPLE_VOICE_BTN.disabled = false;
                    SAMPLE_VOICE_BTN.innerHTML = '<i class="fas fa-play"></i>';
                }
            }
        }

        // Ana TTS oynatıcı
        async function playTTS(text) {
            const voiceName = localStorage.getItem('n0thingai_voice') || 'Puck';
            showTypingIndicator(getTranslation('voice-speaking'));
            await _fetchTTSAudio(text, voiceName, TTS_AUDIO_PLAYER);
        }

        // Örnek TTS oynatıcı (Ayarlar)
        async function playSampleTTS() {
            if (!SAMPLE_VOICE_BTN || !VOICE_SELECTOR || !SAMPLE_AUDIO_PLAYER) return;
            const voiceName = VOICE_SELECTOR.value;
            const sampleText = (currentLang === 'en') ? "Hello, I am N0thingAI." : "Merhaba, ben N0thingAI.";
            
            SAMPLE_VOICE_BTN.disabled = true;
            SAMPLE_VOICE_BTN.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            
            SAMPLE_AUDIO_PLAYER.pause();
            SAMPLE_AUDIO_PLAYER.src = "";
            
            await _fetchTTSAudio(sampleText, voiceName, SAMPLE_AUDIO_PLAYER);
        }
        // --- TTS Fonksiyonları Sonu ---

        async function analyzeRequestType(userPrompt) {
            if (!userPrompt) return 'text';
            if (userPrompt.toLowerCase().startsWith('oluştur:')) return 'image';
            const keywords = ['çiz', 'oluştur', 'generate', 'draw', 'create a picture', 'görseli'];
            if (keywords.some(k => userPrompt.toLowerCase().includes(k))) return 'image';

            console.log("İstek tipi Gemini'ye soruluyor...");
            const systemInstruction = "Kullanıcının isteğini analiz et. Bu bir görsel oluşturma talebi mi? Sadece 'EVET' veya 'HAYIR' yanıtını ver.";
            const payload = {
                contents: [{ parts: [{ text: userPrompt }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };
            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY, true);
                const responseText = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                if (responseText && responseText.toUpperCase().includes('EVET')) return 'image';
            } catch (error) {
                console.error(getTranslation('error-prompt-translate'), error);
            }
            return 'text';
        }

        
        // --- GÜNLÜK KOTA KONTROLÜ (TOKEN) ---
        
        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        function updateTokenDisplay(used, total) {
            if (!TOKEN_COUNT || !TOKEN_DISPLAY) return;
            TOKEN_DISPLAY.style.display = 'flex';
            if (total === Infinity) {
                TOKEN_COUNT.textContent = `Sınırsız Token`;
            } else {
                TOKEN_COUNT.textContent = `${total - used} / ${total} Token`;
            }
        }

        async function checkUsageLimit(userId, actionCost) {
            if (!db || !userId) return false;
            const profileRef = doc(db, "users", userId, "chats", "--profile--");
            const profileDoc = await getDoc(profileRef);
            const role = currentUserRole; 
            const maxTokens = QUOTAS[role]?.tokens || 0;

            if (maxTokens === Infinity) {
                updateTokenDisplay(0, Infinity);
                return true;
            }

            let currentTokens = 0;
            const profileData = profileDoc.exists() ? profileDoc.data() : {};

            if (role === 'anonymous') {
                currentTokens = profileData.tokens || 0;
                if (currentTokens + actionCost > maxTokens) {
                    renderSystemMessage(getTranslation('error-token-limit-anonymous', {current: currentTokens, max: maxTokens}), "error");
                    window.openSettingsModal();
                    updateTokenDisplay(currentTokens, maxTokens);
                    return false;
                }
                const newTotalTokens = currentTokens + actionCost;
                await setDoc(profileRef, { ...profileData, tokens: newTotalTokens, role: 'anonymous' }, { merge: true });
                dailyUsage = { tokens: newTotalTokens };
                updateTokenDisplay(newTotalTokens, maxTokens);
                return true;
            } else {
                const todayStr = getTodayDateString();
                if (profileData.date === todayStr) {
                    currentTokens = profileData.tokens || 0;
                }
                if (currentTokens + actionCost > maxTokens) {
                    renderSystemMessage(getTranslation('error-token-limit-user', {current: currentTokens, max: maxTokens, cost: actionCost}), "error");
                    window.openPremiumModal();
                    updateTokenDisplay(currentTokens, maxTokens);
                    return false;
                }
                const newDailyTokens = currentTokens + actionCost;
                await setDoc(profileRef, { ...profileData, tokens: newDailyTokens, date: todayStr, role: role }, { merge: true });
                dailyUsage = { tokens: newDailyTokens };
                updateTokenDisplay(newDailyTokens, maxTokens);
                return true;
            }
        }

        async function sendMessage(text, isFromVoice = false) {
            if (isWaitingForResponse && !isFromVoice) return;

            const isImageMode = IMAGE_PROMPT_TAG && !IMAGE_PROMPT_TAG.classList.contains('hidden');
            
            if (!text) {
                text = CHAT_INPUT.value.trim();
            }
            
            if (isImageMode && !text.toLowerCase().startsWith('oluştur:')) {
                text = `Oluştur: ${text}`;
            }

            if (text === "" && !attachedImageBase64) return;
            
            if (!auth || !auth.currentUser) {
                renderSystemMessage(getTranslation('error-send-no-auth'), "error");
                window.openSettingsModal();
                return;
            }
            
            let requestType;
            if (isImageMode) {
                requestType = 'image';
            } else if (attachedImageBase64) {
                requestType = 'text';
            } else {
                requestType = await analyzeRequestType(text);
            }
            
            if (auth.currentUser.isAnonymous && requestType === 'image') {
                renderSystemMessage(getTranslation('error-image-no-auth'), "error");
                window.openSettingsModal();
                return;
            }
            
            if (!auth.currentUser.isAnonymous && !auth.currentUser.emailVerified) {
                renderSystemMessage(getTranslation('error-no-email-verify'), "error");
                if (EMAIL_VERIFY_MODAL) EMAIL_VERIFY_MODAL.classList.remove('hidden');
                return;
            }
            
            const userId = auth.currentUser.uid;
            let actionCost = (requestType === 'image') ? COSTS.image : COSTS.message;
            if (attachedImageBase64) actionCost = COSTS.file; 

            const allowed = await checkUsageLimit(userId, actionCost);
            if (!allowed) {
                return;
            }
            
            let messageToSave = text;
            if (attachedImageBase64 && text === "") {
                messageToSave = "(Görsel eklendi)";
            }
            if (messageToSave.toLowerCase().startsWith('oluştur:')) {
                messageToSave = messageToSave.substring(8).trim();
            }
            
            await saveMessage(messageToSave, 'user');

            if (!isFromVoice) {
                if (CHAT_INPUT) CHAT_INPUT.value = '';
                autoResizeTextarea();
            }
            
            if (isImageMode) {
                cancelImagePrompt();
            }

            showTypingIndicator(getTranslation('thinking'));

            if (requestType === 'image' && !attachedImageBase64) {
                await generateImage(text, isImageMode, isFromVoice);
                if (!isFromVoice) {
                    hideTypingIndicator();
                }
            } else {
                const aiText = await _getGeminiText(text);
                removeAttachment();
                await saveMessage(aiText, 'ai');

                if (isFromVoice) {
                    await playTTS(aiText);
                } else {
                    hideTypingIndicator();
                }
            }
        }


        function handleKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage("", false);
            }
        }
        
        // --- Attachment (Görsel Yükleme) Fonksiyonları ---

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            if (!auth || !auth.currentUser) {
                renderSystemMessage(getTranslation('error-upload-no-auth'), "error");
                window.openSettingsModal();
                return;
            }
            
            if (auth.currentUser.isAnonymous) {
                renderSystemMessage(getTranslation('error-upload-no-auth'), "error");
                window.openSettingsModal();
                return;
            } 

            if (!auth.currentUser.emailVerified) {
                renderSystemMessage(getTranslation('error-upload-no-verify'), "error");
                if (EMAIL_VERIFY_MODAL) EMAIL_VERIFY_MODAL.classList.remove('hidden');
                return;
            }

            const file = files[0];

            if (!file.type.startsWith('image/')) {
                renderSystemMessage(getTranslation('error-upload-not-image'), "error");
                return;
            }

            if (files.length === 1) {
                openImageEditor(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedImageBase64 = e.target.result.split(',')[1]; 
                    if (PREVIEW_IMAGE) PREVIEW_IMAGE.src = e.target.result;
                    if (ATTACHMENT_PREVIEW) ATTACHMENT_PREVIEW.style.display = 'block';
                    if (INPUT_PLUS_BTN) INPUT_PLUS_BTN.classList.add('text-green-500');
                    if (CHAT_INPUT) CHAT_INPUT.placeholder = getTranslation('send-message-placeholder');
                    
                    renderSystemMessage(getTranslation('error-upload-multi', {filename: file.name}), "info");
                };
                reader.readAsDataURL(file);
            }
            
            event.target.value = null;
        }
        
        function openImageEditor(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                if (EDITOR_IMAGE_PREVIEW) EDITOR_IMAGE_PREVIEW.src = e.target.result;
                tempImageBlob = e.target.result;
                if (IMAGE_EDITOR_MODAL) IMAGE_EDITOR_MODAL.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function closeImageEditor() {
            if (IMAGE_EDITOR_MODAL) IMAGE_EDITOR_MODAL.classList.add('hidden');
            tempImageBlob = null;
            if (EDITOR_IMAGE_PREVIEW) EDITOR_IMAGE_PREVIEW.src = '';
        }
        
        function confirmImageEdit() {
            if (!tempImageBlob) return;
            
            attachedImageBase64 = tempImageBlob.split(',')[1];
            if (PREVIEW_IMAGE) PREVIEW_IMAGE.src = tempImageBlob;
            if (ATTACHMENT_PREVIEW) ATTACHMENT_PREVIEW.style.display = 'block';
            if (INPUT_PLUS_BTN) INPUT_PLUS_BTN.classList.add('text-green-500');
            
            if (CHAT_INPUT) CHAT_INPUT.placeholder = getTranslation('send-message-placeholder');
            
            closeImageEditor();
        }

        function removeAttachment() {
            attachedImageBase64 = null;
            if (ATTACHMENT_PREVIEW) ATTACHMENT_PREVIEW.style.display = 'none';
            if (PREVIEW_IMAGE) PREVIEW_IMAGE.src = '';
            if (INPUT_PLUS_BTN) INPUT_PLUS_BTN.classList.remove('text-green-500');
            if (CHAT_INPUT) CHAT_INPUT.placeholder = getTranslation('send-message-placeholder');
        }

        function autoResizeTextarea() {
            if (CHAT_INPUT) {
                CHAT_INPUT.style.height = 'auto';
                CHAT_INPUT.style.height = (CHAT_INPUT.scrollHeight) + 'px';
            }
        }

        
        // --- Auth Functions (Global Scope'a Taşıma) ---
        
        window.openSettingsModal = () => {
            if (!SETTINGS_MODAL || !MODAL_SETTINGS_VIEW || !MODAL_LOGIN_VIEW) {
                console.error("Modal elementleri bulunamadı.");
                return;
            }
            if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden');
            if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden');
            if(RESET_MESSAGE) RESET_MESSAGE.classList.add('hidden');
            
            SETTINGS_MODAL.classList.remove('hidden');
            
            if (auth && auth.currentUser && !auth.currentUser.isAnonymous) {
                MODAL_LOGIN_VIEW.classList.add('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                MODAL_RESET_VIEW.classList.add('hidden');
                MODAL_SETTINGS_VIEW.classList.remove('hidden');
            } else {
                MODAL_LOGIN_VIEW.classList.remove('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                MODAL_RESET_VIEW.classList.add('hidden');
                MODAL_SETTINGS_VIEW.classList.add('hidden');
            }
        };

        window.closeSettingsModal = () => {
            if (SETTINGS_MODAL) SETTINGS_MODAL.classList.add('hidden');
        };
        
        window.openPremiumModal = () => {
            if (PREMIUM_MODAL) PREMIUM_MODAL.classList.remove('hidden');
        };
        window.closePremiumModal = () => {
            if (PREMIUM_MODAL) PREMIUM_MODAL.classList.add('hidden');
        };
        
        function renderAuthError(error, view = 'login') {
            let errorMessage = getTranslation('error-auth-unknown');
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                errorMessage = getTranslation('error-auth-wrong-password');
            } else if (error.code === 'auth/email-not-verified') {
                errorMessage = getTranslation('error-auth-not-verified');
            } else if (error.code === 'auth/email-already-in-use') {
                errorMessage = getTranslation('error-auth-email-in-use');
            } else if (error.code === 'auth/weak-password') {
                errorMessage = getTranslation('error-auth-weak-password');
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = getTranslation('error-auth-invalid-email');
            } else if (error.code === 'auth/configuration-not-found') {
                errorMessage = getTranslation('error-auth-no-method');
            } else {
                errorMessage = error.message;
            }

            const el = (view === 'login') ? AUTH_ERROR_MESSAGE : (view === 'signup') ? SIGNUP_ERROR_MESSAGE : RESET_MESSAGE;

            if (el) {
                el.textContent = errorMessage;
                el.classList.remove('hidden', 'text-green-500');
                el.classList.add('text-red-500');
            } else {
                renderSystemMessage(getTranslation('error-system-message', {message: errorMessage}), "error");
            }
        }


        async function signInWithEmail() {
            if (!auth || !EMAIL_INPUT || !PASSWORD_INPUT || !AUTH_ERROR_MESSAGE) return;
            AUTH_ERROR_MESSAGE.classList.add('hidden');
            try {
                const email = EMAIL_INPUT.value;
                const password = PASSWORD_INPUT.value;
                if (!email || !password) {
                    renderAuthError({ code: 'auth/missing-fields', message: getTranslation('error-auth-missing-fields') }, 'login');
                    return;
                }
                
                const userCredential = await signInWithEmailAndPassword(auth, email, password);
                
                // Düzeltme: Kullanıcıyı tekrar yükleyip kontrol et
                await userCredential.user.reload();
                
                if (!userCredential.user.emailVerified) {
                    await signOut(auth);
                    renderAuthError({ code: 'auth/email-not-verified' }, 'login');
                    return;
                }

                window.closeSettingsModal();

            } catch (error) {
                console.error(getTranslation('error-gemini-generic'), error);
                renderAuthError(error, "login");
            }
        }

        // YENİ: Google ile Giriş/Kayıt Fonksiyonu
        async function signInWithGoogle() {
            if (!auth) return;
            const provider = new GoogleAuthProvider();
            try {
                const result = await signInWithPopup(auth, provider);
                const user = result.user;

                if (db) {
                    const profileRef = doc(db, "users", user.uid, "chats", "--profile--");
                    const profileDoc = await getDoc(profileRef);
                    if (!profileDoc.exists()) {
                        await setDoc(profileRef, {
                            username: user.displayName || user.email.split('@')[0],
                            email: user.email,
                            role: "normal",
                            date: getTodayDateString(),
                            tokens: 0,
                        });
                    }
                }

                window.closeSettingsModal();
            } catch (error) {
                console.error("Google Giriş Hatası:", error);
                renderAuthError(error, "login");
            }
        }

        async function signUpWithEmail() {
            if (!auth || !SIGNUP_EMAIL_INPUT || !SIGNUP_PASSWORD_INPUT || !SIGNUP_USERNAME_INPUT || !SIGNUP_ERROR_MESSAGE) return;
            SIGNUP_ERROR_MESSAGE.classList.add('hidden');
            try {
                const username = SIGNUP_USERNAME_INPUT.value.trim(); // YENİ
                const email = SIGNUP_EMAIL_INPUT.value;
                const password = SIGNUP_PASSWORD_INPUT.value;
                
                if (!username || !email || !password) { // YENİ
                    renderAuthError({ code: 'auth/missing-fields', message: getTranslation('error-signup-missing-fields') }, 'signup');
                    return;
                }
                if (password.length < 6) {
                    renderAuthError({ code: 'auth/weak-password' }, 'signup');
                    return;
                }
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                try {
                    await sendEmailVerification(userCredential.user);
                    renderSystemMessage(getTranslation('success-signup'), "info");
                    console.log("Doğrulama e-postası gönderildi.");
                } catch (verifyError) {
                    console.error("Doğrulama e-postası gönderilemedi:", verifyError);
                    renderSystemMessage(getTranslation('success-signup-no-email'), "error");
                }

                if (userCredential.user && db) {
                    const userId = userCredential.user.uid;
                    
                    const profileRef = doc(db, "users", userId, "chats", "--profile--");
                    await setDoc(profileRef, {
                        username: username, // YENİ
                        email: userCredential.user.email,
                        role: "normal",
                        date: getTodayDateString(),
                        tokens: 0,
                    });
                }
                
                window.closeSettingsModal();
            } catch (error) {
                console.error("Email Kayıt Hatası:", error);
                renderAuthError(error, "signup");
            }
        }

        async function sendPasswordReset() {
            if (!auth || !RESET_EMAIL_INPUT || !RESET_MESSAGE || !RESET_BTN) return;
            RESET_MESSAGE.classList.add('hidden');
            const email = RESET_EMAIL_INPUT.value;

            if (!email) {
                renderAuthError({ code: 'auth/invalid-email', message: getTranslation('error-password-reset-email') }, 'reset');
                return;
            }

            RESET_BTN.disabled = true;
            RESET_BTN.textContent = getTranslation('thinking');

            try {
                await sendPasswordResetEmail(auth, email);
                
                RESET_MESSAGE.textContent = getTranslation('success-password-reset');
                RESET_MESSAGE.classList.remove('hidden', 'text-red-500');
                RESET_MESSAGE.classList.add('text-green-500');

            } catch (error) {
                console.error(getTranslation('error-password-reset-fail'), error);
                renderAuthError(error, 'reset');
            } finally {
                RESET_BTN.disabled = false;
                RESET_BTN.textContent = getTranslation('send-reset-link');
            }
        }


        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                window.closeSettingsModal();
                if (EMAIL_VERIFY_MODAL) EMAIL_VERIFY_MODAL.classList.add('hidden');
                stopVoiceChat();
                renderSystemMessage(getTranslation('success-logout'));
            } catch (error) {
                 console.error(getTranslation('error-logout'), error);
            }
        }
        
        
        function listenToChat(userId, chatId) {
            if (!db) return;
            if (unsubscribeChat) unsubscribeChat();

            isTemporaryChat = false;
            currentChatId = chatId;
            if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.innerHTML = '';

            if (CURRENT_MODE_DISPLAY) {
                CURRENT_MODE_DISPLAY.textContent = "";
                CURRENT_MODE_DISPLAY.style.display = 'none';
            }

            const messagesQuery = query(
                collection(db, "users", userId, "chats", chatId, "messages"),
                orderBy("createdAt", "asc")
            );

            unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
                if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.innerHTML = ''; 
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if (msg.imageUrl && msg.sender === 'ai') {
                        const imageUrl = msg.imageUrl;
                        addImageToUI(imageUrl, `Görsel tanımı: "${msg.text}"`);
                    } else {
                        addMessageToUI(msg.text, msg.sender);
                    }
                });
                autoScroll();
            }, (error) => {
                console.error(getTranslation('error-chat-load'), error);
                renderSystemMessage(getTranslation('error-chat-load', {message: error.message}), "error");
            });
        }
        
        function listenToChatHistory(userId) {
            if (!db) return;
            if (unsubscribeHistory) unsubscribeHistory();

            const historyQuery = query(
                collection(db, "users", userId, "chats"),
                orderBy("createdAt", "desc")
            );

            unsubscribeHistory = onSnapshot(historyQuery, (snapshot) => {
                const currentChatItems = new Set();
                const modeDisplay = document.getElementById('current-mode-display');

                document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                    if (item.id !== 'current-mode-display') {
                        item.remove();
                    }
                });

                snapshot.forEach(doc => {
                    const chat = doc.data();
                    const chatId = doc.id;
                    
                    if (chatId === '--profile--') return; 

                    currentChatItems.add(chatId);
                    
                    let li = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                    
                    if (!li) {
                        li = document.createElement('li');
                        li.className = 'chat-item';
                        li.dataset.chatId = chatId;

                        li.innerHTML = `
                            <span class="chat-item-title"></span>
                            <button class="chat-item-menu-btn">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        `;

                        if (modeDisplay) modeDisplay.insertAdjacentElement('afterend', li);

                        const titleEl = li.querySelector('.chat-item-title');
                        if (titleEl) {
                            titleEl.onclick = () => {
                                if (isWaitingForResponse) return;
                                stopVoiceChat();
                                
                                document.querySelectorAll('#chat-history-list .chat-item.active').forEach(item => {
                                    item.classList.remove('active');
                                });
                                li.classList.add('active');
                                
                                listenToChat(userId, chatId);

                                if (SIDEBAR && SIDEBAR.classList.contains('open')) {
                                    toggleSidebar(false);
                                }
                            };
                        }
                        
                        const menuBtn = li.querySelector('.chat-item-menu-btn');
                        if (menuBtn) {
                            menuBtn.onclick = (e) => {
                                e.stopPropagation();
                                openChatContextMenu(e, chatId);
                            };
                        }
                    }

                    const titleEl = li.querySelector('.chat-item-title');
                    if (titleEl) {
                        titleEl.textContent = chat.title || getTranslation('new-chat');
                    }
                    
                    if (chatId === currentChatId) {
                        li.classList.add('active');
                    } else {
                        li.classList.remove('active');
                    }
                });
            }, (error) => {
                console.error(getTranslation('error-history-load'), error);
            });
        }


        async function setupAuthListener() {
            if (!auth) {
                console.log(getTranslation('error-auth-init-fail'));
                if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                startNewChat(false);
                renderSystemMessage(getTranslation('error-auth-init-anon'), "error");
                return;
            }
            
            await setPersistence(auth, browserLocalPersistence);
            
            onAuthStateChanged(auth, async (user) => {
                
                if (unsubscribeChat) unsubscribeChat();
                if (unsubscribeHistory) unsubscribeHistory();
                unsubscribeChat = null;
                unsubscribeHistory = null;
                dailyUsage = {};
                if (EMAIL_VERIFY_MODAL) EMAIL_VERIFY_MODAL.classList.add('hidden');
                stopVoiceChat();
                
                if (user) {
                    console.log("Auth durumu değişti. Kullanıcı:", user.uid, "Anonim mi:", user.isAnonymous);
                    currentUserId = user.uid;
                    
                    await user.reload(); 

                    const profileRef = doc(db, "users", user.uid, "chats", "--profile--");
                    const profileDoc = await getDoc(profileRef);

                    if (user.isAnonymous) {
                        currentUserRole = 'anonymous';
                        if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden'); 
                        if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
                        
                        if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');
                        
                        document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                            if (item.id !== 'current-mode-display') item.remove();
                        });

                        let currentTokens = 0;
                        if (profileDoc.exists()) {
                            currentTokens = profileDoc.data().tokens || 0; 
                        } else {
                            await setDoc(profileRef, {
                                email: "anonymous",
                                role: "anonymous",
                                tokens: 0
                            });
                        }
                        dailyUsage = { tokens: currentTokens };
                        const maxTokens = QUOTAS.anonymous.tokens;
                        updateTokenDisplay(dailyUsage.tokens, maxTokens);
                        
                        await startNewChat(false);

                    } else {
                        // YENİ: Düzeltilmiş Doğrulama Kontrolü
                        if (!user.emailVerified) {
                            console.warn("Kullanıcının e-postası doğrulanmamış.");
                            if (EMAIL_VERIFY_MODAL) EMAIL_VERIFY_MODAL.classList.remove('hidden');
                            
                            if(LOGIN_VIEW) LOGIN_VIEW.classList.add('hidden');
                            if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
                            if (TOKEN_DISPLAY) TOKEN_DISPLAY.style.display = 'none';
                            document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                                if (item.id !== 'current-mode-display') item.remove();
                            });

                            if (MESSAGES_CONTAINER) MESSAGES_CONTAINER.innerHTML = '';
                            renderSystemMessage(getTranslation('error-auth-not-verified'), "error");
                            toggleInput(true);
                            return;
                        }
                        
                        // E-posta doğrulandı, devam et
                        if(LOGIN_VIEW) LOGIN_VIEW.classList.add('hidden');
                        if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.remove('hidden'); 

                        let role = 'normal';
                        let currentTokens = 0;
                        const todayStr = getTodayDateString();
                        let username = user.email; // Varsayılan

                        if (profileDoc.exists()) {
                            const data = profileDoc.data();
                            let dbRole = data.role;
                            if (!dbRole) dbRole = 'normal';
                            role = dbRole.toLowerCase();
                            username = data.username || user.email; // YENİ: Kullanıcı adını al

                            if (data.date === todayStr) {
                                currentTokens = data.tokens || 0;
                            }
                        } else {
                            // Bu durum normalde signup'ta halledilir, ama bir yedek
                            role = 'normal';
                            currentTokens = 0;
                            username = user.email.split('@')[0]; // E-postadan varsayılan
                            
                            await setDoc(profileRef, {
                                username: username,
                                email: user.email,
                                role: "normal",
                                date: todayStr,
                                tokens: 0
                            });
                        }
                        
                        if (USER_NAME) USER_NAME.textContent = username; // YENİ
                        if (PROFILE_PIC) PROFILE_PIC.textContent = (username || "K")[0].toUpperCase(); // YENİ
                        
                        currentUserRole = role;
                        dailyUsage = { tokens: currentTokens };
                        
                        const roleQuota = QUOTAS[role];
                        const maxTokens = (roleQuota ? roleQuota.tokens : 0) || 0;

                        updateTokenDisplay(dailyUsage.tokens, maxTokens);

                        if (role === 'plus' || role === 'premium' || role === 'admin') {
                            if (PLUS_BTN) PLUS_BTN.classList.add('hidden');
                        } else {
                            if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');
                        }

                        listenToChatHistory(user.uid);
                        await startNewChat(false);
                    }

                } else {
                    console.log("Kullanıcı oturumu kapalı (null).");
                    currentUserId = null;
                    currentUserRole = 'anonymous';
                    
                    if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                    if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');

                    if (TOKEN_DISPLAY) TOKEN_DISPLAY.style.display = 'none';
                    if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');

                    document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                         if (item.id !== 'current-mode-display') item.remove();
                    });

                    try {
                        await signInAnonymously(auth);
                        console.log("Çıkış yapıldı, anonim olarak tekrar giriş yapıldı.");
                    } catch (error) {
                        console.error("Anonim giriş hatası (çıkış sonrası):", error);
                        renderSystemMessage(getTranslation('error-system-message', {message: error.message}), "error");
                    }
                }
            });
        }
        
        // --- Tema Fonksiyonları ---

        function applyTheme(themeName) {
            document.body.className = themeName;
            localStorage.setItem('n0thingai_theme', themeName);
        }
        
        // --- Sidebar (Katlanabilir & Mobil) ---
        function toggleSidebar(open) {
            if (window.innerWidth > 768) {
                if (SIDEBAR) SIDEBAR.classList.toggle('collapsed');
                localStorage.setItem('sidebar_collapsed', SIDEBAR.classList.contains('collapsed'));
            } else {
                if (open) {
                    if (SIDEBAR) SIDEBAR.classList.add('open');
                    if (MOBILE_OVERLAY) MOBILE_OVERLAY.style.display = 'block';
                } else {
                    if (SIDEBAR) SIDEBAR.classList.remove('open');
                    if (MOBILE_OVERLAY) MOBILE_OVERLAY.style.display = 'none';
                }
            }
        }
        
        // --- Ses Tanıma (STT) & Sesli Konuşma (TTS) ---

        function startVoiceChat() {
            if (!auth.currentUser || auth.currentUser.isAnonymous) {
                 renderSystemMessage(getTranslation('error-voice-chat-no-auth'), "error");
                 window.openSettingsModal();
                 return;
            }
             if (!auth.currentUser.emailVerified) {
                renderSystemMessage(getTranslation('error-voice-chat-no-verify'), "error");
                if (EMAIL_VERIFY_MODAL) EMAIL_VERIFY_MODAL.classList.remove('hidden');
                return;
            }

            isVoiceChatActive = true;
            document.body.classList.add('voice-chat-active');
            closeInputPopover();
            renderSystemMessage(getTranslation('voice-chat-started'), "info");
            if (VOICE_CHAT_STATUS) VOICE_CHAT_STATUS.textContent = getTranslation('tap-to-speak');
            
            // Sesli konuşma başladığında STT'yi "continuous" modda başlat
            if (recognition) {
                recognition.continuous = true;
            }
        }

        function stopVoiceChat() {
            if (!isVoiceChatActive) return; 

            isVoiceChatActive = false;
            document.body.classList.remove('voice-chat-active');
            
            if (recognition) {
                recognition.stop();
            }
            if (TTS_AUDIO_PLAYER) {
                TTS_AUDIO_PLAYER.pause();
                TTS_AUDIO_PLAYER.src = "";
            }
            hideTypingIndicator();
            renderSystemMessage(getTranslation('voice-chat-ended'), "info");
        }

        function toggleVoiceBubbleListen() {
            if (!recognition) return;
            
            // Dili ayarla
            const lang = currentLang === 'en' ? 'en-US' : 'tr-TR';
            if (recognition.lang !== lang) {
                recognition.lang = lang;
            }
            recognition.continuous = true; // Sesli sohbet her zaman süreklidir

            if (VOICE_CHAT_BUBBLE_BTN && VOICE_CHAT_BUBBLE_BTN.classList.contains('recording')) {
                recognition.stop();
            } else {
                if (isWaitingForResponse) return;
                try {
                    recognition.start();
                } catch(e) {
                    console.error(getTranslation('error-stt-fail'), e);
                }
            }
        }

        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                if(SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.disabled = true;
                if(SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.title = getTranslation('error-stt-unsupported');
                if(POPOVER_VOICE_BTN) POPOVER_VOICE_BTN.disabled = true;
                if(POPOVER_VOICE_BTN) POPOVER_VOICE_BTN.style.opacity = 0.5;
                if(POPOVER_VOICE_BTN) POPOVER_VOICE_BTN.title = getTranslation('error-stt-unsupported');
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Varsayılanı sürekli yap, mod değiştirirken ayarla
            recognition.lang = (currentLang === 'en') ? 'en-US' : 'tr-TR';
            recognition.interimResults = true;

            recognition.onstart = () => {
                if (isVoiceChatActive) {
                    if (VOICE_CHAT_BUBBLE_BTN) VOICE_CHAT_BUBBLE_BTN.classList.add('recording');
                    if (VOICE_CHAT_STATUS) VOICE_CHAT_STATUS.textContent = getTranslation('voice-listening');
                } else {
                    if (SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.classList.add('recording');
                    if (CHAT_INPUT) CHAT_INPUT.placeholder = getTranslation('voice-listening');
                }
            };

            recognition.onresult = (event) => {
                let transcript = "";
                let isFinal = false;

                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    transcript += event.results[i][0].transcript;
                    if (event.results[i].isFinal) {
                        isFinal = true;
                    }
                }
                
                if (isVoiceChatActive) {
                    if (VOICE_CHAT_STATUS) VOICE_CHAT_STATUS.textContent = transcript || getTranslation('voice-listening');
                    
                    if (isFinal && transcript.trim()) {
                        console.log("Final transcript (voice chat):", transcript);
                        recognition.stop(); // Konuşma bitince dur
                        sendMessage(transcript, true); // Mesajı gönder
                    }
                } else {
                    if (CHAT_INPUT) CHAT_INPUT.value = transcript;
                    autoResizeTextarea();
                    // Normal STT'de, durdurma işlemi kullanıcı tarafından yapılır (veya continuous=false ise otomatik)
                }
            };

            recognition.onerror = (event) => {
                console.error("Ses tanıma hatası:", event.error);
                if (event.error === 'not-allowed') {
                    renderSystemMessage(getTranslation('error-stt-not-allowed'), "error");
                    stopVoiceChat();
                }
                if (event.error === 'no-speech') {
                     console.log(getTranslation('error-stt-no-speech'));
                     // Konuşma algılanmazsa (boşluk), recognition.onend tetiklenir
                }
            };

            recognition.onend = () => {
                if (isVoiceChatActive) {
                    if (VOICE_CHAT_BUBBLE_BTN) VOICE_CHAT_BUBBLE_BTN.classList.remove('recording');
                    if (!isWaitingForResponse && VOICE_CHAT_STATUS) {
                        VOICE_CHAT_STATUS.textContent = getTranslation('voice-tap-to-speak');
                    }
                } else {
                    if (SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.classList.remove('recording');
                    toggleInput(false);
                }
            };
        }

        function toggleSpeechRecognition() {
            if (!recognition) return;
            
            const lang = currentLang === 'en' ? 'en-US' : 'tr-TR';
            if (recognition.lang !== lang) {
                recognition.lang = lang;
            }

            if (isVoiceChatActive) {
                toggleVoiceBubbleListen();
                return;
            }

            if (SPEECH_TO_TEXT_BTN && SPEECH_TO_TEXT_BTN.classList.contains('recording')) {
                recognition.stop();
            } else {
                try {
                    // Normal STT için 'continuous' false olmalı
                    recognition.continuous = false;
                    recognition.start();
                } catch(e) {
                    console.error(getTranslation('error-stt-fail'), e);
                }
            }
        }

        function openChatContextMenu(event, chatId) {
            contextMenuChatId = chatId;
            
            if (CHAT_CONTEXT_MENU) {
                CHAT_CONTEXT_MENU.style.left = `${event.pageX}px`;
                CHAT_CONTEXT_MENU.style.top = `${event.pageY}px`;
                CHAT_CONTEXT_MENU.classList.remove('hidden');
            }

            document.addEventListener('click', closeChatContextMenu, { once: true });
        }

        function closeChatContextMenu() {
            if (CHAT_CONTEXT_MENU) CHAT_CONTEXT_MENU.classList.add('hidden');
            contextMenuChatId = null;
        }

        async function renameChat() {
            if (!contextMenuChatId || !currentUserId || !db) return;
            
            const chatRef = doc(db, "users", currentUserId, "chats", contextMenuChatId);
            const chatDoc = await getDoc(chatRef);
            const currentTitle = chatDoc.data().title || "";

            const newTitle = prompt(getTranslation('rename'), currentTitle);

            if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
                // FIX: Kopyala-yapıştır hatası. 'if' bloğunun içeriği ve fonksiyonun
                // kapanış parantezi eksikti. Bu, 'Unexpected end of input' hatasına neden oluyordu.
                try {
                    await updateDoc(chatRef, {
                        title: newTitle.trim().substring(0, 30)
                    });
                    console.log("Başlık güncellendi:", newTitle);
                } catch (error) {
                    console.error(getTranslation('error-chat-rename'), error);
                    renderSystemMessage(getTranslation('error-chat-rename'), "error");
                }
            }
        } // <-- FIX: Eksik kapanış parantezi eklendi.

        // FIX: 'openDeleteModal' ve 'closeDeleteModal' fonksiyonları eksikti.
        // Bu fonksiyonlar 'openDeleteModal is not defined' hatasını çözmek için eklendi.
        function openDeleteModal() {
            if (!contextMenuChatId) return;
            if (CHAT_CONTEXT_MENU) CHAT_CONTEXT_MENU.classList.add('hidden');
            if (DELETE_CONFIRM_MODAL) DELETE_CONFIRM_MODAL.classList.remove('hidden');
        }

        function closeDeleteModal() {
            if (DELETE_CONFIRM_MODAL) DELETE_CONFIRM_MODAL.classList.add('hidden');
            contextMenuChatId = null; // chat ID'yi burada sıfırla
        }

        // DÜZELTME: 'deleteCollection' ve 'deleteQueryBatch' fonksiyonları,
        // 'confirmDeleteChat' fonksiyonundan ÖNCE tanımlanmalıdır.
        // Bu, 'deleteCollection is not defined' hatasını önler.
        async function deleteQueryBatch(db, q, resolve) {
            const snapshot = await getDocs(q);
            const batchSize = snapshot.size;

            if (batchSize === 0) {
                resolve();
                return;
            }

            const batch = writeBatch(db);
            snapshot.docs.forEach((doc) => {
                batch.delete(doc.ref);
            });

            await batch.commit();

            // DÜZELTME: 'process.nextTick' (Node.js) yerine tarayıcı uyumlu 'setTimeout(..., 0)' kullanıldı.
            // Bu, 'process is not defined' hatasını düzeltir ve silme işleminin çalışmasını sağlar.
            setTimeout(() => {
                deleteQueryBatch(db, q, resolve);
            }, 0);
        }
        
        // DÜZELTME: Bu fonksiyon, confirmDeleteChat'ten önce tanımlandı.
        async function deleteCollection(db, collectionPath, batchSize = 500) {
          const collectionRef = collection(db, collectionPath);
          const q = query(collectionRef, orderBy('__name__'), limit(batchSize));

          return new Promise((resolve, reject) => {
            deleteQueryBatch(db, q, resolve).catch(reject);
          });
        }

        async function confirmDeleteChat() {
            if (!contextMenuChatId || !currentUserId || !db || !CONFIRM_DELETE_BTN) {
                console.warn("Silme koşulları karşılanmadı.");
                return;
            }

            const chatIdToDelete = contextMenuChatId;
            const userId = currentUserId;
            
            CONFIRM_DELETE_BTN.disabled = true;
            CONFIRM_DELETE_BTN.textContent = getTranslation('thinking');
            
            console.log(`Sohbet siliniyor: ${chatIdToDelete}, Kullanıcı: ${userId}`);

            try {
                // FIX: deleteCollection fonksiyonu çağrılmalı (önceki düzeltmedeki gibi)
                console.log("Mesajlar siliniyor...");
                // 'deleteCollection' artık burada çağrıldığında tanımlı olacaktır.
                await deleteCollection(db, `users/${userId}/chats/${chatIdToDelete}/messages`);

                console.log("Ana sohbet siliniyor...");
                const chatRef = doc(db, "users", userId, "chats", chatIdToDelete);
                await deleteDoc(chatRef);
                console.log("Ana sohbet silindi.");

                console.log("Sohbet ve mesajları başarıyla silindi.");

                if (chatIdToDelete === currentChatId) {
                    await startNewChat(false);
                }

            } catch (error) {
                console.error("Sohbet silinirken HATA:", error);
                if (error.message.includes("permission-denied") || error.message.includes("firestore/permission-denied")) {
                    renderSystemMessage(getTranslation('error-chat-delete-permission'), "error");
                } else {
                    renderSystemMessage(getTranslation('error-chat-delete', {message: error.message}), "error");
                }

            } finally {
                closeDeleteModal(); 
                CONFIRM_DELETE_BTN.disabled = false;
                CONFIRM_DELETE_BTN.textContent = getTranslation('delete');
            }
        }
        
        // DÜZELTME: deleteCollection fonksiyonu buradan kaldırıldı ve confirmDeleteChat'in üstüne taşındı.


        function toggleInputPopover() {
            if (INPUT_POPOVER_MENU) INPUT_POPOVER_MENU.classList.toggle('hidden');
        }
        function closeInputPopover() {
            if (INPUT_POPOVER_MENU) INPUT_POPOVER_MENU.classList.add('hidden');
        }
        
        function enterImagePromptMode() {
            closeInputPopover();
            if (INPUT_AREA) INPUT_AREA.classList.add('image-mode-active');
            if (IMAGE_PROMPT_TAG) IMAGE_PROMPT_TAG.classList.remove('hidden');
            if (CHAT_INPUT) {
                CHAT_INPUT.placeholder = getTranslation('image-prompt-tag');
                CHAT_INPUT.focus();
            }
        }

        function cancelImagePrompt() {
            if (INPUT_AREA) INPUT_AREA.classList.remove('image-mode-active');
            if (IMAGE_PROMPT_TAG) IMAGE_PROMPT_TAG.classList.add('hidden');
            if (CHAT_INPUT) {
                CHAT_INPUT.placeholder = getTranslation('send-message-placeholder');
                CHAT_INPUT.value = "";
            }
        }

        function togglePasswordVisibility(e) {
            const button = e.currentTarget;
            if (!button) return;
            const input = button.previousElementSibling;
            const icon = button.querySelector('i');
            
            if (input && input.type === "password") {
                input.type = "text";
                if (icon) {
                    icon.classList.remove("fa-eye");
                    icon.classList.add("fa-eye-slash");
                }
            } else if (input) {
                input.type = "password";
                if (icon) {
                    icon.classList.remove("fa-eye-slash");
                    icon.classList.add("fa-eye");
                }
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            if (NEW_CHAT_BTN) NEW_CHAT_BTN.addEventListener('click', () => startNewChat(false));
            
            if (TEMP_CHAT_BUTTONS) {
                TEMP_CHAT_BUTTONS.forEach(btn => {
                    if (btn) btn.addEventListener('click', () => startNewChat(true));
                });
            }
            
            if (SEND_BTN) SEND_BTN.addEventListener('click', () => sendMessage("", false));
            if (CHAT_INPUT) {
                CHAT_INPUT.addEventListener('keydown', handleKey);
                CHAT_INPUT.addEventListener('input', autoResizeTextarea);
            }
            
            if (INPUT_PLUS_BTN) {
                INPUT_PLUS_BTN.addEventListener('click', (e) => {
                    e.stopPropagation(); 
                    toggleInputPopover();
                });
            }
            if (POPOVER_UPLOAD_BTN) {
                POPOVER_UPLOAD_BTN.addEventListener('click', () => { 
                    if (FILE_INPUT) FILE_INPUT.click(); 
                    closeInputPopover(); 
                });
            }
            if (POPOVER_IMAGE_BTN) POPOVER_IMAGE_BTN.addEventListener('click', enterImagePromptMode);
            if (POPOVER_VOICE_BTN) POPOVER_VOICE_BTN.addEventListener('click', startVoiceChat);
            if (CANCEL_IMAGE_PROMPT_BTN) CANCEL_IMAGE_PROMPT_BTN.addEventListener('click', cancelImagePrompt);

            if (VOICE_CHAT_BUBBLE_BTN) VOICE_CHAT_BUBBLE_BTN.addEventListener('click', toggleVoiceBubbleListen);
            if (VOICE_CHAT_CLOSE_BTN) VOICE_CHAT_CLOSE_BTN.addEventListener('click', stopVoiceChat);
            
            if (TTS_AUDIO_PLAYER) {
                TTS_AUDIO_PLAYER.addEventListener('ended', () => { 
                    hideTypingIndicator(); 
                });
                TTS_AUDIO_PLAYER.addEventListener('error', (e) => { 
                    hideTypingIndicator(); 
                    console.error("Ana TTS Hatası:", e);
                    renderSystemMessage(getTranslation('error-tts-fail'), "error"); 
                });
                TTS_AUDIO_PLAYER.addEventListener('playing', () => { 
                    showTypingIndicator(getTranslation('voice-speaking')); 
                });
            }

            document.addEventListener('click', (e) => {
                if (INPUT_POPOVER_MENU && INPUT_PLUS_BTN && !INPUT_POPOVER_MENU.classList.contains('hidden') && !INPUT_PLUS_BTN.contains(e.target) && !INPUT_POPOVER_MENU.contains(e.target)) {
                    closeInputPopover();
                }
            });

            if (FILE_INPUT) FILE_INPUT.addEventListener('change', handleFileSelect);
            if (REMOVE_ATTACHMENT_BTN) REMOVE_ATTACHMENT_BTN.addEventListener('click', removeAttachment);
            
            if (CANCEL_IMAGE_EDIT_BTN) CANCEL_IMAGE_EDIT_BTN.addEventListener('click', closeImageEditor);
            if (CONFIRM_IMAGE_EDIT_BTN) CONFIRM_IMAGE_EDIT_BTN.addEventListener('click', confirmImageEdit);
            
            if (SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.addEventListener('click', toggleSpeechRecognition);
            setupSpeechRecognition();

            if (EMAIL_SIGNIN_BTN) EMAIL_SIGNIN_BTN.addEventListener('click', signInWithEmail);
            if (SIGNUP_BTN) SIGNUP_BTN.addEventListener('click', signUpWithEmail);
            if (SIGNOUT_BTN) SIGNOUT_BTN.addEventListener('click', signOutUser);
            if (RESET_BTN) RESET_BTN.addEventListener('click', sendPasswordReset);
            
            if (PLUS_BTN) PLUS_BTN.addEventListener('click', window.openPremiumModal);

            if (SHOW_SIGNUP_BTN) {
                SHOW_SIGNUP_BTN.addEventListener('click', () => {
                    if (MODAL_LOGIN_VIEW) MODAL_LOGIN_VIEW.classList.add('hidden');
                    if (MODAL_RESET_VIEW) MODAL_RESET_VIEW.classList.add('hidden');
                    if (MODAL_SIGNUP_VIEW) MODAL_SIGNUP_VIEW.classList.remove('hidden');
                    if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden');
                });
            }
            if (SHOW_SIGNIN_BTN) {
                SHOW_SIGNIN_BTN.addEventListener('click', () => {
                    if (MODAL_LOGIN_VIEW) MODAL_LOGIN_VIEW.classList.remove('hidden');
                    if (MODAL_SIGNUP_VIEW) MODAL_SIGNUP_VIEW.classList.add('hidden');
                    if (MODAL_RESET_VIEW) MODAL_RESET_VIEW.classList.add('hidden');
                    if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden');
                });
            }
            if (SHOW_RESET_BTN) {
                SHOW_RESET_BTN.addEventListener('click', () => {
                    if (MODAL_LOGIN_VIEW) MODAL_LOGIN_VIEW.classList.add('hidden');
                    if (MODAL_SIGNUP_VIEW) MODAL_SIGNUP_VIEW.classList.add('hidden');
                    if (MODAL_RESET_VIEW) MODAL_RESET_VIEW.classList.remove('hidden');
                    if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden');
                });
            }
            if (SHOW_SIGNIN_BTN_FROM_RESET) {
                SHOW_SIGNIN_BTN_FROM_RESET.addEventListener('click', () => {
                    if (MODAL_LOGIN_VIEW) MODAL_LOGIN_VIEW.classList.remove('hidden');
                    if (MODAL_SIGNUP_VIEW) MODAL_SIGNUP_VIEW.classList.add('hidden');
                    if (MODAL_RESET_VIEW) MODAL_RESET_VIEW.classList.add('hidden');
                    if(RESET_MESSAGE) RESET_MESSAGE.classList.add('hidden');
                });
            }

            
            if (THEME_SELECTOR) {
                THEME_SELECTOR.addEventListener('change', (e) => {
                    applyTheme(e.target.value);
                });
            }
            
            if (LANGUAGE_SELECTOR) {
                LANGUAGE_SELECTOR.addEventListener('change', (e) => {
                    applyLanguage(e.target.value);
                });
            }
            if (VOICE_SELECTOR) {
                VOICE_SELECTOR.addEventListener('change', (e) => {
                    localStorage.setItem('n0thingai_voice', e.target.value);
                });
            }
            if (SAMPLE_VOICE_BTN) SAMPLE_VOICE_BTN.addEventListener('click', playSampleTTS);
            
            if (SAMPLE_AUDIO_PLAYER) {
                SAMPLE_AUDIO_PLAYER.addEventListener('ended', () => {
                     if (SAMPLE_VOICE_BTN) {
                        SAMPLE_VOICE_BTN.disabled = false;
                        SAMPLE_VOICE_BTN.innerHTML = '<i class="fas fa-play"></i>';
                     }
                });
                SAMPLE_AUDIO_PLAYER.addEventListener('error', (e) => {
                    console.error("Örnek TTS Hatası:", e);
                    alert(getTranslation('error-tts-fail'));
                    if (SAMPLE_VOICE_BTN) {
                        SAMPLE_VOICE_BTN.disabled = false;
                        SAMPLE_VOICE_BTN.innerHTML = '<i class="fas fa-play"></i>';
                    }
                });
            }

            document.querySelectorAll('.password-toggle-btn').forEach(btn => {
                if (btn) btn.addEventListener('click', togglePasswordVisibility);
            });


            if (TOGGLE_SIDEBAR_BTN) TOGGLE_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar());
            if (OPEN_SIDEBAR_BTN) OPEN_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar(true));
            if (MOBILE_OVERLAY) MOBILE_OVERLAY.addEventListener('click', () => toggleSidebar(false));

            if (MESSAGES_CONTAINER && SCROLL_TO_BOTTOM_BTN) {
                MESSAGES_CONTAINER.addEventListener('scroll', () => {
                    const isScrolledUp = (MESSAGES_CONTAINER.scrollHeight - MESSAGES_CONTAINER.scrollTop - MESSAGES_CONTAINER.clientHeight) > 200;
                    if (isScrolledUp) {
                        SCROLL_TO_BOTTOM_BTN.style.display = 'flex';
                    } else {
                        SCROLL_TO_BOTTOM_BTN.style.display = 'none';
                    }
                });
                SCROLL_TO_BOTTOM_BTN.addEventListener('click', autoScroll);
            }

            // DÜZELTME: "Sohbeti Sil" ve "Yeniden Adlandır" butonlarına tıklandığında
            // sayfanın tıklama olayını (document.click) tetiklemesini engellemek için
            // e.stopPropagation() eklendi. Bu, 'contextMenuChatId'nin
            // silme işlemi başlamadan 'null' olmasını engeller.
            if (RENAME_CHAT_BTN) RENAME_CHAT_BTN.addEventListener('click', (e) => {
                e.stopPropagation(); 
                renameChat();
            });
            if (DELETE_CHAT_BTN) DELETE_CHAT_BTN.addEventListener('click', (e) => {
                e.stopPropagation(); 
                openDeleteModal();
            });
            
            if (CANCEL_DELETE_BTN) CANCEL_DELETE_BTN.addEventListener('click', closeDeleteModal);
            if (CONFIRM_DELETE_BTN) CONFIRM_DELETE_BTN.addEventListener('click', confirmDeleteChat);
            
            const RESEND_VERIFY_BTN = document.getElementById('resend-verify-btn');
            const CHECK_VERIFY_BTN = document.getElementById('check-verify-btn');
            const SIGNOUT_FROM_VERIFY_BTN = document.getElementById('signout-from-verify-btn');
            
            function setResendButtonCooldown(cooldownEndTime) {
                if (!RESEND_VERIFY_BTN) return;
                const now = Date.now();
                if (now < cooldownEndTime) {
                    RESEND_VERIFY_BTN.disabled = true;
                    const secondsLeft = Math.ceil((cooldownEndTime - now) / 1000);
                    RESEND_VERIFY_BTN.textContent = `${secondsLeft}sn...`;
                    
                    const interval = setInterval(() => {
                        const now = Date.now();
                        if (now >= cooldownEndTime) {
                            clearInterval(interval);
                            RESEND_VERIFY_BTN.disabled = false;
                            RESEND_VERIFY_BTN.textContent = getTranslation('verify-email-resend');
                        } else {
                            const secondsLeft = Math.ceil((cooldownEndTime - now) / 1000);
                            RESEND_VERIFY_BTN.textContent = `${secondsLeft}sn...`;
                        }
                    }, 1000);
                } else {
                    RESEND_VERIFY_BTN.disabled = false;
                    RESEND_VERIFY_BTN.textContent = getTranslation('verify-email-resend');
                }
            }

            if (RESEND_VERIFY_BTN) {
                RESEND_VERIFY_BTN.addEventListener('click', async () => {
                    const now = Date.now();
                    const cooldownEndTime = parseInt(localStorage.getItem('resendCooldownUntil') || '0');

                    if (now < cooldownEndTime) {
                        renderSystemMessage(getTranslation('error-email-resend-wait'), "error");
                        return;
                    }
                    if (!auth.currentUser) return;

                    try {
                        await sendEmailVerification(auth.currentUser);
                        renderSystemMessage(getTranslation('success-email-resend'));
                        
                        const newCooldownEndTime = Date.now() + 60000;
                        localStorage.setItem('resendCooldownUntil', newCooldownEndTime);
                        setResendButtonCooldown(newCooldownEndTime);

                    } catch (error) {
                        console.error(getTranslation('error-email-resend-fail'), error);
                        
                        if (error.code === 'auth/too-many-requests') {
                            renderSystemMessage(getTranslation('error-email-resend-limit'), "error");
                            const newCooldownEndTime = Date.now() + 300000;
                            localStorage.setItem('resendCooldownUntil', newCooldownEndTime);
                            setResendButtonCooldown(newCooldownEndTime);
                        } else {
                            renderSystemMessage(getTranslation('error-system-message', {message: error.message}), "error");
                        }
                    }
                });
            }

            if (CHECK_VERIFY_BTN) {
                CHECK_VERIFY_BTN.addEventListener('click', async () => {
                    if (!auth.currentUser) return;
                    
                    CHECK_VERIFY_BTN.disabled = true;
                    CHECK_VERIFY_BTN.textContent = getTranslation('thinking');

                    await auth.currentUser.reload();
                    
                    if (auth.currentUser.emailVerified) {
                        renderSystemMessage(getTranslation('success-email-verified'), "info");
                        setTimeout(() => location.reload(), 1500);
                    } else {
                        renderSystemMessage(getTranslation('error-email-check-fail'), "error");
                        CHECK_VERIFY_BTN.disabled = false;
                        CHECK_VERIFY_BTN.textContent = getTranslation('verify-email-check');
                    }
                });
            }

            if (SIGNOUT_FROM_VERIFY_BTN) {
                SIGNOUT_FROM_VERIFY_BTN.addEventListener('click', async () => {
                    await signOut(auth);
                });
            }

            if (CHAT_SEARCH_INPUT) {
                CHAT_SEARCH_INPUT.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    document.querySelectorAll('#chat-history-list .chat-item-title').forEach(titleEl => {
                        const itemLi = titleEl.closest('.chat-item');
                        if (titleEl.textContent.toLowerCase().includes(searchTerm)) {
                            itemLi.style.display = 'flex';
                        } else {
                            itemLi.style.display = 'none';
                        }
                    });
                });
            }

            // YENİ: Google Giriş Butonları
            const GOOGLE_SIGNIN_BTN = document.getElementById('google-signin-btn');
            const GOOGLE_SIGNUP_BTN = document.getElementById('google-signup-btn');
            if (GOOGLE_SIGNIN_BTN) GOOGLE_SIGNIN_BTN.addEventListener('click', signInWithGoogle);
            if (GOOGLE_SIGNUP_BTN) GOOGLE_SIGNUP_BTN.addEventListener('click', signInWithGoogle); // Kayıt için de aynı fonksiyonu kullan (Firebase otomatik yönetir)

            // --- YENİ: Kayıtlı ayarları yükle ---
            const savedTheme = localStorage.getItem('n0thingai_theme') || 'dark-mode';
            applyTheme(savedTheme);
            if (THEME_SELECTOR) THEME_SELECTOR.value = savedTheme;
            
            const savedLang = localStorage.getItem('n0thingai_lang') || 'tr';
            applyLanguage(savedLang);
            if (LANGUAGE_SELECTOR) LANGUAGE_SELECTOR.value = savedLang;

            const savedVoice = localStorage.getItem('n0thingai_voice') || 'Puck';
            if (VOICE_SELECTOR) VOICE_SELECTOR.value = savedVoice;

            
            if (window.innerWidth > 768 && SIDEBAR) {
                const isCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';
                if (isCollapsed) {
                    SIDEBAR.classList.add('collapsed');
                }
            }

            setupAuthListener(); 
            
            const initialCooldown = parseInt(localStorage.getItem('resendCooldownUntil') || '0');
            if (initialCooldown > Date.now()) {
                setResendButtonCooldown(initialCooldown);
            }

            // FIX: Fonksiyonları 'window' nesnesine ekleyerek global
            // scope'a taşı. Bu, 'TypeError: ... is not a function' hatasını çözer.
            window.openSettingsModal = openSettingsModal;
            window.closeSettingsModal = closeSettingsModal;
            window.openPremiumModal = openPremiumModal;
            window.closePremiumModal = closePremiumModal;

        });
    </script>
</body>
</html>
