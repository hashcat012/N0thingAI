<!DOCTYPE html>
<html lang="tr">
<head>
    <meta name="google-site-verification" content="AQSoYrgNNGutZzf4jpzwVieUI29wYj_CJKfNka2Uk4I" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N0thingAI</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%239E9E9E'/><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='70' font-weight='bold' fill='%23FFFFFF' font-family='Arial, sans-serif' dy='.1em'>N</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* CSS Değişkenleri - SİYAH/BEYAZ TEMA (ChatGPT Stili) */
        :root {
            /* Varsayılan: Koyu Tema */
            --bg-primary: #202123; /* Ana Arkaplan */
            --sidebar-bg: #0D0D0D; /* Kenar Çubuğu (Daha Koyu) */
            --text-primary: #ECECEC; /* Ana Metin Rengi */
            --text-secondary: #A6A6A6; /* İkincil Metin Rengi */
            --highlight-color: #20C20E; /* N0thingAI Neon Yeşili */
            --active-chat-bg: #2A2A2A; /* Aktif Sohbet Arkaplanı */
            --ai-message-bg: #2A2A2A; /* AI Mesaj Arkaplanı */
            --user-message-bg: #004d00; /* Kullanıcı Mesajı (Koyu Yeşil) */
            --input-bg: #2A2A2A; /* Input Alanı Arkaplanı */
            --input-border: #3A3A3A;
            --shadow-color: rgba(0, 0, 0, 0.3); /* Koyu gölge */
            --modal-bg: #1A1A1A;
            --btn-border: #444;
            --btn-hover: #333;
        }

        /* İSTEK: Varsayılan Gri Arka Plan / Beyaz Yazı */
        .dark-mode {
            --bg-primary: #202123;      /* Koyu Gri Arka Plan */
            --sidebar-bg: #1A1A1A;      /* Daha Koyu Gri Sidebar */
            --text-primary: #ECECEC;      /* Beyazımsı Yazı */
            --text-secondary: #A6A6A6;    /* Soluk Gri Yazı */
            --highlight-color: #9E9E9E; /* Nötr Gri Vurgu */
            --active-chat-bg: #2A2A2A;
            --ai-message-bg: #2A2A2A;
            --user-message-bg: #333333; /* Koyu Gri Kullanıcı Mesajı */
            --input-bg: #2A2A2A;
            --input-border: #3A3A3A;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-bg: #1A1A1A;
            --btn-border: #444;
            --btn-hover: #333;
        }
        
        /* İSTEK: İkincil Beyaz Arka Plan / Gri Yazı */
        .light-mode {
            --bg-primary: #FFFFFF;      /* Beyaz Arka Plan */
            --sidebar-bg: #F9F9F9;
            --text-primary: #333333;      /* Gri Yazı */
            --text-secondary: #555;
            --highlight-color: #555555; /* Koyu Gri Vurgu */
            --active-chat-bg: #EAEAEA;
            --ai-message-bg: #F0F0F0;
            --user-message-bg: #EAEAEA; /* Açık Gri Kullanıcı Mesajı */
            --input-bg: #FFFFFF;
            --input-border: #E0E0E0;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --modal-bg: #FFFFFF;
            --btn-border: #E0E0E0;
            --btn-hover: #F0F0F0;
        }

        /* Genel Stil */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        /* YENİ: Katlanabilir Sidebar için App Container */
        .app-container { 
            display: flex; 
            height: 100vh; 
            overflow: hidden; 
            transition: padding-left 0.3s ease-in-out; /* İçeriğin kayması için */
        }

        /* Sidebar (Geniş ve Katlanmış) */
        .sidebar {
            width: 280px; /* Geniş hal */
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 16px;
            border-right: 1px solid var(--input-border);
            transition: width 0.3s ease-in-out, padding 0.3s ease-in-out; /* Animasyon */
            /* DÜZELTME: Okun taşması için overflow: visible yapıldı */
            overflow: visible; 
            position: fixed; /* YENİ: Sabitlendi */
            height: 100%;
            z-index: 40;
        }
        /* YENİ: Katlanmış Sidebar Stili */
        .sidebar.collapsed {
            width: 72px; /* Sadece ikonlar (12+44+16) */
            padding: 16px 14px; /* DÜZELTME: 14px padding */
        }

        /* YENİ: İçeriğin sidebar'ı ezmemesi için */
        .chat-area {
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            position: relative; 
            background-color: var(--bg-primary);
            margin-left: 280px; /* Sidebar genişliği kadar boşluk */
            transition: margin-left 0.3s ease-in-out; /* Animasyon */
            width: calc(100% - 280px); /* Kalan genişliği al */
        }
        /* YENİ: Sidebar katlanınca chat alanı genişler */
        .sidebar.collapsed + .chat-area {
            margin-left: 72px; /* Katlanmış sidebar genişliği */
            width: calc(100% - 72px);
        }

        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            flex-shrink: 0; /* Küçülmesin */
        }
        
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            overflow: hidden; /* Katlanırken gizlenmesi için */
        }
        .logo-svg {
            width: 32px;
            height: 32px;
            background-color: var(--highlight-color); 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--sidebar-bg);
            font-size: 20px;
            padding-bottom: 2px;
            flex-shrink: 0; /* Küçülmesin */
        }
        .light-mode .logo-svg { color: #FFFFFF; }
        .dark-mode .logo-svg { color: #FFFFFF; }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--text-primary);
            white-space: nowrap; /* Katlanırken kaybolması için */
        }

        /* YENİ: Katlanmış Sidebar Başlığı */
        .sidebar.collapsed .logo-text {
            display: none;
        }
        .sidebar.collapsed .sidebar-header {
            justify-content: center; /* Logoyu ortala */
        }
        
        /* YENİ: Katlama/Açma Butonu */
        .toggle-sidebar-btn {
            background-color: var(--btn-hover);
            color: var(--text-secondary);
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--input-border);
            position: absolute;
            right: -14px; /* Yarısı dışarıda */
            top: 24px;
            z-index: 45;
            transition: transform 0.3s ease, background-color 0.2s;
        }
        .toggle-sidebar-btn:hover {
            background-color: var(--active-chat-bg);
            color: var(--text-primary);
        }
        .sidebar.collapsed .toggle-sidebar-btn {
            transform: rotate(180deg); /* Oku döndür */
        }


        .chat-search-wrapper {
            position: relative;
            margin-bottom: 12px;
            flex-shrink: 0;
            transition: all 0.3s ease-in-out;
        }
        .chat-search-wrapper input {
            width: 100%;
            padding: 8px 12px 8px 34px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-primary);
            border-radius: 8px;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease-in-out;
        }
        .chat-search-wrapper i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            font-size: 0.9rem;
            transition: opacity 0.2s, left 0.3s ease-in-out, font-size 0.3s ease-in-out;
        }
        /* DÜZELTME: Katlanmış Arama */
        .sidebar.collapsed .chat-search-wrapper {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 44px; 
            margin-bottom: 16px;
            border-radius: 8px;
            border: 1px solid var(--btn-border);
        }
        .sidebar.collapsed .chat-search-wrapper:hover {
            background-color: var(--btn-hover);
        }
        .sidebar.collapsed .chat-search-wrapper input {
            opacity: 0;
            width: 0;
            height: 0;
            padding: 0;
            margin: 0;
            border: none;
            position: absolute;
        }
        .sidebar.collapsed .chat-search-wrapper i {
            opacity: 1;
            position: static;
            transform: none;
            font-size: 1.1rem;
            padding: 0;
            margin: 0;
            /* DÜZELTME: İkonun yerini (left) sıfırla */
            left: 0;
        }


        /* Yeni Sohbet Butonu */
        .new-chat-btn {
            padding: 8px 16px; 
            background-color: transparent;
            border: 1px solid var(--btn-border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
            flex-shrink: 0;
            width: 100%; 
            transition: width 0.3s ease-in-out, height 0.3s ease-in-out, padding 0.3s ease-in-out;
        }
        .new-chat-btn:hover { background-color: var(--btn-hover); }
        .new-chat-btn i { 
            margin-right: 8px; 
            transition: margin 0.3s ease-in-out;
        }
        .new-chat-btn .btn-text {
            white-space: nowrap;
            transition: opacity 0.2s;
        }

        /* Sohbet Geçmişi Alanı */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1rem;
            overflow-x: hidden;
        }
        /* Geçmişteki sohbet item'ı */
        .chat-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s;
            color: var(--text-secondary);
        }
        .chat-item-title {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            flex-grow: 1;
            padding-right: 10px;
            transition: opacity 0.2s;
        }
        .chat-item-menu-btn {
            display: none;
            flex-shrink: 0;
            padding: 4px 8px;
            border-radius: 6px;
            background-color: transparent;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all 0.2s;
            z-index: 5;
        }
        .chat-item:hover .chat-item-menu-btn {
            display: block; 
        }
        .chat-item-menu-btn:hover {
            background-color: var(--btn-hover);
            color: var(--text-primary);
        }
        .context-menu-item {
            transition: background-color 0.2s;
        }
        .context-menu-item:hover {
            background-color: var(--btn-hover);
        }
        .context-menu-item:first-child { border-top-left-radius: 8px; border-top-right-radius: 8px; }
        .context-menu-item:last-child { border-bottom-left-radius: 8px; border-bottom-right-radius: 8px; }

        .chat-item.active {
            background-color: var(--active-chat-bg);
            color: var(--text-primary);
            font-weight: 600;
        }
        .chat-item:not(.active):hover {
            background-color: var(--btn-hover);
        }
        
        /* Mod Göstergesi */
        #current-mode-display {
            border-color: var(--highlight-color);
            color: var(--highlight-color);
            background-color: color-mix(in srgb, var(--highlight-color) 10%, transparent);
            text-align: center;
            margin-bottom: 10px;
            white-space: nowrap;
            overflow: hidden;
            transition: opacity 0.2s;
        }

        /* Profil ve Ayarlar (Dinamik Auth Alanı) */
        .sidebar-footer {
            border-top: 1px solid var(--input-border);
            padding-top: 16px;
            margin-top: auto; /* Footer'ı en alta it */
            flex-shrink: 0;
        }
        #auth-container { 
            transition: all 0.3s; 
            overflow: hidden;
        }
        
        #plus-btn {
            position: absolute;
            top: 16px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 20;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 10px;
            background-color: var(--highlight-color);
            color: #fff; 
            font-weight: 700;
            transition: background-color 0.2s, opacity 0.3s ease-in-out;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }
        /* YENİ: Plus butonu sidebar katlanınca gizlensin */
        .sidebar.collapsed ~ .chat-area #plus-btn {
            opacity: 0;
            pointer-events: none;
        }

        .dark-mode #plus-btn { color: #1A1A1A; }
        .light-mode #plus-btn { color: #FFFFFF; }
        #plus-btn:hover {
            background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }
        #plus-btn i {
             text-shadow: 0 0 8px color-mix(in srgb, var(--highlight-color) 50%, white);
             font-size: 0.8rem;
        }

        /* Giriş Yap Butonu (Oturum Kapalı) */
        #login-btn {
            /* GÜNCELLENDİ: Plus butonundan (#9E9E9E) çok az daha parlak yapıldı */
            background-color: #AEAEAE; /* Temanın Vurgu Renginden parlak */
            color: #fff; /* Varsayılan (light-mode için) */
            font-weight: 700;
            transition: background-color 0.2s, width 0.3s ease-in-out, height 0.3s ease-in-out, padding 0.3s ease-in-out;
            display: flex; 
            align-items: center;
            justify-content: center;
            width: 100%;
            overflow: hidden;
        }
        #login-btn .btn-text {
            white-space: nowrap;
            transition: opacity 0.2s;
        }
        #login-btn i {
            margin-right: 8px;
            transition: margin 0.3s ease-in-out;
            font-size: 1.1rem;
        }

        .dark-mode #login-btn {
            /* GÜNCELLENDİ: Yazı rengi SİYAH olarak ayarlandı */
            color: var(--sidebar-bg); /* Siyah/Koyu Gri Yazı */
        }
        .light-mode #login-btn {
            /* GÜNCELLENDİ: Yazı rengi SİYAH olarak ayarlandı */
            color: var(--sidebar-bg);
        }
        #login-btn:hover {
            background-color: color-mix(in srgb, #AEAEAE 85%, black);
        }

        /* --- YENİ: TÜM KATLANMIŞ STİLLER --- */
        .sidebar.collapsed .chat-history {
            margin-top: 0;
        }
        .sidebar.collapsed .chat-item-title,
        .sidebar.collapsed .chat-item-menu-btn,
        .sidebar.collapsed #current-mode-display {
            display: none;
        }
        .sidebar.collapsed .chat-item {
            justify-content: center;
            padding: 10px 12px;
        }
        .sidebar.collapsed .sidebar-footer {
            padding-top: 12px;
        }
        /* Katlanmış Login Butonu */
        .sidebar.collapsed #login-btn {
            width: 44px; /* DÜZELTME: Boyut */
            height: 44px;
            padding: 0;
            justify-content: center;
        }
        .sidebar.collapsed #login-btn .btn-text {
            display: none;
        }
        .sidebar.collapsed #login-btn i {
            margin-right: 0;
        }

        /* DÜZELTME: Katlanmış Artı Butonu Stili */
        .sidebar.collapsed .new-chat-btn {
            width: 44px;
            height: 44px; 
            padding: 0;
            justify-content: center;
        }
        .sidebar.collapsed .new-chat-btn .btn-text {
            display: none;
        }
        .sidebar.collapsed .new-chat-btn i {
            margin-right: 0;
        }
        /* --- KATLANMIŞ STİLLER SONU --- */


        
        /* Token Göstergesi */
        #token-display {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 20;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            color: var(--text-secondary);
            font-weight: 700;
            border-radius: 8px;
            font-size: 0.85rem;
            transition: opacity 0.3s ease-in-out;
        }
        /* YENİ: Token göstergesi sidebar katlanınca gizlensin */
        .sidebar.collapsed ~ .chat-area #token-display {
            opacity: 0;
            pointer-events: none;
        }

        #token-symbol {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 0.7rem;
            background-color: var(--highlight-color);
            color: white;
        }
        .dark-mode #token-symbol { color: #1A1A1A; }
        
        .messages-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            scroll-behavior: smooth;
            padding-top: 70px; 
            padding-bottom: 120px;
        }

        #scroll-to-bottom-btn {
            display: none;
            position: absolute;
            bottom: 130px; 
            right: 30px;
            z-index: 20;
            background-color: var(--input-bg);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            box-shadow: 0 4px 10px var(--shadow-color);
            transition: all 0.2s;
            cursor: pointer;
        }
        #scroll-to-bottom-btn:hover {
            color: var(--text-primary);
            background-color: var(--btn-hover);
        }


        /* Mesaj Balonları */
        .message-row { display: flex; margin-bottom: 24px; max-width: 90%; }
        .message-content {
            padding: 14px 20px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap;
            position: relative;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        .ai-message-row { justify-content: flex-start; }
        .ai-message-row .message-content {
            background-color: var(--ai-message-bg);
            border-top-left-radius: 5px;
            color: var(--text-primary);
        }

        .user-message-row { justify-content: flex-end; margin-left: auto; }
        .user-message-row .message-content {
            background-color: var(--user-message-bg);
            color: var(--text-primary); 
            border-top-right-radius: 5px;
        }
        .light-mode .user-message-row .message-content {
             color: #202123;
        }
        .dark-mode .user-message-row .message-content {
             color: var(--text-primary);
        }
        
        .system-message-row { justify-content: center; max-width: 100%; }
        .system-message-row .message-content {
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
            text-align: center;
            box-shadow: none;
        }
        .system-message-row .error {
            color: #FF6B6B;
            font-weight: 500;
        }

        .image-container {
            max-width: 400px;
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--input-border);
        }
        .image-container img { width: 100%; height: auto; display: block; }
        
        .attachment-preview {
            display: none;
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            padding: 8px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            box-shadow: 0 -4px 15px var(--shadow-color);
            max-width: 300px;
        }
        .attachment-preview img {
            max-height: 150px;
            width: auto;
            border-radius: 8px;
        }
        .attachment-preview .remove-attachment {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #FF6B6B;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Girdi Kutusu (Input Area) */
        .input-area-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: linear-gradient(to top, var(--bg-primary) 70%, transparent);
            pointer-events: none;
        }
        .input-area {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color);
            pointer-events: auto;
        }
        
        .input-area textarea {
            flex-grow: 1;
            padding: 10px 8px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            resize: none;
            max-height: 150px;
            overflow-y: auto;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .input-area textarea:disabled {
            background-color: transparent;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .icon-btn:hover:not(:disabled) {
            color: var(--text-primary);
            background-color: var(--btn-hover);
        }
        .icon-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        #speech-to-text-btn.recording {
            color: #FF6B6B;
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .send-btn {
            background-color: var(--highlight-color);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin-left: 8px;
            font-weight: 700;
        }
        .dark-mode .send-btn {
            color: #1A1A1A;
        }
        .send-btn:disabled {
            background-color: var(--text-secondary);
            opacity: 0.6;
        }
        .send-btn:not(:disabled):hover {
             background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }

        /* AI Yazma Animasyonu */
        .ai-typing-indicator {
            display: none; 
            align-items: center;
            height: 20px;
            margin: 5px 0 15px 0;
        }
        .ai-typing-indicator.visible { display: flex; }
        .dot {
            width: 8px; height: 8px; background-color: var(--highlight-color); border-radius: 50%;
            margin-right: 5px; animation: bounce 0.8s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.1s; }
        .dot:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Modal Stilleri */
        .modal { z-index: 50; }
        .modal-overlay {
            backdrop-filter: blur(5px);
            transition: opacity 0.3s;
        }
        .modal-content {
            background-color: var(--modal-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid var(--input-border);
        }
        .modal input, .modal select {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .social-btn {
            border: 1px solid var(--btn-border);
            transition: background-color 0.2s;
        }
        .social-btn:hover { background-color: var(--btn-hover); }
        .light-mode .social-btn:hover { background-color: #E0E0E0; }

        /* Responsive Tasarım */
        @media (max-width: 768px) {
            /* YENİ: Mobil için sidebar'ı gizle, içeriği tam ekran yap */
            .sidebar {
                left: -280px; /* Kapalı */
                transition: left 0.3s ease-in-out;
            }
            .sidebar.open {
                left: 0; /* Açık */
            }
            .chat-area {
                margin-left: 0; /* Mobil tam ekran */
                width: 100%;
            }
            /* Sidebar katlıyken chat alanı ayarı (mobilde gerekmez) */
            .sidebar.collapsed + .chat-area {
                margin-left: 0;
                width: 100%;
            }
            
            /* Katlama butonu mobilde gizli */
            .toggle-sidebar-btn {
                display: none;
            }

            /* Hamburger Menü (Chat Alanına Eklenir) */
            .hamburger-btn {
                display: block; /* YENİ: Göster */
                position: absolute;
                top: 15px;
                left: 15px;
                z-index: 30;
                background-color: var(--input-bg);
                border: 1px solid var(--input-border);
                border-radius: 8px;
                padding: 8px 10px;
                box-shadow: 0 4px 10px var(--shadow-color);
            }
            /* Ekranı karartma */
            .mobile-overlay {
                position: absolute;
                inset: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 39;
                display: none;
            }
            /* DÜZELTME: Doğru overlay seçicisi */
            .sidebar.open ~ .chat-area .mobile-overlay {
                display: block;
            }

            .input-area-wrapper { padding: 12px; }
            .input-area { padding: 6px 8px; }
            .messages-container {
                padding: 10px;
                padding-top: 70px;
                padding-bottom: 100px;
            }
            .message-row { max-width: 95%; }
            
            /* YENİ: Mobilde katlanmış sidebar'ın gizlediği butonları geri getir */
            .sidebar.collapsed ~ .chat-area #plus-btn,
            .sidebar.collapsed ~ .chat-area #token-display {
                opacity: 1;
                pointer-events: auto;
            }
            #token-display {
                top: 15px;
                right: 15px;
                left: auto;
            }
            #scroll-to-bottom-btn {
                bottom: 110px;
                right: 15px;
            }
            #plus-btn {
                top: 15px;
                left: 50%;
                transform: translateX(-50%);
                right: auto;
            }
        }
        /* YENİ: Masaüstünde hamburger menüyü gizle */
        @media (min-width: 769px) {
            .hamburger-btn {
                display: none;
            }
            .mobile-overlay {
                display: none;
            }
        }
    </style>
</head>
<body class="dark-mode"> <!-- VARSAYILAN TEMA: KOYU (GRİ/BEYAZ) -->
    <div class="app-container">
        <!-- Sol Kenar Çubuğu -->
        <aside class="sidebar" id="sidebar">
            <header class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-svg">N</div>
                    <span class="logo-text">N0thingAI</span>
                </div>
            </header>

            <!-- YENİ: Sidebar Katlama Butonu -->
            <button class="toggle-sidebar-btn" id="toggle-sidebar-btn">
                <i class="fas fa-chevron-left"></i>
            </button>

            <!-- YENİ: Sohbet Arama -->
            <div class="chat-search-wrapper">
                <i class="fas fa-search"></i>
                <input type="text" id="chat-search-input" placeholder="Sohbetleri ara...">
            </div>

            <!-- DÜZELTME: İncelmiş Yeni Sohbet Butonu -->
            <!-- GÜNCELLENDİ: Yazı span içine alındı -->
            <button class="new-chat-btn" id="new-chat-btn">
                <i class="fas fa-plus"></i>
                <span class="btn-text"> Yeni Sohbet</span>
            </button>
            
            <!-- Sohbet Geçmişi -->
            <nav class="chat-history">
                <ul id="chat-history-list" class="space-y-1">
                    <li id="current-mode-display" class="text-xs px-3 py-2 rounded-lg font-semibold border" >
                        Sohbet Modu
                    </li>
                    <!-- Geçmiş buraya dinamik olarak yüklenecek -->
                </ul>
            </nav>
            
            <!-- Profil ve Ayarlar (Dinamik Auth Alanı) -->
            <footer class="sidebar-footer">
                <div id="auth-container" class="w-full">
                    
                    <!-- GÜNCELLENDİ: user-profile-view div'i TAMAMEN SİLİNDİ -->
                    
                    <!-- GÜNCELLENDİ: Bu buton artık hem giriş hem ayarlar için kullanılacak -->
                    <div id="login-view" class="">
                        <!-- GÜNCELLENDİ: İkon eklendi, metin span içine alındı -->
                        <button id="login-btn" class="w-full py-3 login-btn rounded-xl font-semibold" onclick="window.openSettingsModal()">
                            <i class="fas fa-sign-in-alt"></i>
                            <span class="btn-text"> Giriş Yap / Kayıt Ol</span>
                        </button>
                    </div>

                </div>
            </footer>
        </aside>

        <!-- Sohbet Alanı -->
        <main class="chat-area">
            <!-- Mobil Hamburger Menü Butonu (Yeri Değişti) -->
            <button class="icon-btn hamburger-btn md:hidden" id="open-sidebar-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- GÜNCELLENDİ: Plus butonu (Daha basit) -->
            <button id="plus-btn" class="">
                <i class="fas fa-star"></i> Plus
            </button>

            <!-- GÜNCELLENDİ: Token Göstergesi (Daha basit) -->
            <div id="token-display" class="">
                <span id="token-symbol">N</span>
                <span id="token-count">...</span>
            </div>

            <!-- Mobil Overlay (Sidebar açıkken) -->
            <div class="mobile-overlay md:hidden" id="mobile-overlay"></div>

            <button id="scroll-to-bottom-btn" class="items-center justify-center">
                <i class="fas fa-arrow-down"></i>
            </button>

            <div class="messages-container" id="messages-container">
                <!-- Mesajlar buraya gelecek -->
            </div>
            
            <div class="ai-typing-indicator" id="typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span id="loading-text" class="ml-2 text-sm" style="color: var(--text-secondary);"></span>
            </div>

            <div class="attachment-preview" id="attachment-preview">
                <img id="preview-image" src="" alt="Ek önizlemesi">
                <button class="remove-attachment" id="remove-attachment-btn">&times;</button>
            </div>

            <div class="input-area-wrapper">
                <div class="input-area">
                    <button class="icon-btn" id="attachment-btn" title="Dosya Ekle (Görsel Analiz)">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-input" accept="image/*" class="hidden" multiple>

                    <button class="icon-btn" id="image-mode-btn" title="Görsel Oluşturma Modu">
                        <i class="fas fa-palette"></i>
                    </button>

                    <textarea id="chat-input" placeholder="N0thingAI'a bir mesaj gönder..." rows="1"></textarea>
                    
                    <button class="icon-btn" id="speech-to-text-btn" title="Sesli Yazma">
                        <i class="fas fa-microphone"></i>
                    </button>

                    <button class="send-btn icon-btn" title="Gönder" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Ayarlar ve Giriş Modalı -->
    <div id="settings-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-md modal-content relative">
            
            <!-- GİRİŞ YAP EKRANI (Varsayılan) -->
            <div id="modal-login-view" class="">
                <h2 class="text-xl font-bold mb-4 text-center">Giriş Yap</h2>
                <p class="text-center text-sm opacity-80 mb-4" style="color: var(--text-secondary);">Ayarlarınıza erişmek için giriş yapın.</p>
                
                <p id="auth-error-message" class="text-center text-sm text-red-500 mb-4 hidden"></p>

                <div class="space-y-4">
                    <input id="email-input" type="email" placeholder="Email adresiniz" class="w-full p-3 rounded-lg border">
                    <input id="password-input" type="password" placeholder="Şifreniz" class="w-full p-3 rounded-lg border">
                    
                    <button id="email-signin-btn" class="w-full py-3 login-btn rounded-xl font-semibold" style="background-color: var(--highlight-color); color: var(--sidebar-bg);">
                        Email ile Giriş Yap
                    </button>
                    <p class="text-xs text-center" style="color: var(--text-secondary);">
                        Hesabınız yok mu? 
                        <button id="show-signup-btn" class="font-bold underline hover:opacity-100" style="color: var(--text-primary);">Yeni Hesap Oluşturun</button>
                    </p>
                </div>
            </div>

            <!-- KAYIT OL EKRANI -->
            <div id="modal-signup-view" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Yeni Hesap Oluştur</h2>
                <p id="signup-error-message" class="text-center text-sm text-red-500 mb-4 hidden"></p>

                <input id="signup-email-input" type="email" placeholder="Email adresiniz" class="w-full p-3 rounded-lg border mb-4">
                <input id="signup-password-input" type="password" placeholder="Yeni şifreniz" class="w-full p-3 rounded-lg border mb-4">
                <button id="signup-btn" class="w-full py-3 login-btn rounded-xl font-semibold" style="background-color: var(--highlight-color); color: var(--sidebar-bg);">
                    Kayıt Ol (Sign Up)
                </button>
                <p class="text-xs text-center mt-4" style="color: var(--text-secondary);">
                    Zaten bir hesabınız var mı? 
                    <button id="show-signin-btn" class="font-bold underline hover:opacity-100" style="color: var(--text-primary);">Giriş Yapın</button>
                </p>
            </div>


            <!-- Ayarlar Ekranı (Oturum Açıkken) -->
            <div id="modal-settings-view" class="hidden">
                 <h2 class="text-xl font-bold mb-6" id="modal-title-settings">Ayarlar</h2>
                 
                 <div class="mb-4">
                      <label for="language-selector" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Dil Seçimi</label>
                      <select id="language-selector" class="w-full p-3 rounded-lg border">
                          <option value="tr">Türkçe</option> 
                          <option value="en">English</option>
                      </select>
                 </div>
                 
                 <div class="mb-4">
                      <label for="theme-selector" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tema Seçimi</label>
                      <select id="theme-selector" class="w-full p-3 rounded-lg border">
                          <option value="dark-mode">Koyu Tema (Gri/Beyaz)</option> 
                          <option value="light-mode">Açık Tema (Beyaz/Gri)</option>
                      </select>
                 </div>
                 <button id="signout-btn" class="w-full p-3 mt-4 rounded-lg font-semibold border" style="border-color: var(--btn-border); transition: background-color 0.2s;">
                    <i class="fas fa-sign-out-alt mr-2"></i> Çıkış Yap
                 </button>
            </div>
            
            <button onclick="window.closeSettingsModal()" class="absolute top-4 right-4 text-xl opacity-70 hover:opacity-100" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- PREMIUM MODALI -->
    <div id="premium-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-2xl modal-content relative">
            <h2 class="text-xl font-bold mb-4 text-center">
                <i class="fas fa-star-half-alt mr-2" style="color: var(--highlight-color);"></i>
                N0thingAI Planları
            </h2>
            <p class="text-center text-sm opacity-80 mb-6" style="color: var(--text-secondary);">
                Limitlerinizi yükseltin ve N0thingAI'ı tam potansiyelinde kullanın.
            </p>
            
            <table class="w-full text-sm text-left mb-6">
                <thead style="background-color: var(--input-bg);">
                    <tr>
                        <th class="p-3 rounded-tl-lg">Özellik</th>
                        <th class="p-3 text-center">Normal</th>
                        <th class="p-3 text-center">Plus (25 TL/Ay)</th>
                        <th class="p-3 text-center">Premium (35 TL/Ay)</th>
                    </tr>
                </thead>
                <tbody style="color: var(--text-secondary);">
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold">Günlük Token</td>
                        <td class="p-3 text-center">150 Token</td>
                        <td class="p-3 text-center">500 Token</td>
                        <td class="p-3 text-center rounded-tr-lg">1000 Token</td>
                    </tr>
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold">Mesaj (10 Token)</td>
                        <td class="p-3 text-center">(~15 Mesaj)</td>
                        <td class="p-3 text-center">(~50 Mesaj)</td>
                        <td class="p-3 text-center">(~100 Mesaj)</td>
                    </tr>
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold">Görsel (20 Token)</td>
                        <td class="p-3 text-center">(~7 Görsel)</td>
                        <td class="p-3 text-center">(~25 Görsel)</td>
                        <td class="p-3 text-center">(~50 Görsel)</td>
                    </tr>
                    <tr class="border-b" style="border-color: var(--input-border);">
                        <td class="p-3 font-semibold">Dosya (15 Token)</td>
                        <td class="p-3 text-center">(~10 Dosya)</td>
                        <td class="p-3 text-center">(~33 Dosya)</td>
                        <td class="p-3 text-center">(~66 Dosya)</td>
                    </tr>
                </tbody>
            </table>

            <p class="text-xs text-center mt-4" style="color: var(--text-secondary);">
                Üyeliğinizi yükseltmek için (manuel onay): 
                <a href="mailto:n0thingaiofficial@gmail.com" class="font-bold underline" style="color: var(--highlight-color);">n0thingaiofficial@gmail.com</a>
            </p>
            
            <button onclick="window.closePremiumModal()" class="absolute top-4 right-4 text-xl opacity-70 hover:opacity-100" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- GÖRSEL DÜZENLEYİCİ MODALI -->
    <div id="image-editor-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-4 rounded-xl shadow-2xl w-full max-w-lg modal-content relative">
             <h2 class="text-lg font-bold mb-4">Görseli Onayla</h2>
             <div id="editor-container" class="relative w-full h-96 overflow-auto mb-4 border border-gray-700 rounded-lg flex items-center justify-center" style="background-color: var(--input-bg);">
                 <img id="editor-image-preview" src="" class="max-w-full max-h-full">
             </div>
             <p class="text-xs text-center mb-4" style="color: var(--text-secondary);">
                 (Görsel düzenleme araçları yakında eklenecektir)
             </p>
             <div class="flex justify-end gap-4">
                 <button id="cancel-image-edit" class="py-2 px-4 rounded-lg font-semibold border" style="border-color: var(--btn-border);">İptal</button>
                 <button id="confirm-image-edit" class="py-2 px-4 rounded-lg font-semibold" style="background-color: var(--highlight-color); color: var(--sidebar-bg);">Görseli Ekle</button>
             </div>
        </div>
    </div>

    <!-- Sohbet Geçmişi İçerik Menüsü (Popover) -->
    <div id="chat-context-menu" class="hidden absolute z-50 w-48 rounded-lg shadow-xl" style="background-color: var(--modal-bg); border: 1px solid var(--input-border);">
        <button id="rename-chat-btn" class="context-menu-item w-full text-left px-4 py-2 text-sm">
            <i class="fas fa-pencil-alt w-4 mr-2"></i> Yeniden Adlandır
        </button>
        <button id="delete-chat-btn" class="context-menu-item w-full text-left px-4 py-2 text-sm text-red-500">
            <i class="fas fa-trash-alt w-4 mr-2"></i> Sohbeti Sil
        </button>
    </div>

    <!-- Sohbet Silme Onay Modalı -->
    <div id="delete-confirm-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-sm modal-content relative">
            <h2 class="text-lg font-bold mb-4">Sohbeti Sil</h2>
            <p class="text-sm mb-6" style="color: var(--text-secondary);">
                Bu sohbeti kalıcı olarak silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.
            </p>
            <div class="flex justify-end gap-4">
                <button id="cancel-delete-btn" class="py-2 px-4 rounded-lg font-semibold border" style="border-color: var(--btn-border);">İptal</button>
                <button id="confirm-delete-btn" class="py-2 px-4 rounded-lg font-semibold bg-red-600 text-white">Sil</button>
            </div>
        </div>
    </div>

    
    <script type="module">
        // Firebase ve Google API Entegrasyonu
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, 
            onAuthStateChanged, signOut,
            createUserWithEmailAndPassword,
            signInWithEmailAndPassword,
            setPersistence, browserLocalPersistence
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, setDoc, addDoc, collection, onSnapshot, 
            query, orderBy, serverTimestamp, getDoc,
            Timestamp, updateDoc, getDocs,
            deleteDoc,
            runTransaction
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // API Keys ve Modeller
        const GEMINI_API_KEY = "AIzaSyCx4u1qHGlysIGpm1Zw0YBfXlqEXJ1BlvM"; 
        const CHAT_MODEL = "gemini-2.5-flash-preview-09-2025";
        const IMAGE_GEN_MODEL = "https://image.pollinations.ai/prompt/";
        
        const firebaseConfig = {
          apiKey: "AIzaSyAUM0DoLRAUoXsAxbcJOrerJIb_vT0GhS4",
          authDomain: "n0thingai-e8f3c.firebaseapp.com",
          projectId: "n0thingai-e8f3c",
          storageBucket: "n0thingai-e8f3c.firebasestorage.app",
          messagingSenderId: "266636496490",
          appId: "1:266636496490:web:b5250f6ba01a66bf860413"
        };
        
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase başarıyla başlatıldı.");
        } catch (e) {
            console.error("Firebase başlatılamadı:", e);
            renderSystemMessage("**HATA:** Kimlik doğrulama servisi yüklenemedi.", "error");
        }
        
        // --- DOM Elements ---
        const MESSAGES_CONTAINER = document.getElementById('messages-container');
        const CHAT_INPUT = document.getElementById('chat-input');
        const SEND_BTN = document.getElementById('send-btn');
        const IMAGE_MODE_BTN = document.getElementById('image-mode-btn');
        const NEW_CHAT_BTN = document.getElementById('new-chat-btn');
        const CURRENT_MODE_DISPLAY = document.getElementById('current-mode-display');
        const TYPING_INDICATOR = document.getElementById('typing-indicator');
        const LOADING_TEXT = document.getElementById('loading-text');
        
        const CHAT_HISTORY_LIST = document.getElementById('chat-history-list');
        const CHAT_SEARCH_INPUT = document.getElementById('chat-search-input');

        // Attachment (Görsel Yükleme) Elements
        const ATTACHMENT_BTN = document.getElementById('attachment-btn');
        const FILE_INPUT = document.getElementById('file-input');
        const ATTACHMENT_PREVIEW = document.getElementById('attachment-preview');
        const PREVIEW_IMAGE = document.getElementById('preview-image');
        const REMOVE_ATTACHMENT_BTN = document.getElementById('remove-attachment-btn');
        
        // Auth/Modal Elements
        const AUTH_CONTAINER = document.getElementById('auth-container');
        const LOGIN_VIEW = document.getElementById('login-view'); 
        
        const SETTINGS_MODAL = document.getElementById('settings-modal');
        const MODAL_LOGIN_VIEW = document.getElementById('modal-login-view');
        const MODAL_SIGNUP_VIEW = document.getElementById('modal-signup-view');
        const MODAL_SETTINGS_VIEW = document.getElementById('modal-settings-view');
        const THEME_SELECTOR = document.getElementById('theme-selector');
        
        const PREMIUM_MODAL = document.getElementById('premium-modal');
        const PLUS_BTN = document.getElementById('plus-btn');

        const AUTH_ERROR_MESSAGE = document.getElementById('auth-error-message');
        const SIGNUP_ERROR_MESSAGE = document.getElementById('signup-error-message');

        const EMAIL_INPUT = document.getElementById('email-input');
        const PASSWORD_INPUT = document.getElementById('password-input');
        const EMAIL_SIGNIN_BTN = document.getElementById('email-signin-btn');
        const SIGNUP_BTN = document.getElementById('signup-btn');
        const SIGNOUT_BTN = document.getElementById('signout-btn');
        const SHOW_SIGNUP_BTN = document.getElementById('show-signup-btn');
        const SHOW_SIGNIN_BTN = document.getElementById('show-signin-btn');
        const SIGNUP_EMAIL_INPUT = document.getElementById('signup-email-input');
        const SIGNUP_PASSWORD_INPUT = document.getElementById('signup-password-input');

        // Mobil & Katlanabilir Sidebar
        const SIDEBAR = document.getElementById('sidebar');
        const TOGGLE_SIDEBAR_BTN = document.getElementById('toggle-sidebar-btn'); // Masaüstü
        const CHAT_AREA = document.querySelector('.chat-area'); // YENİ: İçerik alanı
        const OPEN_SIDEBAR_BTN = document.getElementById('open-sidebar-btn'); // Mobil
        const MOBILE_OVERLAY = document.getElementById('mobile-overlay');
        
        const SCROLL_TO_BOTTOM_BTN = document.getElementById('scroll-to-bottom-btn');
        
        const SPEECH_TO_TEXT_BTN = document.getElementById('speech-to-text-btn');
        let recognition;
        
        const IMAGE_EDITOR_MODAL = document.getElementById('image-editor-modal');
        const EDITOR_IMAGE_PREVIEW = document.getElementById('editor-image-preview');
        const CANCEL_IMAGE_EDIT_BTN = document.getElementById('cancel-image-edit');
        const CONFIRM_IMAGE_EDIT_BTN = document.getElementById('confirm-image-edit');
        let tempImageBlob = null;
        
        const TOKEN_DISPLAY = document.getElementById('token-display');
        const TOKEN_COUNT = document.getElementById('token-count');

        // YENİ: Geçmiş Menüsü DOM
        const CHAT_CONTEXT_MENU = document.getElementById('chat-context-menu');
        const RENAME_CHAT_BTN = document.getElementById('rename-chat-btn');
        const DELETE_CHAT_BTN = document.getElementById('delete-chat-btn');
        // YENİ: Silme Modalı DOM
        const DELETE_CONFIRM_MODAL = document.getElementById('delete-confirm-modal');
        const CANCEL_DELETE_BTN = document.getElementById('cancel-delete-btn');
        const CONFIRM_DELETE_BTN = document.getElementById('confirm-delete-btn');


        // --- KOTA LİMİTLERİ (TOKEN) ---
        const QUOTAS = {
            anonymous: { tokens: 50 },
            normal: { tokens: 150 },
            plus: { tokens: 500 },
            premium: { tokens: 1000 },
            admin: { tokens: Infinity }
        };
        const COSTS = {
            message: 10,
            image: 20,
            file: 15
        };

        // --- Global State ---
        let chatMode = 'text';
        let isWaitingForResponse = false;
        let attachedImageBase64 = null;
        
        let currentUserId = null;
        let currentChatId = null;
        let unsubscribeChat = null;
        let unsubscribeHistory = null;
        
        let currentUserRole = 'anonymous';
        let dailyUsage = { tokens: 0 }; 

        // YENİ: Geçmiş menüsü için geçici ID
        let contextMenuChatId = null;

        /**
         * API Çağrısını Üstlenir (HİBRİT: Gemini ve Pollinations)
         */
        async function fetchWithRetry(model, payload, apiKey, isTitleGeneration = false) {
            let url = '';
            let headers = { 'Content-Type': 'application/json' };
            let responseType = 'json'; 
            
            let fetchOptions = {
                method: 'POST',
                headers: headers,
                body: JSON.stringify(payload)
            };

            if (model === 'gemini') {
                url = `https://generativelanguage.googleapis.com/v1beta/models/${CHAT_MODEL}:generateContent?key=${apiKey}`;
            } else if (model === 'pollinations') {
                const prompt = encodeURIComponent(payload.inputs); 
                url = `${IMAGE_GEN_MODEL}${prompt}`;
                responseType = 'blob';
                fetchOptions = { method: 'GET' };
                headers = {};
            } else {
                renderSystemMessage("Hata: Geçersiz API modeli.", "error");
                return null;
            }

            const MAX_RETRIES = isTitleGeneration ? 1 : 3;
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(url, fetchOptions);

                    if (!response.ok) {
                        if (responseType === 'blob') {
                            const errorText = await response.text();
                            throw new Error(`API Hatası (${response.status}): ${errorText}`);
                        }
                        const errorData = await response.json();
                        throw new Error(`API Hatası (${response.status}): ${errorData.error?.message || 'Bilinmeyen Hata'}`);
                    }
                    
                    if (responseType === 'json') {
                        return await response.json();
                    } else if (responseType === 'blob') {
                        return await response.blob();
                    }

                } catch (error) {
                    attempt++;
                    console.error(`API Denemesi ${attempt} başarısız:`, error);
                    if (attempt >= MAX_RETRIES) {
                        if (!isTitleGeneration) {
                            renderSystemMessage(`**HATA:** ${error.message}`, "error");
                        }
                        return null;
                    }
                }
            }
            return null;
        }

        // --- UI Helper Functions ---

        function autoScroll() {
            MESSAGES_CONTAINER.scrollTop = MESSAGES_CONTAINER.scrollHeight;
            if (SCROLL_TO_BOTTOM_BTN) SCROLL_TO_BOTTOM_BTN.style.display = 'none';
        }

        function showTypingIndicator(text = "") {
            isWaitingForResponse = true;
            toggleInput(true);
            if(LOADING_TEXT) LOADING_TEXT.textContent = text || "N0thingAI düşünüyor...";
            if(TYPING_INDICATOR) TYPING_INDICATOR.classList.add('visible');
            if(MESSAGES_CONTAINER) MESSAGES_CONTAINER.appendChild(TYPING_INDICATOR);
            autoScroll();
        }

        function hideTypingIndicator() {
            isWaitingForResponse = false;
            toggleInput(false);
            if(TYPING_INDICATOR) TYPING_INDICATOR.classList.remove('visible');
        }

        function toggleInput(disabled) {
            CHAT_INPUT.disabled = disabled;
            SEND_BTN.disabled = disabled;
            ATTACHMENT_BTN.disabled = disabled;
            IMAGE_MODE_BTN.disabled = disabled;
            if (SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.disabled = disabled;
            
            if (disabled) {
                CHAT_INPUT.placeholder = "Yanıt bekleniyor...";
            } else {
                setChatMode(chatMode, false);
            }
        }

        function renderSystemMessage(text, type = "info") {
             const systemMessageHTML = `
                 <div class="message-row system-message-row">
                     <div class="message-content ${type === 'error' ? 'error' : ''}">
                         ${text}
                     </div>
                 </div>
               `;
             MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', systemMessageHTML);
             autoScroll();
        }

        function addMessageToUI(text, sender) {
             const messageClass = sender === 'user' ? 'user-message-row' : 'ai-message-row';
             const safeText = document.createTextNode(text).textContent;
             
             const messageHTML = `
                 <div class="message-row ${messageClass}">
                     <div class="message-content">
                         ${safeText.replace(/\n/g, '<br>')}
                     </div>
                 </div>
               `;
             MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', messageHTML);
        }
        
        function addImageToUI(imageUrl, altText) {
             const imageHTML = `
                 <div class="message-row ai-message-row">
                     <div class="message-content">
                         <p class="text-sm italic mb-2" style="color: var(--text-secondary);">${altText}</p>
                         <div class="image-container">
                             <img src="${imageUrl}" alt="${altText}" loading="lazy" />
                         </div>
                     </div>
                 </div>
               `;
             MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', imageHTML);
        }
        
        // --- Core Application Logic (Firestore Eklendi) ---

        function setChatMode(mode, notify = true) {
            chatMode = mode;
            
            if (mode === 'image') {
                // GÖRSEL MODU (Pollinations)
                if(CURRENT_MODE_DISPLAY) CURRENT_MODE_DISPLAY.textContent = "Görsel Modu";
                if(CHAT_INPUT) CHAT_INPUT.placeholder = "Görsel tanımını (prompt) girin...";
                if(IMAGE_MODE_BTN) IMAGE_MODE_BTN.classList.add('text-green-500');
                if(notify) renderSystemMessage("Görsel Modu **AKTİF**. (Sohbet etmek için 'Sohbet Modu'na geçin)");
                
            } else {
                // Sohbet Modu (Gemini)
                if(CURRENT_MODE_DISPLAY) CURRENT_MODE_DISPLAY.textContent = "Sohbet Modu";
                if(CHAT_INPUT) CHAT_INPUT.placeholder = "N0thingAI'a bir mesaj gönder...";
                if(IMAGE_MODE_BTN) IMAGE_MODE_BTN.classList.remove('text-green-500');
                if(notify) {
                    const maxTokens = QUOTAS[currentUserRole]?.tokens || 0;
                    const remainingTokens = maxTokens === Infinity ? "Sınırsız" : (maxTokens - (dailyUsage.tokens || 0));
                    
                    if (!currentChatId) {
                         renderSystemMessage(`Sohbet Modu **AKTİF**. (Kalan Token: ${remainingTokens})`);
                    }
                }
            }
            autoScroll();
        }

        function toggleChatMode() {
            if (chatMode === 'text') {
                setChatMode('image', true);
            } else {
                setChatMode('text', true);
            }
        }

        async function startNewChat() {
            if (isWaitingForResponse) return;
            
            if (unsubscribeChat) unsubscribeChat();
            unsubscribeChat = null;
            currentChatId = null;
            
            MESSAGES_CONTAINER.innerHTML = '';
            removeAttachment();
            
            const maxTokens = QUOTAS[currentUserRole]?.tokens || 0;
            const remainingTokens = maxTokens === Infinity ? "Sınırsız" : (maxTokens - (dailyUsage.tokens || 0));
            renderSystemMessage(`Sohbet Modu **AKTİF**. (Kalan Token: ${remainingTokens})`);

            setChatMode('text', false);
            
            document.querySelectorAll('#chat-history-list .chat-item.active').forEach(item => {
                item.classList.remove('active');
            });

            // YENİ: Mobil sidebar açıksa kapat
            if (SIDEBAR.classList.contains('open')) {
                toggleSidebar(false);
            }
        }
        
        // --- YENİ: OTOMATİK SOHBET BAŞLIĞI OLUŞTURMA ---
        async function generateChatTitle(firstMessage) {
            if (!db || !auth.currentUser || auth.currentUser.isAnonymous || !currentChatId) return;
            
            const userId = auth.currentUser.uid;
            const chatId = currentChatId;
            
            console.log("Sohbet başlığı oluşturuluyor...");
            
            const systemInstruction = "Kullanıcının ilk mesajına bakarak bu sohbet için 3-5 kelimelik kısa bir başlık oluştur. Sadece başlığı döndür, başka hiçbir şey yazma. Örnek: 'İtalyan Mutfağı Tarifleri'";
            const payload = {
                contents: [
                    { parts: [{ text: `Kullanıcının ilk mesajı: "${firstMessage}"` }] }
                ],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY, true);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                    let title = text.trim().replace(/^['"]|['"]$/g, '');
                    title = title.substring(0, 30);
                    
                    const chatRef = doc(db, "users", userId, "chats", chatId);
                    await updateDoc(chatRef, {
                        title: title
                    });
                    console.log("Sohbet başlığı güncellendi:", title);
                }
            } catch (error) {
                console.error('Sohbet başlığı oluşturulamadı:', error);
            }
        }
        
        /**
         * Mesajları Firebase'e kaydeder
         */
        async function saveMessage(text, sender, imageUrl = null) {
            if (currentUserRole === 'anonymous') {
                if (imageUrl) addImageToUI(imageUrl, text);
                else addMessageToUI(text, sender);
                return;
            }

            const userId = auth.currentUser.uid;
            let chatToUse = currentChatId;
            let isFirstMessage = false;

            try {
                if (!chatToUse) {
                    isFirstMessage = true;
                    const chatRef = await addDoc(collection(db, "users", userId, "chats"), {
                        title: text.substring(0, 30) + "...",
                        createdAt: serverTimestamp()
                    });
                    chatToUse = chatRef.id;
                    currentChatId = chatToUse;
                    
                    listenToChat(userId, chatToUse); 
                }

                await addDoc(collection(db, "users", userId, "chats", chatToUse, "messages"), {
                    sender: sender,
                    text: text,
                    imageUrl: imageUrl || null,
                    createdAt: serverTimestamp()
                });
                
                if (isFirstMessage && sender === 'user') {
                    generateChatTitle(text); 
                }

            } catch (error) {
                console.error("Mesaj kaydedilemedi:", error);
                renderSystemMessage(`**HATA:** Mesajınız veritabanına kaydedilemedi. ${error.message}`, "error");
            }
        }
        
        // --- GÖRSEL OLUŞTURMA (Pollinations) ---
        
        /**
         * Türkçe prompt'u alıp, optimize edilmiş İngilizce prompt'a çevirir (Gemini ile)
         */
        async function translateAndOptimizePrompt(turkishPrompt) {
            showTypingIndicator("Görsel tanımı optimize ediliyor...");

            const systemInstruction = `You are a professional prompt engineer specializing in image generation (like Midjourney/DALL-E). Your task is to take the user's Turkish description and turn it into a single, detailed, highly descriptive English prompt, optimized for quality image output. 
            Do not add any conversational text, just the prompt.`;

            const payload = {
                contents: [{ parts: [{ text: `Translate and optimize this Turkish prompt for image generation: ${turkishPrompt}` }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY, true);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                     return text.trim().replace(/^['"]|['"]$/g, '');
                }
                return turkishPrompt;
            } catch (error) {
                console.error('Prompt Çeviri/Optimizasyon Hatası:', error);
                return turkishPrompt; 
            }
        }
        
        /**
         * Pollinations kullanarak görsel oluşturur
         */
        async function generateImage(userPrompt) {
            const optimizedPrompt = await translateAndOptimizePrompt(userPrompt);

            showTypingIndicator(`Görsel oluşturuluyor: "${optimizedPrompt.substring(0, 40)}..."`);
            
            const payload = { 
                inputs: optimizedPrompt
            };

            let generatedBase64 = null;
            let aiMessage = "Görsel oluşturma başarısız oldu. Lütfen daha açıklayıcı bir tanım deneyin.";

            try {
                const imageBlob = await fetchWithRetry('pollinations', payload, null);
                
                if (imageBlob && imageBlob.size > 0) {
                    generatedBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(imageBlob);
                    });
                } else if (imageBlob) {
                    aiMessage = "API'den görsel alınamadı, ancak hata da dönmedi. Lütfen tekrar deneyin.";
                    await saveMessage(aiMessage, 'ai');
                }

            } catch (error) {
                console.error('Görsel API Çağrısı Hatası:', error);
            } finally {
                hideTypingIndicator();
                
                if (generatedBase64) {
                    await saveMessage(optimizedPrompt, 'ai', generatedBase64);
                }
            }
        }
        
        /**
         * Kullanıcı mesajını ve (varsa) görseli AI'ye gönderir (Gemini Sohbet)
         */
        async function fetchGeminiResponse(userPrompt) {
            showTypingIndicator("N0thingAI düşünüyor...");
            
            let parts = [{ "text": userPrompt }];
            
            if (attachedImageBase64) {
                parts.unshift({
                    "inline_data": {
                        "mime_type": "image/jpeg",
                        "data": attachedImageBase64
                    }
                });
            }

            let history = [];
            if (currentUserId && currentChatId && !auth.currentUser.isAnonymous) {
                try {
                    const messagesRef = collection(db, "users", currentUserId, "chats", currentChatId, "messages");
                    const q = query(messagesRef, orderBy("createdAt", "desc"));
                    const historySnapshot = await getDocs(q);
                    
                    let tempHistory = [];
                    historySnapshot.forEach(doc => {
                        const msg = doc.data();
                        if (msg.text && !msg.imageUrl) {
                             tempHistory.push({
                                 role: msg.sender === 'user' ? 'user' : 'model',
                                 parts: [{ text: msg.text }]
                             });
                        }
                    });
                    
                    history = tempHistory.reverse().slice(-10);
                    
                } catch (e) {
                    console.error("Hafıza yüklenirken hata:", e);
                }
            }

            const payload = {
                "contents": [
                    ...history,
                    { "role": "user", "parts": parts }
                ],
            };

            let responseText = "Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.";

            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY);
                
                if (result && result.candidates && result.candidates[0].content) {
                    responseText = result.candidates[0].content.parts[0].text;
                } else {
                    responseText = "API'den geçerli bir yanıt alınamadı.";
                }

            } catch (error) {
                console.error("Gemini Hatası:", error);
                responseText = `Hata: ${error.message}`;
            } finally {
                hideTypingIndicator();
                removeAttachment();
                await saveMessage(responseText, 'ai');
            }
        }
        
        // --- YENİ: GÜNLÜK KOTA KONTROLÜ (TOKEN) ---
        
        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        function updateTokenDisplay(used, total) {
            if (!TOKEN_COUNT || !TOKEN_DISPLAY) return;
            
            TOKEN_DISPLAY.style.display = 'flex';
            
            if (total === Infinity) {
                TOKEN_COUNT.textContent = `Sınırsız Token`;
            } else {
                TOKEN_COUNT.textContent = `${total - used} / ${total} Token`;
            }
        }

        async function checkUsageLimit(userId, actionCost) {
            if (!db || !userId) return false;

            const profileRef = doc(db, "users", userId, "chats", "--profile--");
            const profileDoc = await getDoc(profileRef);
            
            const role = currentUserRole; 
            const maxTokens = QUOTAS[role]?.tokens || 0;

            if (maxTokens === Infinity) {
                updateTokenDisplay(0, Infinity);
                return true;
            }

            let currentTokens = 0;
            const profileData = profileDoc.exists() ? profileDoc.data() : {};

            if (role === 'anonymous') {
                // --- ANONİM LİMİT KONTROLÜ (Kümülatif) ---
                currentTokens = profileData.tokens || 0;
                
                if (currentTokens + actionCost > maxTokens) {
                    renderSystemMessage(`Tek seferlik 50 token limitinize ulaştınız (${currentTokens}/${maxTokens}). Lütfen giriş yapın veya Plus'a geçin.`, "error");
                    window.openSettingsModal();
                    updateTokenDisplay(currentTokens, maxTokens);
                    return false;
                }

                const newTotalTokens = currentTokens + actionCost;
                await setDoc(profileRef, { ...profileData, tokens: newTotalTokens, role: 'anonymous' }, { merge: true });
                dailyUsage = { tokens: newTotalTokens };
                updateTokenDisplay(newTotalTokens, maxTokens);
                return true;

            } else {
                // --- GİRİŞLİ LİMİT KONTROLÜ (Günlük) ---
                const todayStr = getTodayDateString();
                
                if (profileData.date === todayStr) {
                    currentTokens = profileData.tokens || 0;
                }

                if (currentTokens + actionCost > maxTokens) {
                    renderSystemMessage(`Günlük token limitinize ulaştınız (${currentTokens}/${maxTokens}). Bu eylem ${actionCost} token gerektiriyor. Lütfen yarın tekrar deneyin veya N0thingAI Plus'a geçin.`, "error");
                    window.openPremiumModal();
                    updateTokenDisplay(currentTokens, maxTokens);
                    return false;
                }

                const newDailyTokens = currentTokens + actionCost;
                await setDoc(profileRef, { 
                    ...profileData,
                    tokens: newDailyTokens, 
                    date: todayStr,
                    role: role
                }, { merge: true });
                dailyUsage = { tokens: newDailyTokens };
                updateTokenDisplay(newDailyTokens, maxTokens);
                return true;
            }
        }


        async function sendMessage() {
            const text = CHAT_INPUT.value.trim();
            if (text === "" && !attachedImageBase64) return;
            
            if (!auth || !auth.currentUser) {
                renderSystemMessage("Mesaj göndermek için lütfen giriş yapın.", "error");
                window.openSettingsModal();
                return;
            }
            
            const userId = auth.currentUser.uid;
            
            let actionCost = COSTS.message;
            if (chatMode === 'image') actionCost = COSTS.image;
            if (attachedImageBase64) actionCost = COSTS.file; 

            // --- LİMİT KONTROLÜ ---
            const allowed = await checkUsageLimit(userId, actionCost);
            if (!allowed) {
                return;
            }
            // --- LİMİT KONTROLÜ SONU ---

            let messageToSave = text;
            if (attachedImageBase64 && text === "") {
                messageToSave = "(Görsel eklendi)";
            }
            await saveMessage(messageToSave, 'user');

            CHAT_INPUT.value = '';
            autoResizeTextarea();

            if (chatMode === 'image') {
                await generateImage(text);
            } else {
                await fetchGeminiResponse(text);
            }
        }

        function handleKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }
        
        // --- Attachment (Görsel Yükleme) Fonksiyonları ---

        async function handleFileSelect(event) {
            const files = event.target.files;
            if (!files || files.length === 0) return;
            
            if (!auth || !auth.currentUser) {
                renderSystemMessage("Dosya yüklemek için lütfen giriş yapın.", "error");
                window.openSettingsModal();
                return;
            }
            
            if (auth.currentUser.isAnonymous) {
                renderSystemMessage("Dosya yüklemek için lütfen giriş yapın.", "error");
                window.openSettingsModal();
                return;
            } 

            const file = files[0];

            if (!file.type.startsWith('image/')) {
                renderSystemMessage("Hata: Yalnızca resim dosyaları yüklenebilir.", "error");
                return;
            }

            if (files.length === 1) {
                openImageEditor(file);
            } else {
                const reader = new FileReader();
                reader.onload = (e) => {
                    attachedImageBase64 = e.target.result.split(',')[1]; 
                    PREVIEW_IMAGE.src = e.target.result;
                    ATTACHMENT_PREVIEW.style.display = 'block';
                    ATTACHMENT_BTN.classList.add('text-green-500');
                    if (chatMode === 'image') setChatMode('text', false);
                    CHAT_INPUT.placeholder = "Görsel hakkında bir soru sorun...";
                    
                    renderSystemMessage(`Şu anda sadece 1 görsel yüklenebilir. İlk görsel ('${file.name}') seçildi.`, "info");
                };
                reader.readAsDataURL(file);
            }
            
            event.target.value = null;
        }
        
        function openImageEditor(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                EDITOR_IMAGE_PREVIEW.src = e.target.result;
                tempImageBlob = e.target.result;
                IMAGE_EDITOR_MODAL.classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        }

        function closeImageEditor() {
            IMAGE_EDITOR_MODAL.classList.add('hidden');
            tempImageBlob = null;
            EDITOR_IMAGE_PREVIEW.src = '';
        }
        
        function confirmImageEdit() {
            if (!tempImageBlob) return;
            
            attachedImageBase64 = tempImageBlob.split(',')[1];
            PREVIEW_IMAGE.src = tempImageBlob;
            ATTACHMENT_PREVIEW.style.display = 'block';
            ATTACHMENT_BTN.classList.add('text-green-500');
            
            if (chatMode === 'image') {
                setChatMode('text', false);
            }
            CHAT_INPUT.placeholder = "Görsel hakkında bir soru sorun...";
            
            closeImageEditor();
        }

        function removeAttachment() {
            attachedImageBase64 = null;
            if (ATTACHMENT_PREVIEW) ATTACHMENT_PREVIEW.style.display = 'none';
            if (PREVIEW_IMAGE) PREVIEW_IMAGE.src = '';
            if (ATTACHMENT_BTN) ATTACHMENT_BTN.classList.remove('text-green-500');
            setChatMode(chatMode, false);
        }

        function autoResizeTextarea() {
            CHAT_INPUT.style.height = 'auto';
            CHAT_INPUT.style.height = (CHAT_INPUT.scrollHeight) + 'px';
        }

        
        // --- Auth Functions (Global Scope'a Taşıma) ---
        
        window.openSettingsModal = () => {
            if (!SETTINGS_MODAL || !MODAL_SETTINGS_VIEW || !MODAL_LOGIN_VIEW) {
                console.error("Modal elementleri bulunamadı.");
                return;
            }
            if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden');
            if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden');
            
            SETTINGS_MODAL.classList.remove('hidden');
            
            if (auth && auth.currentUser && !auth.currentUser.isAnonymous) {
                MODAL_LOGIN_VIEW.classList.add('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                MODAL_SETTINGS_VIEW.classList.remove('hidden');
            } else {
                MODAL_LOGIN_VIEW.classList.remove('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                MODAL_SETTINGS_VIEW.classList.add('hidden');
            }
            
            updateThemeSpecificElements();
        };

        window.closeSettingsModal = () => {
            if (SETTINGS_MODAL) SETTINGS_MODAL.classList.add('hidden');
        };
        
        window.openPremiumModal = () => {
            if (PREMIUM_MODAL) PREMIUM_MODAL.classList.remove('hidden');
        };
        window.closePremiumModal = () => {
            if (PREMIUM_MODAL) PREMIUM_MODAL.classList.add('hidden');
        };
        
        function renderAuthError(error, view = 'login') {
            let errorMessage = "Bilinmeyen bir hata oluştu.";
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                errorMessage = "Girdiğiniz e-posta veya şifre yanlış.";
            } else if (error.code === 'auth/email-already-in-use') {
                errorMessage = "Bu e-posta adresi zaten kayıtlı.";
            } else if (error.code === 'auth/weak-password') {
                errorMessage = "Şifre en az 6 karakter olmalıdır.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "Geçersiz e-posta adresi formatı.";
            } else if (error.code === 'auth/configuration-not-found') {
                errorMessage = "Giriş yöntemi (Email) Firebase'de etkin değil.";
            } else {
                errorMessage = error.message;
            }

            if (view === 'login' && AUTH_ERROR_MESSAGE) {
                AUTH_ERROR_MESSAGE.textContent = errorMessage;
                AUTH_ERROR_MESSAGE.classList.remove('hidden');
            } else if (view === 'signup' && SIGNUP_ERROR_MESSAGE) {
                SIGNUP_ERROR_MESSAGE.textContent = errorMessage;
                SIGNUP_ERROR_MESSAGE.classList.remove('hidden');
            } else {
                renderSystemMessage(`**Giriş Hatası:** ${errorMessage}`, "error");
            }
        }


        async function signInWithEmail() {
            if (!auth) return;
            try {
                const email = EMAIL_INPUT.value;
                const password = PASSWORD_INPUT.value;
                if (!email || !password) {
                    renderAuthError({ code: 'auth/missing-fields', message: "Email ve şifre alanları boş bırakılamaz." }, 'login');
                    return;
                }
                await signInWithEmailAndPassword(auth, email, password);
                window.closeSettingsModal();
            } catch (error) {
                console.error("Email Giriş Hatası:", error);
                renderAuthError(error, "login");
            }
        }

        async function signUpWithEmail() {
            if (!auth) return;
            try {
                const email = SIGNUP_EMAIL_INPUT.value;
                const password = SIGNUP_PASSWORD_INPUT.value;
                if (!email || !password) {
                    renderAuthError({ code: 'auth/missing-fields', message: "Email ve şifre alanları boş bırakılamaz." }, 'signup');
                    return;
                }
                if (password.length < 6) {
                    renderAuthError({ code: 'auth/weak-password' }, 'signup');
                    return;
                }
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                if (userCredential.user && db) {
                    const userId = userCredential.user.uid;
                    
                    const profileRef = doc(db, "users", userId, "chats", "--profile--");
                    await setDoc(profileRef, {
                        email: userCredential.user.email,
                        role: "normal",
                        date: getTodayDateString(),
                        tokens: 0,
                    });
                }
                
                window.closeSettingsModal();
                renderSystemMessage("**Başarılı:** Kayıt oldunuz ve giriş yaptınız.");
            } catch (error) {
                console.error("Email Kayıt Hatası:", error);
                renderAuthError(error, "signup");
            }
        }


        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                window.closeSettingsModal();
                renderSystemMessage("Başarıyla çıkış yaptınız.");
            } catch (error) {
                 console.error("Çıkış Hatası:", error);
            }
        }
        
        
        // --- YENİ: Sohbet ve Geçmiş Dinleyicileri ---
        
        /**
         * Belirli bir sohbetin mesajlarını dinler
         */
        function listenToChat(userId, chatId) {
            if (!db) return;
            if (unsubscribeChat) unsubscribeChat();

            currentChatId = chatId;
            MESSAGES_CONTAINER.innerHTML = '';

            const messagesQuery = query(
                collection(db, "users", userId, "chats", chatId, "messages"),
                orderBy("createdAt", "asc")
            );

            unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
                MESSAGES_CONTAINER.innerHTML = ''; 
                if (snapshot.empty) {
                    // Boşsa bir şey yapma (startNewChat hallediyor)
                }
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    if (msg.imageUrl && msg.sender === 'ai') {
                        const imageUrl = msg.imageUrl;
                        addImageToUI(imageUrl, `Görsel tanımı: "${msg.text}"`);
                    } else {
                        addMessageToUI(msg.text, msg.sender);
                    }
                });
                autoScroll();
            }, (error) => {
                console.error("Sohbet dinlenirken hata:", error);
                renderSystemMessage(`**HATA:** Sohbet yüklenemedi. ${error.message}`, "error");
            });
        }
        
        /**
         * Kullanıcının sohbet listesini dinler (Sidebar için)
         */
        function listenToChatHistory(userId) {
            if (!db) return;
            if (unsubscribeHistory) unsubscribeHistory();

            const historyQuery = query(
                collection(db, "users", userId, "chats"),
                orderBy("createdAt", "desc")
            );

            unsubscribeHistory = onSnapshot(historyQuery, (snapshot) => {
                const currentChatItems = new Set(); // YENİ: Mevcut ID'leri takip et
                
                // Önce Mod Göstergesini bul
                const modeDisplay = document.getElementById('current-mode-display');

                // Mod göstergesi dışındaki tüm .chat-item'ları DOM'dan kaldır
                document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                    if (item.id !== 'current-mode-display') {
                        item.remove();
                    }
                });

                snapshot.forEach(doc => {
                    const chat = doc.data();
                    const chatId = doc.id;
                    
                    if (chatId === '--profile--') return; 

                    currentChatItems.add(chatId); // ID'yi sete ekle
                    
                    // DOM'da bu ID'ye sahip bir öğe var mı? (Optimize etmek için)
                    let li = document.querySelector(`.chat-item[data-chat-id="${chatId}"]`);
                    
                    if (!li) {
                        // Yoksa oluştur
                        li = document.createElement('li');
                        li.className = 'chat-item';
                        li.dataset.chatId = chatId;

                        // YENİ: İçeriği (Başlık ve Menü Butonu) oluştur
                        li.innerHTML = `
                            <span class="chat-item-title"></span>
                            <button class="chat-item-menu-btn">
                                <i class="fas fa-ellipsis-h"></i>
                            </button>
                        `;

                        // Mod göstergesinden sonra ekle
                        modeDisplay.insertAdjacentElement('afterend', li);

                        // Olayları ata
                        li.querySelector('.chat-item-title').onclick = () => {
                            if (isWaitingForResponse) return; // Yanıt bekleniyorsa geçiş yapma
                            
                            document.querySelectorAll('#chat-history-list .chat-item.active').forEach(item => {
                                item.classList.remove('active');
                            });
                            li.classList.add('active');
                            
                            listenToChat(userId, chatId);

                            // YENİ: Mobil sidebar açıksa kapat
                            if (SIDEBAR.classList.contains('open')) {
                                toggleSidebar(false);
                            }
                        };
                        
                        li.querySelector('.chat-item-menu-btn').onclick = (e) => {
                            e.stopPropagation(); // li'nin tıklanmasını engelle
                            openChatContextMenu(e, chatId);
                        };
                    }

                    // Başlığı güncelle (her zaman)
                    li.querySelector('.chat-item-title').textContent = chat.title || "Yeni Sohbet";
                    
                    // Aktif stili ayarla
                    if (chatId === currentChatId) {
                        li.classList.add('active');
                    } else {
                        li.classList.remove('active');
                    }
                });
            }, (error) => {
                console.error("Geçmiş listesi dinlenirken hata:", error);
            });
        }


        /**
         * Auth durumunu dinler ve UI'ı günceller
         */
        async function setupAuthListener() {
            if (!auth) {
                console.log("Firebase Auth bulunamadı, giriş yapılamaz.");
                if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                startNewChat();
                renderSystemMessage("Kimlik doğrulama hizmeti yüklenemedi. Lütfen giriş yapmayı denemeyin.", "error");
                return;
            }
            
            await setPersistence(auth, browserLocalPersistence);
            
            // Buton içeriğini değiştirmek için referanslar
            const loginBtn = document.getElementById('login-btn');
            const loginBtnIcon = loginBtn.querySelector('i');
            const loginBtnText = loginBtn.querySelector('.btn-text');

            onAuthStateChanged(auth, async (user) => {
                
                if (unsubscribeChat) unsubscribeChat();
                if (unsubscribeHistory) unsubscribeHistory();
                unsubscribeChat = null;
                unsubscribeHistory = null;
                dailyUsage = {};
                
                if (user) {
                    console.log("Auth durumu değişti. Kullanıcı:", user.uid, "Anonim mi:", user.isAnonymous);
                    currentUserId = user.uid;
                    const profileRef = doc(db, "users", user.uid, "chats", "--profile--");
                    const profileDoc = await getDoc(profileRef);

                    if (user.isAnonymous) {
                        // --- ANONİM KULLANICI ---
                        currentUserRole = 'anonymous';
                        if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden'); 
                        if(loginBtnIcon) loginBtnIcon.className = 'fas fa-sign-in-alt';
                        if(loginBtnText) loginBtnText.textContent = ' Giriş Yap / Kayıt Ol';
                        
                        if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');
                        
                        document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                            if (item.id !== 'current-mode-display') item.remove();
                        });

                        let currentTokens = 0;
                        if (profileDoc.exists()) {
                            currentTokens = profileDoc.data().tokens || 0; 
                        } else {
                            await setDoc(profileRef, {
                                email: "anonymous",
                                role: "anonymous",
                                tokens: 0
                            });
                        }
                        dailyUsage = { tokens: currentTokens };
                        const maxTokens = QUOTAS.anonymous.tokens;
                        updateTokenDisplay(dailyUsage.tokens, maxTokens);

                    } else {
                        // --- GİRİŞ YAPMIŞ KULLANICI ---
                        if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                        if(loginBtnIcon) loginBtnIcon.className = 'fas fa-cog'; // İkonu değiştir
                        if(loginBtnText) loginBtnText.textContent = user.email || 'Ayarlar'; // E-postayı yaz

                        let role = 'normal';
                        let currentTokens = 0;
                        const todayStr = getTodayDateString();

                        if (profileDoc.exists()) {
                            const data = profileDoc.data();
                            let dbRole = data.role;
                            if (!dbRole) {
                                dbRole = 'normal';
                            }
                            role = dbRole.toLowerCase();

                            if (data.date === todayStr) {
                                currentTokens = data.tokens || 0;
                            }
                        } else {
                            role = 'normal';
                            currentTokens = 0;
                            
                            await setDoc(profileRef, {
                                email: user.email,
                                role: "normal",
                                date: todayStr,
                                tokens: 0
                            });
                        }
                        
                        currentUserRole = role;
                        dailyUsage = { tokens: currentTokens };
                        
                        const roleQuota = QUOTAS[role];
                        const maxTokens = (roleQuota ? roleQuota.tokens : 0) || 0;

                        updateTokenDisplay(dailyUsage.tokens, maxTokens);

                        if (role === 'plus' || role === 'premium' || role === 'admin') {
                            if (PLUS_BTN) PLUS_BTN.classList.add('hidden');
                        } else {
                            if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');
                        }

                        listenToChatHistory(user.uid);
                    }

                    await startNewChat(); 

                } else {
                    // --- KULLANICI ÇIKIŞ YAPTI (null) ---
                    console.log("Kullanıcı oturumu kapalı (null).");
                    currentUserId = null;
                    currentUserRole = 'anonymous';
                    
                    if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                    if(loginBtnIcon) loginBtnIcon.className = 'fas fa-sign-in-alt';
                    if(loginBtnText) loginBtnText.textContent = ' Giriş Yap / Kayıt Ol';

                    if (TOKEN_DISPLAY) TOKEN_DISPLAY.style.display = 'none';
                    if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');

                    document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                         if (item.id !== 'current-mode-display') item.remove();
                    });

                    try {
                        await signInAnonymously(auth);
                        console.log("Çıkış yapıldı, anonim olarak tekrar giriş yapıldı.");
                    } catch (error) {
                        console.error("Anonim giriş hatası (çıkış sonrası):", error);
                        renderSystemMessage(`**Kritik Hata:** Anonim oturum başlatılamadı. ${error.message}.`, "error");
                    }
                }
                
                updateThemeSpecificElements();
            });
        }
        
        // --- Tema Fonksiyonları ---

        function applyTheme(themeName) {
            document.body.className = themeName;
            localStorage.setItem('n0thingai_theme', themeName);
            updateThemeSpecificElements();
        }

        function updateThemeSpecificElements() {
            const theme = localStorage.getItem('n0thingai_theme') || 'dark-mode';
            const logoSvg = document.querySelector('.logo-svg');
            if (logoSvg) {
                if (theme === 'light-mode') {
                    logoSvg.style.color = '#FFFFFF';
                } else {
                    logoSvg.style.color = '#FFFFFF';
                }
            }
            
            // Modal stillerini güncelle (Modal açıksa)
            const inputs = document.querySelectorAll('.modal input, .modal select');
            inputs.forEach(input => {
                input.style.backgroundColor = getComputedStyle(document.documentElement).getPropertyValue('--input-bg');
                input.style.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary');
                input.style.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--input-border');
            });
        }

        // --- Sidebar (Katlanabilir & Mobil) ---
        function toggleSidebar(open) {
            // 'open' parametresi sadece mobil için kullanılır
            // Masaüstü için 'collapsed' sınıfını tersine çevir
            if (window.innerWidth > 768) {
                SIDEBAR.classList.toggle('collapsed');
                // YENİ: Durumu kaydet
                localStorage.setItem('sidebar_collapsed', SIDEBAR.classList.contains('collapsed'));
            } else {
                // Mobil
                if (open) {
                    SIDEBAR.classList.add('open');
                    MOBILE_OVERLAY.style.display = 'block';
                } else {
                    SIDEBAR.classList.remove('open');
                    MOBILE_OVERLAY.style.display = 'none';
                }
            }
        }
        
        // --- YENİ: Sesli Yazma Fonksiyonları ---
        function setupSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognition) {
                SPEECH_TO_TEXT_BTN.disabled = true;
                SPEECH_TO_TEXT_BTN.title = "Tarayıcınız ses tanımayı desteklemiyor.";
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = 'tr-TR';
            recognition.interimResults = true;

            recognition.onstart = () => {
                SPEECH_TO_TEXT_BTN.classList.add('recording');
                CHAT_INPUT.placeholder = "Dinleniyor...";
            };

            recognition.onresult = (event) => {
                const transcript = Array.from(event.results)
                    .map(result => result[0])
                    .map(result => result.transcript)
                    .join('');
                
                CHAT_INPUT.value = transcript;
                autoResizeTextarea();
            };

            recognition.onerror = (event) => {
                console.error("Ses tanıma hatası:", event.error);
                if (event.error === 'not-allowed') {
                    renderSystemMessage("Mikrofon izni vermediniz.", "error");
                }
            };

            recognition.onend = () => {
                SPEECH_TO_TEXT_BTN.classList.remove('recording');
                setChatMode(chatMode, false);
            };
        }

        function toggleSpeechRecognition() {
            if (!recognition) return;
            
            if (SPEECH_TO_TEXT_BTN.classList.contains('recording')) {
                recognition.stop();
            } else {
                try {
                    recognition.start();
                } catch(e) {
                    console.error("Ses tanıma başlatılamadı:", e);
                }
            }
        }

        // --- YENİ: Sohbet Geçmişi Menü Fonksiyonları ---

        function openChatContextMenu(event, chatId) {
            contextMenuChatId = chatId; // ID'yi global'e kaydet
            
            // Menüyü tıklanan yere konumlandır
            CHAT_CONTEXT_MENU.style.left = `${event.pageX}px`;
            CHAT_CONTEXT_MENU.style.top = `${event.pageY}px`;
            CHAT_CONTEXT_MENU.classList.remove('hidden');

            // Dışarı tıklamayı dinle
            document.addEventListener('click', closeChatContextMenu, { once: true });
        }

        function closeChatContextMenu() {
            CHAT_CONTEXT_MENU.classList.add('hidden');
            contextMenuChatId = null;
        }

        async function renameChat() {
            if (!contextMenuChatId || !currentUserId) return;
            
            const chatRef = doc(db, "users", currentUserId, "chats", contextMenuChatId);
            const chatDoc = await getDoc(chatRef);
            const currentTitle = chatDoc.data().title || "";

            // GÜNCELLEME: alert/prompt yerine özel bir modal lazım, ama şimdilik prompt
            // UYARI: Bu prompt, iframe/sandbox ortamlarında çalışmayabilir.
            const newTitle = prompt("Sohbet için yeni bir başlık girin:", currentTitle);

            if (newTitle && newTitle.trim() !== "" && newTitle !== currentTitle) {
                try {
                    await updateDoc(chatRef, {
                        title: newTitle.trim().substring(0, 30) // 30 kr limit
                    });
                    console.log("Başlık güncellendi:", newTitle);
                } catch (error) {
                    console.error("Başlık güncellenemedi:", error);
                    renderSystemMessage("Başlık güncellenirken bir hata oluştu.", "error");
                }
            }
        }

        function openDeleteModal() {
            if (!contextMenuChatId) return;
            // Menüyü kapat, silme modalını aç
            CHAT_CONTEXT_MENU.classList.add('hidden');
            DELETE_CONFIRM_MODAL.classList.remove('hidden');
        }

        function closeDeleteModal() {
            DELETE_CONFIRM_MODAL.classList.add('hidden');
            contextMenuChatId = null; // ID'yi temizle
        }

        async function confirmDeleteChat() {
            if (!contextMenuChatId || !currentUserId || !db) return;

            const chatIdToDelete = contextMenuChatId;
            const userId = currentUserId;
            
            // Modalı hemen kapat
            closeDeleteModal(); 
            
            console.log(`Sohbet siliniyor: ${chatIdToDelete}`);

            try {
                // Bu sohbetin ana dokümanını sil
                const chatRef = doc(db, "users", userId, "chats", chatIdToDelete);
                
                // YENİ: Transactioın ile alt koleksiyonu silme (Daha yavaş ama tarayıcıda çalışır)
                // Bu işlem, çok fazla mesaj varsa zaman aşımına uğrayabilir
                // veya maliyetli olabilir. İdeal olanı Cloud Function'dır.
                await runTransaction(db, async (transaction) => {
                    const messagesRef = collection(db, "users", userId, "chats", chatIdToDelete, "messages");
                    const messagesSnapshot = await getDocs(messagesRef);
                    messagesSnapshot.forEach((msgDoc) => {
                        transaction.delete(msgDoc.ref);
                    });
                    transaction.delete(chatRef);
                });

                console.log("Sohbet ve mesajları başarıyla silindi.");

                // Eğer silinen sohbet, şu an açık olan sohbetse:
                if (chatIdToDelete === currentChatId) {
                    await startNewChat();
                }

            } catch (error) {
                console.error("Sohbet silinirken hata:", error);
                renderSystemMessage("Sohbet silinirken bir hata oluştu. (Not: Çok fazla mesaj içeren sohbetler tarayıcıdan silinemeyebilir.)", "error");
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // Olay Dinleyicilerini Ata
            
            // Sohbet
            NEW_CHAT_BTN.addEventListener('click', startNewChat);
            SEND_BTN.addEventListener('click', sendMessage);
            CHAT_INPUT.addEventListener('keydown', handleKey);
            CHAT_INPUT.addEventListener('input', autoResizeTextarea);
            
            // Mod Değişimi
            IMAGE_MODE_BTN.addEventListener('click', toggleChatMode);

            // Görsel Yükleme
            ATTACHMENT_BTN.addEventListener('click', () => FILE_INPUT.click());
            FILE_INPUT.addEventListener('change', handleFileSelect);
            REMOVE_ATTACHMENT_BTN.addEventListener('click', removeAttachment);
            
            CANCEL_IMAGE_EDIT_BTN.addEventListener('click', closeImageEditor);
            CONFIRM_IMAGE_EDIT_BTN.addEventListener('click', confirmImageEdit);
            
            SPEECH_TO_TEXT_BTN.addEventListener('click', toggleSpeechRecognition);
            setupSpeechRecognition();

            // Auth Modal
            EMAIL_SIGNIN_BTN.addEventListener('click', signInWithEmail);
            SIGNUP_BTN.addEventListener('click', signUpWithEmail);
            SIGNOUT_BTN.addEventListener('click', signOutUser);
            
            PLUS_BTN.addEventListener('click', window.openPremiumModal);

            SHOW_SIGNUP_BTN.addEventListener('click', () => {
                MODAL_LOGIN_VIEW.classList.add('hidden');
                MODAL_SIGNUP_VIEW.classList.remove('hidden');
                if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden');
            });
            SHOW_SIGNIN_BTN.addEventListener('click', () => {
                MODAL_LOGIN_VIEW.classList.remove('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden');
            });
            
            // Tema
            THEME_SELECTOR.addEventListener('change', (e) => {
                applyTheme(e.target.value);
            });
            
            // Sidebar (Katlanabilir & Mobil)
            TOGGLE_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar()); // Masaüstü
            OPEN_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar(true)); // Mobil Aç
            MOBILE_OVERLAY.addEventListener('click', () => toggleSidebar(false)); // Mobil Kapat

            // Kaydırma
            if (MESSAGES_CONTAINER && SCROLL_TO_BOTTOM_BTN) {
                MESSAGES_CONTAINER.addEventListener('scroll', () => {
                    const isScrolledUp = (MESSAGES_CONTAINER.scrollHeight - MESSAGES_CONTAINER.scrollTop - MESSAGES_CONTAINER.clientHeight) > 200;
                    if (isScrolledUp) {
                        SCROLL_TO_BOTTOM_BTN.style.display = 'flex';
                    } else {
                        SCROLL_TO_BOTTOM_BTN.style.display = 'none';
                    }
                });
                SCROLL_TO_BOTTOM_BTN.addEventListener('click', autoScroll);
            }

            // YENİ: Geçmiş Menüsü Olayları
            RENAME_CHAT_BTN.addEventListener('click', renameChat);
            DELETE_CHAT_BTN.addEventListener('click', openDeleteModal);
            // YENİ: Silme Modalı Olayları
            CANCEL_DELETE_BTN.addEventListener('click', closeDeleteModal);
            CONFIRM_DELETE_BTN.addEventListener('click', confirmDeleteChat);
            
            // YENİ: Geçmiş Arama Olayı
            CHAT_SEARCH_INPUT.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('#chat-history-list .chat-item-title').forEach(titleEl => {
                    const itemLi = titleEl.closest('.chat-item');
                    if (titleEl.textContent.toLowerCase().includes(searchTerm)) {
                        itemLi.style.display = 'flex';
                    } else {
                        itemLi.style.display = 'none';
                    }
                });
            });


            // --- Uygulamayı Başlat ---
            
            // 1. Kayıtlı Temayı Yükle
            const savedTheme = localStorage.getItem('n0thingai_theme') || 'dark-mode';
            applyTheme(savedTheme);
            THEME_SELECTOR.value = savedTheme;
            
            // 2. Kayıtlı Sidebar Durumunu Yükle (Masaüstü için)
            if (window.innerWidth > 768) {
                const isCollapsed = localStorage.getItem('sidebar_collapsed') === 'true';
                if (isCollapsed) {
                    SIDEBAR.classList.add('collapsed');
                }
            }

            // 3. Auth dinleyicisini kur
            setupAuthListener(); 
            
        });
    </script>
</body>
</html>
