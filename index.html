<script type="module">
    // Firebase ve Google API Entegrasyonu
    // --- FIRESTORE IMPORTLARI YENİDEN EKLENDİ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, signInAnonymously, 
        onAuthStateChanged, signOut,
        createUserWithEmailAndPassword, // Email ile kayıt için
        signInWithEmailAndPassword, // Email ile giriş için
        setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    // --- FIRESTORE IMPORTLARI (Geçmiş ve KOTA için) ---
    import { 
        getFirestore, doc, setDoc, addDoc, collection, onSnapshot, 
        query, orderBy, serverTimestamp, getDoc,
        updateDoc, getDocs // <<< KRİTİK HATA DÜZELTMESİ: getDocs doğru import edildi
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- HİBRİT API Keys ve Modeller ---
    // GÜVENLİK UYARISI: Bu anahtarlar tarayıcıda görünür. Üretim ortamında sunucu tarafı çözümler kullanın.
    const GEMINI_API_KEY = "AIzaSyCx4u1qHGlysIGpm1Zw0YBfXlqEXJ1BlvM"; 
    const CHAT_MODEL = "gemini-2.5-flash-preview-09-2025";
    
    // GÜVENLİK UYARISI: Bu anahtar tarayıcıda görünür.
    const HUGGINGFACE_API_KEY = "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";
    const IMAGE_GEN_MODEL = "https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0";
    
    
    // --- KULLANICININ YENİ FIREBASE CONFIG BİLGİSİ ---
    const firebaseConfig = {
      apiKey: "AIzaSyAUM0DoLRAUoXsAxbcJOrerJIb_vT0GhS4",
      authDomain: "n0thingai-e8f3c.firebaseapp.com",
      projectId: "n0thingai-e8f3c",
      storageBucket: "n0thingai-e8f3c.firebasestorage.app",
      messagingSenderId: "266636496490",
      appId: "1:266636496490:web:b5250f6ba01a66bf860413"
    };
    
    // Firebase Servislerini Başlatma
    let app, auth, db;
    try {
        app = initializeApp(firebaseConfig);
        auth = getAuth(app);
        db = getFirestore(app); 
        console.log("Firebase başarıyla başlatıldı.");
    } catch (e) {
        console.error("Firebase başlatılamadı:", e);
        // Hata durumunda bile UI'ı başlatmaya devam et (Anonim/Demo mod)
    }
    
    // --- DOM Elements ---
    const MESSAGES_CONTAINER = document.getElementById('messages-container');
    const CHAT_INPUT = document.getElementById('chat-input');
    const SEND_BTN = document.getElementById('send-btn');
    const IMAGE_MODE_BTN = document.getElementById('image-mode-btn'); 
    const NEW_CHAT_BTN = document.getElementById('new-chat-btn');
    const CURRENT_MODE_DISPLAY = document.getElementById('current-mode-display');
    const TYPING_INDICATOR = document.getElementById('typing-indicator');
    const LOADING_TEXT = document.getElementById('loading-text');
    const CHAT_HISTORY_LIST = document.getElementById('chat-history-list');
    const ATTACHMENT_BTN = document.getElementById('attachment-btn');
    const FILE_INPUT = document.getElementById('file-input');
    const ATTACHMENT_PREVIEW = document.getElementById('attachment-preview');
    const PREVIEW_IMAGE = document.getElementById('preview-image');
    const REMOVE_ATTACHMENT_BTN = document.getElementById('remove-attachment-btn');
    const AUTH_CONTAINER = document.getElementById('auth-container');
    const USER_PROFILE_VIEW = document.getElementById('user-profile-view');
    const LOGIN_VIEW = document.getElementById('login-view'); 
    const PROFILE_PIC = document.getElementById('profile-pic');
    const USER_NAME = document.getElementById('user-name');
    const SETTINGS_MODAL = document.getElementById('settings-modal');
    const MODAL_LOGIN_VIEW = document.getElementById('modal-login-view');
    const MODAL_SIGNUP_VIEW = document.getElementById('modal-signup-view');
    const MODAL_SETTINGS_VIEW = document.getElementById('modal-settings-view');
    const THEME_SELECTOR = document.getElementById('theme-selector');
    const PREMIUM_MODAL = document.getElementById('premium-modal');
    const PLUS_BTN = document.getElementById('plus-btn');
    const AUTH_ERROR_MESSAGE = document.getElementById('auth-error-message');
    const SIGNUP_ERROR_MESSAGE = document.getElementById('signup-error-message');
    const EMAIL_INPUT = document.getElementById('email-input');
    const PASSWORD_INPUT = document.getElementById('password-input');
    const EMAIL_SIGNIN_BTN = document.getElementById('email-signin-btn');
    const SIGNUP_BTN = document.getElementById('signup-btn');
    const SIGNOUT_BTN = document.getElementById('signout-btn');
    const SHOW_SIGNUP_BTN = document.getElementById('show-signup-btn');
    const SHOW_SIGNIN_BTN = document.getElementById('show-signin-btn');
    const SIGNUP_EMAIL_INPUT = document.getElementById('signup-email-input');
    const SIGNUP_PASSWORD_INPUT = document.getElementById('signup-password-input');
    const SIDEBAR = document.getElementById('sidebar');
    const OPEN_SIDEBAR_BTN = document.getElementById('open-sidebar-btn');
    const CLOSE_SIDEBAR_BTN = document.getElementById('close-sidebar-btn');
    const MOBILE_OVERLAY = document.getElementById('mobile-overlay');
    const SCROLL_TO_BOTTOM_BTN = document.getElementById('scroll-to-bottom-btn');
    const SPEECH_TO_TEXT_BTN = document.getElementById('speech-to-text-btn');
    let recognition; 
    const IMAGE_EDITOR_MODAL = document.getElementById('image-editor-modal');
    const EDITOR_IMAGE_PREVIEW = document.getElementById('editor-image-preview');
    const CANCEL_IMAGE_EDIT_BTN = document.getElementById('cancel-image-edit');
    const CONFIRM_IMAGE_EDIT_BTN = document.getElementById('confirm-image-edit');
    let tempImageBlob = null; 
    const TOKEN_DISPLAY = document.getElementById('token-display');
    const TOKEN_COUNT = document.getElementById('token-count');


    // --- YENİ: KOTA LİMİTLERİ (TOKEN) ---
    const QUOTAS = {
        anonymous: { tokens: 50 },     // Anonim: 50 token
        normal: { tokens: 150 },       // Normal: 150 token
        plus: { tokens: 500 },         // Plus: 500 token
        premium: { tokens: 1000 },     // Premium: 1000 token
        admin: { tokens: Infinity }    // Admin: Sınırsız
    };
    
    // Token Maliyetleri
    const COSTS = {
        message: 10,  // Mesaj (Sohbet)
        image: 20,    // Görsel Oluşturma
        file: 15      // Dosya (Görsel Analiz)
    };

    // --- Global State ---
    let chatMode = 'text'; 
    let isWaitingForResponse = false;
    let attachedImageBase64 = null; 
    
    let currentUserId = null; 
    let currentChatId = null; 
    let unsubscribeChat = null; 
    let unsubscribeHistory = null; 
    
    let currentUserRole = 'anonymous'; 
    let dailyUsage = { tokens: 0 }; 


    /**
     * API Çağrısını Üstlenir (HİBRİT: Gemini ve Hugging Face)
     */
    async function fetchWithRetry(model, payload, apiKey, isTitleGeneration = false) {
        let url = '';
        let headers = { 'Content-Type': 'application/json' };
        let responseType = 'json'; 

        if (model === 'gemini') {
            url = `https://generativelanguage.googleapis.com/v1beta/models/${CHAT_MODEL}:generateContent?key=${apiKey}`;
        } else if (model === 'huggingface') {
            url = IMAGE_GEN_MODEL; 
            headers['Authorization'] = `Bearer ${apiKey}`; 
            responseType = 'blob'; 
        } else {
            renderSystemMessage("Hata: Geçersiz API modeli.", "error");
            return null;
        }

        const MAX_RETRIES = isTitleGeneration ? 1 : 3;
        let attempt = 0;

        while (attempt < MAX_RETRIES) {
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: headers,
                    body: JSON.stringify(payload)
                });

                if (response.status === 503) { 
                    throw new Error("503");
                }
                if (!response.ok) {
                    if (responseType === 'blob') {
                        const errorText = await response.text();
                        throw new Error(`API Hatası (${response.status}): ${errorText}`);
                    }
                    const errorData = await response.json();
                    throw new Error(`API Hatası (${response.status}): ${errorData.error?.message || 'Bilinmeyen Hata'}`);
                }
                
                if (responseType === 'json') {
                    return await response.json();
                } else if (responseType === 'blob') {
                    return await response.blob();
                }

            } catch (error) {
                attempt++;
                if (error.message === "503" && !isTitleGeneration) { 
                    showTypingIndicator("Hugging Face modeli yükleniyor... (Bu 1-2 dk sürebilir)");
                    await new Promise(resolve => setTimeout(resolve, 10000 * attempt)); 
                } else {
                    console.error(`API Denemesi ${attempt} başarısız:`, error);
                    if (attempt >= MAX_RETRIES) {
                         if (!isTitleGeneration) { 
                             renderSystemMessage(`**HATA:** ${error.message}`, "error");
                         }
                         return null;
                    }
                }
            }
        }
        return null;
    }

    // --- UI Helper Functions ---

    function autoScroll() {
        MESSAGES_CONTAINER.scrollTop = MESSAGES_CONTAINER.scrollHeight;
        if (SCROLL_TO_BOTTOM_BTN) SCROLL_TO_BOTTOM_BTN.style.display = 'none'; 
    }

    function showTypingIndicator(text = "") {
        isWaitingForResponse = true;
        toggleInput(true); 
        if(LOADING_TEXT) LOADING_TEXT.textContent = text || "N0thingAI düşünüyor...";
        if(TYPING_INDICATOR) TYPING_INDICATOR.classList.add('visible');
        if(MESSAGES_CONTAINER) MESSAGES_CONTAINER.appendChild(TYPING_INDICATOR);
        autoScroll();
    }

    function hideTypingIndicator() {
        isWaitingForResponse = false;
        toggleInput(false); 
        if(TYPING_INDICATOR) TYPING_INDICATOR.classList.remove('visible');
    }

    function toggleInput(disabled) {
        CHAT_INPUT.disabled = disabled;
        SEND_BTN.disabled = disabled;
        ATTACHMENT_BTN.disabled = disabled;
        IMAGE_MODE_BTN.disabled = disabled; 
        if (SPEECH_TO_TEXT_BTN) SPEECH_TO_TEXT_BTN.disabled = disabled;
        
        if (disabled) {
            CHAT_INPUT.placeholder = "Yanıt bekleniyor...";
        } else {
            setChatMode(chatMode, false); 
        }
    }

    function renderSystemMessage(text, type = "info") {
         const systemMessageHTML = `
            <div class="message-row system-message-row">
                <div class="message-content ${type === 'error' ? 'error' : ''}">
                    ${text}
                </div>
            </div>
         `;
         MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', systemMessageHTML);
         autoScroll();
    }

    function addMessageToUI(text, sender) {
         const messageClass = sender === 'user' ? 'user-message-row' : 'ai-message-row';
         const safeText = document.createTextNode(text).textContent;
         
         const messageHTML = `
            <div class="message-row ${messageClass}">
                <div class="message-content">
                    ${safeText.replace(/\n/g, '<br>')}
                </div>
            </div>
         `;
         MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', messageHTML);
    }
    
    function addImageToUI(imageUrl, altText) {
        // Görseli AI mesajı olarak ekle
         const imageHTML = `
            <div class="message-row ai-message-row">
                <div class="message-content">
                    <p class="text-sm italic mb-2" style="color: var(--text-secondary);">${altText}</p>
                    <div class="image-container">
                        <img src="${imageUrl}" alt="${altText}" loading="lazy" />
                    </div>
                </div>
            </div>
         `;
         MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', imageHTML);
    }
    
    // --- Core Application Logic (Firestore Eklendi) ---

    function setChatMode(mode, notify = true) {
        chatMode = mode;
        
        if (mode === 'image') {
            if(CURRENT_MODE_DISPLAY) CURRENT_MODE_DISPLAY.textContent = "Görsel Modu";
            if(CHAT_INPUT) CHAT_INPUT.placeholder = "Görsel tanımını (prompt) girin...";
            if(IMAGE_MODE_BTN) IMAGE_MODE_BTN.classList.add('text-green-500'); 
            if(notify) renderSystemMessage("Görsel Modu **AKTİF**. (Sohbet etmek için 'Sohbet Modu'na geçin)");
            
        } else {
            if(CURRENT_MODE_DISPLAY) CURRENT_MODE_DISPLAY.textContent = "Sohbet Modu";
            if(CHAT_INPUT) CHAT_INPUT.placeholder = "N0thingAI'a bir mesaj gönder...";
            if(IMAGE_MODE_BTN) IMAGE_MODE_BTN.classList.remove('text-green-500'); 
            if(notify) {
                const maxTokens = QUOTAS[currentUserRole]?.tokens || 0;
                const remainingTokens = maxTokens === Infinity ? "Sınırsız" : (maxTokens - (dailyUsage.tokens || 0));
                 
                if (!currentChatId) {
                     renderSystemMessage(`Sohbet Modu **AKTİF**. (Kalan Token: ${remainingTokens})`);
                }
            }
        }
        autoScroll();
    }

    function toggleChatMode() {
        if (chatMode === 'text') {
            setChatMode('image', true);
        } else {
            setChatMode('text', true);
        }
    }

    async function startNewChat() {
        if (isWaitingForResponse) return;
        
        if (unsubscribeChat) unsubscribeChat();
        unsubscribeChat = null;
        currentChatId = null;
        
        MESSAGES_CONTAINER.innerHTML = '';
        removeAttachment(); 
        
        const maxTokens = QUOTAS[currentUserRole]?.tokens || 0;
        const remainingTokens = maxTokens === Infinity ? "Sınırsız" : (maxTokens - (dailyUsage.tokens || 0));
        renderSystemMessage(`Sohbet Modu **AKTİF**. (Kalan Token: ${remainingTokens})`);

        setChatMode('text', false); 
        
        document.querySelectorAll('#chat-history-list .chat-item.active').forEach(item => {
            item.classList.remove('active');
        });
    }
    
    // --- OTOMATİK SOHBET BAŞLIĞI OLUŞTURMA ---
    async function generateChatTitle(firstMessage) {
        if (!db || !auth.currentUser || auth.currentUser.isAnonymous || !currentChatId) return;
        
        const userId = auth.currentUser.uid;
        const chatId = currentChatId;
        
        const systemInstruction = "Kullanıcının ilk mesajına bakarak bu sohbet için 3-5 kelimelik kısa bir başlık oluştur. Sadece başlığı döndür, başka hiçbir şey yazma. Örnek: 'İtalyan Mutfağı Tarifleri'";
        const payload = {
            contents: [
                { parts: [{ text: `Kullanıcının ilk mesajı: "${firstMessage}"` }] }
            ],
            systemInstruction: { parts: [{ text: systemInstruction }] },
        };

        try {
            const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY, true); 
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                let title = text.trim().replace(/^['"]|['"]$/g, ''); 
                title = title.substring(0, 30); 
                
                const chatRef = doc(db, "users", userId, "chats", chatId);
                await updateDoc(chatRef, {
                    title: title
                });
            }
        } catch (error) {
            console.error('Sohbet başlığı oluşturulamadı:', error);
        }
    }
    
    /**
     * Mesajları Firebase'e kaydeder
     */
    async function saveMessage(text, sender, imageUrl = null) {
        // Anonim kullanıcılar UI'a kaydeder
        if (auth.currentUser.isAnonymous || !db) {
            if (imageUrl) addImageToUI(imageUrl, text);
            else addMessageToUI(text, sender);
            return; 
        }

        const userId = auth.currentUser.uid;
        let chatToUse = currentChatId;
        let isFirstMessage = false;

        try {
            if (!chatToUse) {
                isFirstMessage = true; 
                const chatRef = await addDoc(collection(db, "users", userId, "chats"), {
                    title: text.substring(0, 30) + "...", 
                    createdAt: serverTimestamp()
                });
                chatToUse = chatRef.id;
                currentChatId = chatToUse; 
                listenToChat(userId, chatToUse); 
            }

            await addDoc(collection(db, "users", userId, "chats", chatToUse, "messages"), {
                sender: sender,
                text: text,
                imageUrl: imageUrl || null,
                createdAt: serverTimestamp()
            });
            
            if (isFirstMessage && sender === 'user') {
                generateChatTitle(text); 
            }

        } catch (error) {
            console.error("Mesaj kaydedilemedi:", error);
            renderSystemMessage(`**HATA:** Mesajınız veritabanına kaydedilemedi. ${error.message}`, "error");
        }
    }
    
    // --- GÖRSEL OLUŞTURMA (Hugging Face) ---
    
    /**
     * Türkçe prompt'u alıp, optimize edilmiş İngilizce prompt'a çevirir (Gemini ile)
     */
    async function translateAndOptimizePrompt(turkishPrompt) {
        showTypingIndicator("Görsel tanımı optimize ediliyor...");

        const systemInstruction = `You are a professional prompt engineer specializing in image generation (like Midjourney/DALL-E). Your task is to take the user's Turkish description and turn it into a single, detailed, highly descriptive English prompt, optimized for quality image output. 
        Do not add any conversational text, just the prompt.`;

        const payload = {
            contents: [{ parts: [{ text: `Translate and optimize this Turkish prompt for image generation: ${turkishPrompt}` }] }],
            systemInstruction: { parts: [{ text: systemInstruction }] },
        };

        try {
            const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY, true);
            const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
            
            if (text) {
                 return text.trim().replace(/^['"]|['"]$/g, '');
            }
            return turkishPrompt; 
        } catch (error) {
            console.error('Prompt Çeviri/Optimizasyon Hatası:', error);
            return turkishPrompt; 
        }
    }
    
    /**
     * Kullanıcı mesajını ve (varsa) görseli AI'ye gönderir (Gemini Sohbet)
     */
    async function fetchGeminiResponse(userPrompt) {
        showTypingIndicator("N0thingAI düşünüyor...");
        
        let parts = [{ "text": userPrompt }];
        
        if (attachedImageBase64) {
            parts.unshift({ 
                "inline_data": {
                    "mime_type": "image/jpeg", 
                    "data": attachedImageBase64
                }
            });
        }

        // HAFIZA (Son 10 mesajı al)
        let history = [];
        if (currentUserId && currentChatId && db) { // DB kontrolü eklendi
            try {
                const messagesRef = collection(db, "users", currentUserId, "chats", currentChatId, "messages");
                // KRİTİK DÜZELTME: Sadece son 10 mesajı al
                const q = query(messagesRef, orderBy("createdAt", "desc"));
                // HATA DÜZELTMESİ: getDocs doğru çağrıldı
                const historySnapshot = await getDocs(q); 
                
                let tempHistory = [];
                historySnapshot.forEach(doc => {
                    const msg = doc.data();
                    if (msg.text && !msg.imageUrl) {
                         tempHistory.push({
                            role: msg.sender === 'user' ? 'user' : 'model',
                            parts: [{ text: msg.text }]
                         });
                    }
                });
                
                history = tempHistory.reverse().slice(-10);
                
            } catch (e) {
                console.error("Hafıza yüklenirken hata:", e);
            }
        }


        const payload = {
            "contents": [
                ...history, 
                { "role": "user", "parts": parts } 
            ],
        };

        let responseText = "Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.";

        try {
            const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY);
            
            if (result && result.candidates && result.candidates[0].content) {
                responseText = result.candidates[0].content.parts[0].text;
            } else {
                responseText = "API'den geçerli bir yanıt alınamadı.";
            }

        } catch (error) {
            console.error("Gemini Hatası:", error);
            responseText = `Hata: ${error.message}`;
        } finally {
            hideTypingIndicator();
            removeAttachment(); 
            await saveMessage(responseText, 'ai'); 
        }
    }
    
    /**
     * Hugging Face (SDXL) kullanarak görsel oluşturur
     */
    async function generateImage(userPrompt) {
        const optimizedPrompt = await translateAndOptimizePrompt(userPrompt);

        showTypingIndicator(`Görsel oluşturuluyor: "${optimizedPrompt.substring(0, 40)}..."`);
        
        const payload = { 
            inputs: optimizedPrompt,
            parameters: {
                negative_prompt: "ugly, blurry, deformed, disfigured, poor quality, bad anatomy, low quality, grainy"
            }
        };

        let generatedBase64 = null;
        let aiMessage = "Görsel oluşturma başarısız oldu. Lütfen daha açıklayıcı bir tanım deneyin veya API anahtarınızı kontrol edin.";

        try {
            const imageBlob = await fetchWithRetry('huggingface', payload, HUGGINGFACE_API_KEY);
            
            if (imageBlob && imageBlob.size > 0) {
                generatedBase64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result); 
                    reader.onerror = reject;
                    reader.readAsDataURL(imageBlob);
                });
            } else if (imageBlob) { 
                aiMessage = "API'den görsel alınamadı, ancak hata da dönmedi. Lütfen tekrar deneyin.";
                await saveMessage(aiMessage, 'ai');
            }

        } catch (error) {
            console.error('Görsel API Çağrısı Hatası:', error);
        } finally {
            hideTypingIndicator();
            
            if (generatedBase64) {
                await saveMessage(optimizedPrompt, 'ai', generatedBase64); 
            }
        }
    }
    
    // --- GÜNLÜK KOTA KONTROLÜ (TOKEN) ---
    
    function getTodayDateString() {
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, '0');
        const dd = String(today.getDate()).padStart(2, '0');
        return `${yyyy}-${mm}-${dd}`;
    }
    
    function updateTokenDisplay(used, total) {
        if (!TOKEN_COUNT || !TOKEN_DISPLAY) return;
        
        TOKEN_DISPLAY.style.display = 'flex';
        
        if (total === Infinity) {
            TOKEN_COUNT.textContent = `Sınırsız Token (Admin)`; // KRİTİK: Admin'i belirt
        } else {
            TOKEN_COUNT.textContent = `${total - used} / ${total} Token`;
        }
    }

    /**
     * Kullanıcının eylem (mesaj, görsel, dosya) limitini kontrol eder ve kullanımı kaydeder.
     */
    async function checkUsageLimit(userId, actionCost) {
        if (!db || !userId) return false; 

        const profileRef = doc(db, "users", userId, "chats", "--profile--");
        const profileDoc = await getDoc(profileRef);
        
        let role = auth.currentUser.isAnonymous ? 'anonymous' : 'normal'; 
        let currentUsage = {
            date: getTodayDateString(),
            tokens: 0
        };
        
        if (profileDoc.exists()) {
            const data = profileDoc.data();
            role = data.role || role; 

            const todayStr = getTodayDateString();
            if (data.date === todayStr) {
                currentUsage = data; 
            }
        }
        
        currentUserRole = role; // Global rolü güncelle

        const maxTokens = QUOTAS[role]?.tokens || 0;
        const currentTokens = currentUsage.tokens || 0;

        // 2. Admin (Sınırsız) ise, limiti kontrol etme
        if (maxTokens === Infinity) {
            updateTokenDisplay(0, Infinity);
            return true; 
        }
        
        // 3. Normal/Plus/Premium/Anonim kullanıcıysa, günlük kotayı kontrol et
        if (currentTokens + actionCost > maxTokens) {
            renderSystemMessage(`Günlük token limitinize ulaştınız (${currentTokens}/${maxTokens}). Bu eylem ${actionCost} token gerektiriyor. Lütfen yarın tekrar deneyin veya N0thingAI Plus'a geçin.`, "error");
            window.openPremiumModal(); 
            updateTokenDisplay(currentTokens, maxTokens); 
            return false;
        }
        
        // 4. Limite ulaşılmadı, sayacı artır ve veritabanını güncelle
        currentUsage.tokens = currentTokens + actionCost;
        currentUsage.date = getTodayDateString(); 
        
        // 'role' durumunu (varsa) koruyarak yaz
        const existingData = profileDoc.exists() ? profileDoc.data() : {};
        // KRİTİK DÜZELTME: Anonim için de token kullanımı kaydedilir
        await setDoc(profileRef, { ...existingData, ...currentUsage, role: role }, { merge: true }); 
        dailyUsage = currentUsage; 
        updateTokenDisplay(currentUsage.tokens, maxTokens); 
        
        return true; 
    }


    async function sendMessage() {
        const text = CHAT_INPUT.value.trim();
        if (text === "" && !attachedImageBase64) return; 
        
        if (!auth || !auth.currentUser) {
            renderSystemMessage("Mesaj göndermek için lütfen giriş yapın.", "error");
            window.openSettingsModal();
            return;
        }
        
        const userId = auth.currentUser.uid;
        
        // Eylem maliyetini belirle
        let actionCost = COSTS.message; 
        if (chatMode === 'image') actionCost = COSTS.image;
        if (attachedImageBase64) actionCost = COSTS.file; 

        // --- LİMİT KONTROLÜ (TOKEN BAZLI) ---
        // Anonim kullanıcılar UI'a kaydedileceği için, bu kontrolü auth sonrası yapmalıyız
        const allowed = await checkUsageLimit(userId, actionCost);
        if (!allowed) {
            return; 
        }
        // --- LİMİT KONTROLÜ SONU ---

        // Mesajı göndermeden ÖNCE kaydet
        let messageToSave = text;
        if (attachedImageBase64 && text === "") {
            messageToSave = "(Görsel eklendi)";
        }
        await saveMessage(messageToSave, 'user');

        CHAT_INPUT.value = '';
        autoResizeTextarea(); 

        if (chatMode === 'image') {
            await generateImage(text);
        } else {
            await fetchGeminiResponse(text);
        }
    }

    function handleKey(event) {
        if (event.key === 'Enter' && !event.shiftKey) {
            event.preventDefault(); 
            sendMessage();
        }
    }
    
    // --- Attachment (Görsel Yükleme) Fonksiyonları ---

    async function handleFileSelect(event) {
        const files = event.target.files;
        if (!files || files.length === 0) return;
        
        if (!auth || !auth.currentUser) {
            renderSystemMessage("Dosya yüklemek için lütfen giriş yapın.", "error");
            window.openSettingsModal();
            return;
        }
        
        // KRİTİK DÜZELTME: Anonim kullanıcılar dosya yükleyemez (Token Maliyeti)
        if (auth.currentUser.isAnonymous) {
            renderSystemMessage("Görsel analiz (dosya yükleme) için lütfen giriş yapın. Maliyet: 15 Token", "error");
            return;
        } 
        
        const file = files[0]; // Sadece ilk dosyayı al
        // Sadece resim dosyalarına izin ver
        if (!file.type.startsWith('image/')) {
            renderSystemMessage("Hata: Yalnızca resim dosyaları yüklenebilir.", "error");
            return;
        }
        
        // Düzenleyiciyi aç
        openImageEditor(file);
        
        // Aynı dosyayı tekrar seçebilmek için inputu sıfırla
        event.target.value = null;
    }
    
    function openImageEditor(file) {
        const reader = new FileReader();
        reader.onload = (e) => {
            EDITOR_IMAGE_PREVIEW.src = e.target.result;
            tempImageBlob = e.target.result; 
            IMAGE_EDITOR_MODAL.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
    }

    function closeImageEditor() {
        IMAGE_EDITOR_MODAL.classList.add('hidden');
        tempImageBlob = null;
        EDITOR_IMAGE_PREVIEW.src = '';
    }
    
    function confirmImageEdit() {
        if (!tempImageBlob) return;
        
        attachedImageBase64 = tempImageBlob.split(',')[1]; 
        PREVIEW_IMAGE.src = tempImageBlob;
        ATTACHMENT_PREVIEW.style.display = 'block';
        ATTACHMENT_BTN.classList.add('text-green-500'); 
        
        if (chatMode === 'image') {
            setChatMode('text', false);
        }
        CHAT_INPUT.placeholder = "Görsel hakkında bir soru sorun...";
        
        closeImageEditor();
    }

    function removeAttachment() {
        attachedImageBase64 = null;
        if (ATTACHMENT_PREVIEW) ATTACHMENT_PREVIEW.style.display = 'none';
        if (PREVIEW_IMAGE) PREVIEW_IMAGE.src = '';
        if (ATTACHMENT_BTN) ATTACHMENT_BTN.classList.remove('text-green-500');
        setChatMode(chatMode, false);
    }

    function autoResizeTextarea() {
        CHAT_INPUT.style.height = 'auto'; 
        CHAT_INPUT.style.height = (CHAT_INPUT.scrollHeight) + 'px'; 
    }

    
    // --- Auth Functions (Global Scope'a Taşıma) ---
    
    window.openSettingsModal = () => {
        if (!SETTINGS_MODAL || !MODAL_SETTINGS_VIEW || !MODAL_LOGIN_VIEW) {
            console.error("Modal elementleri bulunamadı.");
            return;
        }
        if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden');
        if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden');
        
        SETTINGS_MODAL.classList.remove('hidden');
        
        if (auth && auth.currentUser && !auth.currentUser.isAnonymous) {
            MODAL_LOGIN_VIEW.classList.add('hidden');
            MODAL_SIGNUP_VIEW.classList.add('hidden');
            MODAL_SETTINGS_VIEW.classList.remove('hidden');
        } else {
            MODAL_LOGIN_VIEW.classList.remove('hidden');
            MODAL_SIGNUP_VIEW.classList.add('hidden');
            MODAL_SETTINGS_VIEW.classList.add('hidden');
        }
        
        updateThemeSpecificElements();
    };

    window.closeSettingsModal = () => {
        if (SETTINGS_MODAL) SETTINGS_MODAL.classList.add('hidden');
    };
    
    window.openPremiumModal = () => {
        if (PREMIUM_MODAL) PREMIUM_MODAL.classList.remove('hidden');
    };
    window.closePremiumModal = () => {
        if (PREMIUM_MODAL) PREMIUM_MODAL.classList.add('hidden');
    };
    
    function renderAuthError(error, view = 'login') {
        let errorMessage = "Bilinmeyen bir hata oluştu.";
        if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
            errorMessage = "Girdiğiniz e-posta veya şifre yanlış.";
        } else if (error.code === 'auth/email-already-in-use') {
            errorMessage = "Bu e-posta adresi zaten kayıtlı.";
        } else if (error.code === 'auth/weak-password') {
            errorMessage = "Şifre en az 6 karakter olmalıdır.";
        } else if (error.code === 'auth/invalid-email') {
            errorMessage = "Geçersiz e-posta adresi formatı.";
        } else if (error.code === 'auth/configuration-not-found') {
             errorMessage = "Giriş yöntemi (Email) Firebase'de etkin değil.";
        } else {
            errorMessage = error.message;
        }

        if (view === 'login' && AUTH_ERROR_MESSAGE) {
            AUTH_ERROR_MESSAGE.textContent = errorMessage;
            AUTH_ERROR_MESSAGE.classList.remove('hidden');
        } else if (view === 'signup' && SIGNUP_ERROR_MESSAGE) {
            SIGNUP_ERROR_MESSAGE.textContent = errorMessage;
            SIGNUP_ERROR_MESSAGE.classList.remove('hidden');
        } else {
            renderSystemMessage(`**Giriş Hatası:** ${errorMessage}`, "error");
        }
    }


    async function signInWithEmail() {
        if (!auth) return;
        try {
            const email = EMAIL_INPUT.value;
            const password = PASSWORD_INPUT.value;
            if (!email || !password) {
                renderAuthError({ code: 'auth/missing-fields', message: "Email ve şifre alanları boş bırakılamaz." }, 'login');
                return;
            }
            await signInWithEmailAndPassword(auth, email, password);
            window.closeSettingsModal();
        } catch (error) {
            console.error("Email Giriş Hatası:", error);
            renderAuthError(error, "login");
        }
    }

    async function signUpWithEmail() {
        if (!auth) return;
        try {
            const email = SIGNUP_EMAIL_INPUT.value;
            const password = SIGNUP_PASSWORD_INPUT.value;
            if (!email || !password) {
                renderAuthError({ code: 'auth/missing-fields', message: "Email ve şifre alanları boş bırakılamaz." }, 'signup');
                return;
            }
            if (password.length < 6) {
                renderAuthError({ code: 'auth/weak-password' }, 'signup');
                return;
            }
            
            const userCredential = await createUserWithEmailAndPassword(auth, email, password);
            
            if (userCredential.user && db) {
                const userId = userCredential.user.uid;
                
                const profileRef = doc(db, "users", userId, "chats", "--profile--"); 
                // KRİTİK DÜZELTME: Yeni kayıt olan kullanıcıya 'normal' rolü atandı
                await setDoc(profileRef, {
                    email: userCredential.user.email,
                    role: "normal", 
                    date: getTodayDateString(),
                    tokens: 0,
                });
            }
            
            window.closeSettingsModal();
            renderSystemMessage("**Başarılı:** Kayıt oldunuz ve giriş yaptınız.");
        } catch (error) {
            console.error("Email Kayıt Hatası:", error);
            renderAuthError(error, "signup");
        }
    }


    async function signOutUser() {
        if (!auth) return;
        try {
            await signOut(auth);
            window.closeSettingsModal();
            renderSystemMessage("Başarıyla çıkış yaptınız.");
        } catch (error) {
             console.error("Çıkış Hatası:", error);
        }
    }
    
    
    // --- Sohbet ve Geçmiş Dinleyicileri ---
    
    /**
     * Belirli bir sohbetin mesajlarını dinler
     */
    function listenToChat(userId, chatId) {
        if (!db) return;
        if (unsubscribeChat) unsubscribeChat(); 

        currentChatId = chatId;
        MESSAGES_CONTAINER.innerHTML = ''; 

        const messagesQuery = query(
            collection(db, "users", userId, "chats", chatId, "messages"),
            orderBy("createdAt", "asc")
        );

        unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
            MESSAGES_CONTAINER.innerHTML = ''; 
            if (snapshot.empty) {
                renderSystemMessage("Sohbet Modu **AKTİF**...");
            }
            snapshot.forEach(doc => {
                const msg = doc.data();
                if (msg.imageUrl && msg.sender === 'ai') { 
                    const imageUrl = msg.imageUrl; 
                    addImageToUI(imageUrl, `Görsel tanımı: "${msg.text}"`);
                } else {
                    addMessageToUI(msg.text, msg.sender);
                }
            });
            autoScroll();
        }, (error) => {
            console.error("Sohbet dinlenirken hata:", error);
            renderSystemMessage(`**HATA:** Sohbet yüklenemedi. ${error.message}`, "error");
        });
    }
    
    /**
     * Kullanıcının sohbet listesini dinler (Sidebar için)
     */
    function listenToChatHistory(userId) {
        if (!db) return;
        if (unsubscribeHistory) unsubscribeHistory(); 

        const historyQuery = query(
            collection(db, "users", userId, "chats"),
            orderBy("createdAt", "desc")
        );

        unsubscribeHistory = onSnapshot(historyQuery, (snapshot) => {
            document.querySelectorAll('#chat-history-list .chat-item').forEach(item => item.remove());
            
            snapshot.forEach(doc => {
                const chat = doc.data();
                const chatId = doc.id;
                
                // KRİTİK DÜZELTME: Profil belgesini geçmişte gösterme
                if (chatId === '--profile--') return; 

                const li = document.createElement('li');
                li.className = 'chat-item'; 
                li.textContent = chat.title || "Yeni Sohbet";
                li.dataset.chatId = chatId; 
                
                if (chatId === currentChatId) {
                    li.classList.add('active'); 
                }

                li.onclick = () => {
                    document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    li.classList.add('active');
                    
                    listenToChat(userId, chatId);
                };
                CHAT_HISTORY_LIST.appendChild(li);
            });
        }, (error) => {
            console.error("Geçmiş listesi dinlenirken hata:", error);
        });
    }


    /**
     * Auth durumunu dinler ve UI'ı günceller
     */
    async function setupAuthListener() {
        if (!auth) {
            if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
            if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
            startNewChat(); 
            renderSystemMessage("Kimlik doğrulama hizmeti yüklenemedi. Lütfen giriş yapmayı denemeyin.", "error");
            return;
        }
        
        await setPersistence(auth, browserLocalPersistence);
        
        onAuthStateChanged(auth, async (user) => {
            
            if (unsubscribeChat) unsubscribeChat();
            if (unsubscribeHistory) unsubscribeHistory();
            unsubscribeChat = null;
            unsubscribeHistory = null;
            dailyUsage = {}; 
            
            if (user) {
                currentUserId = user.uid;
                
                // KRİTİK DÜZELTME: Anonim dahil TÜM kullanıcılar için profil yolunu ayarla
                const profileRef = doc(db, "users", user.uid, "chats", "--profile--");
                const profileDoc = await getDoc(profileRef);
                
                if (user.isAnonymous) {
                    currentUserRole = 'anonymous'; 
                    
                    if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                    if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
                    if (USER_NAME) USER_NAME.textContent = "Anonim Kullanıcı";
                    if (PROFILE_PIC) PROFILE_PIC.textContent = "A";
                    
                    document.querySelectorAll('#chat-history-list .chat-item').forEach(item => item.remove());
                    if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');

                } else {
                    currentUserRole = 'normal'; 
                    
                    if(LOGIN_VIEW) LOGIN_VIEW.classList.add('hidden');
                    if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.remove('hidden');
                    
                    if (USER_NAME) USER_NAME.textContent = user.email || "Kullanıcı";
                    if (PROFILE_PIC) PROFILE_PIC.textContent = (user.email || "K")[0].toUpperCase();
                    
                    listenToChatHistory(user.uid);
                }
                
                // Token sistemini anonimler dahil herkes için yükle
                let initialRole = user.isAnonymous ? 'anonymous' : 'normal';

                if (profileDoc.exists()) {
                    const data = profileDoc.data();
                    initialRole = data.role || initialRole; 
                    
                    const todayStr = getTodayDateString();
                    if (data.date === todayStr) {
                        dailyUsage = data; 
                    } else {
                        dailyUsage = { tokens: 0 }; 
                    }
                } else {
                    dailyUsage = { tokens: 0 };
                    // KRİTİK DÜZELTME: Profil yoksa, anonim için de oluştur
                    if (db) {
                         await setDoc(profileRef, {
                            email: user.email || "anonymous",
                            role: initialRole, 
                            date: getTodayDateString(),
                            tokens: 0
                        });
                    }
                }
                
                currentUserRole = initialRole; // Final rolü ayarla

                // Rol'e göre Token UI'ı ayarla
                const maxTokens = QUOTAS[currentUserRole]?.tokens || 0;
                updateTokenDisplay(dailyUsage.tokens || 0, maxTokens);
                
                // Plus butonunu rol'e göre ayarla
                if (currentUserRole === 'plus' || currentUserRole === 'premium' || currentUserRole === 'admin') {
                    if (PLUS_BTN) PLUS_BTN.classList.add('hidden'); 
                } else {
                     if (PLUS_BTN) PLUS_BTN.classList.remove('hidden'); 
                }
                
                await startNewChat();
                
            } else {
                // Kullanıcı yok (Çıkış yapmış)
                currentUserId = null;
                currentUserRole = 'anonymous'; 
                
                if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
                if (TOKEN_DISPLAY) TOKEN_DISPLAY.style.display = 'none'; 
                
                document.querySelectorAll('#chat-history-list .chat-item').forEach(item => item.remove());
                
                // KRİTİK DÜZELTME: Çıkış yapıldığında, tekrar anonim giriş yap.
                if (auth) {
                    try {
                        await signInAnonymously(auth);
                        console.log("Çıkış yapıldı, anonim olarak tekrar giriş yapıldı.");
                    } catch (error) {
                         console.error("Anonim giriş hatası (çıkış sonrası):", error);
                         renderSystemMessage(`**Kritik Hata:** Anonim oturum başlatılamadı. ${error.message}. Firebase konsolunda 'Anonymous' (Anonim) giriş yöntemini etkinleştirin.`, "error");
                    }
                }
            }
            
            updateThemeSpecificElements();
        });
    }
    
    // --- Tema Fonksiyonları ---

    function applyTheme(themeName) {
        document.body.className = themeName; 
        localStorage.setItem('n0thingai_theme', themeName);
        updateThemeSpecificElements();
    }

    function updateThemeSpecificElements() {
        const theme = localStorage.getItem('n0thingai_theme') || 'dark-mode'; 
        const logoSvg = document.querySelector('.logo-svg');
        if (logoSvg) {
            logoSvg.style.color = '#FFFFFF'; 
        }
    }

    // --- Mobil Sidebar Fonksiyonları ---
    function toggleSidebar(open) {
        if (open) {
            SIDEBAR.classList.add('open');
            MOBILE_OVERLAY.style.display = 'block';
        } else {
            SIDEBAR.classList.remove('open');
            MOBILE_OVERLAY.style.display = 'none';
        }
    }
    
    // --- Sesli Yazma Fonksiyonları ---
    function setupSpeechRecognition() {
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        if (!SpeechRecognition) {
            SPEECH_TO_TEXT_BTN.disabled = true;
            SPEECH_TO_TEXT_BTN.title = "Tarayıcınız ses tanımayı desteklemiyor.";
            return;
        }
        
        recognition = new SpeechRecognition();
        recognition.continuous = false; 
        recognition.lang = 'tr-TR'; 
        recognition.interimResults = true; 

        recognition.onstart = () => {
            SPEECH_TO_TEXT_BTN.classList.add('recording');
            CHAT_INPUT.placeholder = "Dinleniyor...";
        };

        recognition.onresult = (event) => {
            const transcript = Array.from(event.results)
                .map(result => result[0])
                .map(result => result.transcript)
                .join('');
            
            CHAT_INPUT.value = transcript; 
            autoResizeTextarea();
        };

        recognition.onerror = (event) => {
            console.error("Ses tanıma hatası:", event.error);
            if (event.error === 'not-allowed') {
                renderSystemMessage("Mikrofon izni vermediniz.", "error");
            }
        };

        recognition.onend = () => {
            SPEECH_TO_TEXT_BTN.classList.remove('recording');
            setChatMode(chatMode, false); 
        };
    }

    function toggleSpeechRecognition() {
        if (!recognition) return;
        
        if (SPEECH_TO_TEXT_BTN.classList.contains('recording')) {
            recognition.stop();
        } else {
            try {
                recognition.start();
            } catch(e) {
                console.error("Ses tanıma başlatılamadı:", e);
            }
        }
    }


    // --- Initialization ---
    document.addEventListener('DOMContentLoaded', async () => {
        
        // Olay Dinleyicilerini Ata
        NEW_CHAT_BTN.addEventListener('click', startNewChat);
        SEND_BTN.addEventListener('click', sendMessage);
        CHAT_INPUT.addEventListener('keydown', handleKey);
        CHAT_INPUT.addEventListener('input', autoResizeTextarea); 
        IMAGE_MODE_BTN.addEventListener('click', toggleChatMode); 
        ATTACHMENT_BTN.addEventListener('click', () => FILE_INPUT.click());
        FILE_INPUT.addEventListener('change', handleFileSelect);
        REMOVE_ATTACHMENT_BTN.addEventListener('click', removeAttachment);
        CANCEL_IMAGE_EDIT_BTN.addEventListener('click', closeImageEditor);
        CONFIRM_IMAGE_EDIT_BTN.addEventListener('click', confirmImageEdit);
        SPEECH_TO_TEXT_BTN.addEventListener('click', toggleSpeechRecognition);
        setupSpeechRecognition(); 
        EMAIL_SIGNIN_BTN.addEventListener('click', signInWithEmail);
        SIGNUP_BTN.addEventListener('click', signUpWithEmail);
        SIGNOUT_BTN.addEventListener('click', signOutUser);
        PLUS_BTN.addEventListener('click', window.openPremiumModal);
        SHOW_SIGNUP_BTN.addEventListener('click', () => {
            MODAL_LOGIN_VIEW.classList.add('hidden');
            MODAL_SIGNUP_VIEW.classList.remove('hidden');
            if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden'); 
        });
        SHOW_SIGNIN_BTN.addEventListener('click', () => {
            MODAL_LOGIN_VIEW.classList.remove('hidden');
            MODAL_SIGNUP_VIEW.classList.add('hidden');
            if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden'); 
        });
        THEME_SELECTOR.addEventListener('change', (e) => {
            applyTheme(e.target.value);
        });
        OPEN_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar(true));
        CLOSE_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar(false));
        MOBILE_OVERLAY.addEventListener('click', () => toggleSidebar(false));

        const savedTheme = localStorage.getItem('n0thingai_theme') || 'dark-mode'; 
        applyTheme(savedTheme);
        THEME_SELECTOR.value = savedTheme;
        
        if (MESSAGES_CONTAINER && SCROLL_TO_BOTTOM_BTN) {
            MESSAGES_CONTAINER.addEventListener('scroll', () => {
                const isScrolledUp = (MESSAGES_CONTAINER.scrollHeight - MESSAGES_CONTAINER.scrollTop - MESSAGES_CONTAINER.clientHeight) > 200;
                if (isScrolledUp) {
                    SCROLL_TO_BOTTOM_BTN.style.display = 'flex';
                } else {
                    SCROLL_TO_BOTTOM_BTN.style.display = 'none';
                }
            });
            SCROLL_TO_BOTTOM_BTN.addEventListener('click', autoScroll);
        }

        // --- Uygulamayı Başlat ---
        
        setupAuthListener(); 
        
        if (auth && !auth.currentUser) {
            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Başlangıç anonim giriş hatası:", error);
                renderSystemMessage(`**Kritik Hata:** Oturum başlatılamadı. ${error.message}. Lütfen Firebase konsolunuzda 'Anonymous' (Anonim) giriş yöntemini etkinleştirdiğinizden emin olun.`, "error");
            }
        }
    });
</script>
