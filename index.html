<!DOCTYPE html>
<html lang="tr">
<head>
    <meta name="google-site-verification" content="AQSoYrgNNGutZzf4jpzwVieUI29wYj_CJKfNka2Uk4I" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- DÜZELTME: Başlık değişti -->
    <title>N0thingAI</title>
    <!-- YENİ: Favicon (Site Logosu) eklendi -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect width='100' height='100' rx='20' fill='%239E9E9E'/><text x='50%25' y='50%25' dominant-baseline='central' text-anchor='middle' font-size='70' font-weight='bold' fill='%23FFFFFF' font-family='Arial, sans-serif' dy='.1em'>N</text></svg>">
    <!-- İkonlar için Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- TEMA FONTU (ChatGPT Stili) -->
    <style>
        /* CSS Değişkenleri - SİYAH/BEYAZ TEMA (ChatGPT Stili) */
        :root {
            /* Varsayılan: Koyu Tema */
            --bg-primary: #202123; /* Ana Arkaplan */
            --sidebar-bg: #0D0D0D; /* Kenar Çubuğu (Daha Koyu) */
            --text-primary: #ECECEC; /* Ana Metin Rengi */
            --text-secondary: #A6A6A6; /* İkincil Metin Rengi */
            --highlight-color: #20C20E; /* N0thingAI Neon Yeşili */
            --active-chat-bg: #2A2A2A; /* Aktif Sohbet Arkaplanı */
            --ai-message-bg: #2A2A2A; /* AI Mesaj Arkaplanı */
            --user-message-bg: #004d00; /* Kullanıcı Mesajı (Koyu Yeşil) */
            --input-bg: #2A2A2A; /* Input Alanı Arkaplanı */
            --input-border: #3A3A3A;
            --shadow-color: rgba(0, 0, 0, 0.3); /* Koyu gölge */
            --modal-bg: #1A1A1A;
            --btn-border: #444;
            --btn-hover: #333;
        }

        /* İSTEK: Varsayılan Gri Arka Plan / Beyaz Yazı */
        .dark-mode {
            --bg-primary: #202123;      /* Koyu Gri Arka Plan */
            --sidebar-bg: #1A1A1A;      /* Daha Koyu Gri Sidebar */
            --text-primary: #ECECEC;    /* Beyazımsı Yazı */
            --text-secondary: #A6A6A6;  /* Soluk Gri Yazı */
            --highlight-color: #9E9E9E; /* Nötr Gri Vurgu */
            --active-chat-bg: #2A2A2A;
            --ai-message-bg: #2A2A2A;
            --user-message-bg: #333333; /* Koyu Gri Kullanıcı Mesajı */
            --input-bg: #2A2A2A;
            --input-border: #3A3A3A;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-bg: #1A1A1A;
            --btn-border: #444;
            --btn-hover: #333;
        }
        
        /* İSTEK: İkincil Beyaz Arka Plan / Gri Yazı */
        .light-mode {
            --bg-primary: #FFFFFF;      /* Beyaz Arka Plan */
            --sidebar-bg: #F9F9F9;
            --text-primary: #333333;    /* Gri Yazı */
            --text-secondary: #555;
            --highlight-color: #555555; /* Koyu Gri Vurgu */
            --active-chat-bg: #EAEAEA;
            --ai-message-bg: #F0F0F0;
            --user-message-bg: #EAEAEA; /* Açık Gri Kullanıcı Mesajı */
            --input-bg: #FFFFFF;
            --input-border: #E0E0E0;
            --shadow-color: rgba(0, 0, 0, 0.05);
            --modal-bg: #FFFFFF;
            --btn-border: #E0E0E0;
            --btn-hover: #F0F0F0;
        }


        /* Genel Stil */
        body {
            /* CHATGPT STİLİ FONT */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        .app-container { display: flex; height: 100vh; overflow: hidden; }
        .sidebar {
            width: 280px;
            background-color: var(--sidebar-bg);
            display: flex;
            flex-direction: column;
            padding: 16px;
            border-right: 1px solid var(--input-border);
            transition: background-color 0.3s, border-color 0.3s;
        }
        .sidebar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        /* N0thingAI Logosu */
        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-svg {
            width: 32px;
            height: 32px;
            /* TEMA VURGU RENGİ (Gri) */
            background-color: var(--highlight-color); 
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: var(--sidebar-bg); /* Arka planla aynı (siyah/beyaz) */
            font-size: 20px;
            padding-bottom: 2px; /* 'N' harfini ortalamak için */
        }
        .light-mode .logo-svg {
            color: #FFFFFF; /* Açık temada logo harfi beyaz */
        }
        .dark-mode .logo-svg {
            color: #FFFFFF; /* Koyu temada da logo harfi beyaz (kontrast için) */
        }

        .logo-text {
            font-size: 1.25rem;
            font-weight: 800;
            color: var(--text-primary);
        }

        /* Yeni Sohbet Butonu */
        .new-chat-btn {
            padding: 10px 16px;
            background-color: transparent;
            border: 1px solid var(--btn-border);
            color: var(--text-primary);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 500;
        }
        .new-chat-btn:hover { background-color: var(--btn-hover); }
        .new-chat-btn i { margin-right: 8px; }

        /* Sohbet Geçmişi Alanı */
        .chat-history {
            flex-grow: 1;
            overflow-y: auto;
            margin-top: 1rem; /* Geri eklendi */
        }
        /* Geçmişteki sohbet item'ı */
        .chat-item {
            padding: 10px 12px;
            margin-bottom: 8px;
            border-radius: 8px;
            cursor: pointer;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-size: 0.9em;
            transition: background-color 0.2s, color 0.2s;
            color: var(--text-secondary);
        }
        .chat-item.active {
            background-color: var(--active-chat-bg);
            color: var(--text-primary); /* Aktif metin daha parlak */
            font-weight: 600;
        }
        .chat-item:not(.active):hover {
            background-color: var(--btn-hover);
        }
        
        /* Mod Göstergesi */
        #current-mode-display {
            border-color: var(--highlight-color);
            color: var(--highlight-color);
            background-color: color-mix(in srgb, var(--highlight-color) 10%, transparent);
            text-align: center;
            margin-bottom: 10px; /* Diğer item'lardan ayırmak için */
        }

        /* Profil ve Ayarlar (Dinamik Auth Alanı) */
        .sidebar-footer {
            border-top: 1px solid var(--input-border);
            padding-top: 16px;
            margin-top: auto; /* Footer'ı en alta it */
        }
        #auth-container { transition: all 0.3s; }
        
        /* YENİ: PLUS BUTONU (SOHBET ALANINA TAŞINDI) */
        #plus-btn {
            position: absolute;
            top: 16px;
            right: 16px;
            z-index: 20; /* Hamburger menünün altında, içeriğin üstünde */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            padding: 6px 10px; /* Küçültüldü */
            background-color: var(--highlight-color);
            color: #fff; 
            font-weight: 700;
            transition: background-color 0.2s;
            border-radius: 8px;
            font-size: 0.85rem; /* Küçültüldü */
        }
        .dark-mode #plus-btn {
            color: #1A1A1A;
        }
        .light-mode #plus-btn {
            color: #FFFFFF;
        }
        #plus-btn:hover {
            background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }
        #plus-btn i {
             text-shadow: 0 0 8px color-mix(in srgb, var(--highlight-color) 50%, white);
             font-size: 0.8rem;
        }
        
        /* Profil Görünümü (Oturum Açık) */
        #user-profile-view {
            transition: background-color 0.2s;
        }
        #user-profile-view:hover {
            background-color: var(--active-chat-bg);
        }
        #profile-pic {
            /* TEMA VURGU RENGİ (Gri) */
            background-color: var(--highlight-color);
        }
        #profile-pic img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        /* Giriş Yap Butonu (Oturum Kapalı) */
        #login-btn {
            background-color: var(--highlight-color);
            color: #fff; 
            font-weight: 700;
            transition: background-color 0.2s;
        }
        .dark-mode #login-btn {
            color: #1A1A1A; /* Koyu temada, gri buton üstü siyah yazı */
        }
        .light-mode #login-btn {
            color: #FFFFFF; /* Açık temada, gri buton üstü beyaz yazı */
        }
        #login-btn:hover {
            background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }


        /* Sohbet Alanı */
        .chat-area { flex-grow: 1; display: flex; flex-direction: column; position: relative; background-color: var(--bg-primary); }
        .messages-container {
            padding: 20px;
            overflow-y: auto;
            flex-grow: 1;
            scroll-behavior: smooth;
            padding-bottom: 120px; /* Input alanı için boşluk */
        }

        /* YENİ: En Alta Kaydırma Butonu */
        #scroll-to-bottom-btn {
            display: none; /* Varsayılan olarak gizli */
            position: absolute;
            bottom: 130px; /* Input alanının 10px üstü (120px padding) */
            right: 30px;
            z-index: 20;
            background-color: var(--input-bg);
            color: var(--text-secondary);
            border: 1px solid var(--input-border);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            box-shadow: 0 4px 10px var(--shadow-color);
            transition: all 0.2s;
            cursor: pointer;
        }
        #scroll-to-bottom-btn:hover {
            color: var(--text-primary);
            background-color: var(--btn-hover);
        }


        /* Mesaj Balonları */
        .message-row { display: flex; margin-bottom: 24px; max-width: 90%; }
        .message-content {
            padding: 14px 20px;
            border-radius: 18px;
            line-height: 1.6;
            word-wrap: break-word;
            white-space: pre-wrap; /* Satır sonlarını koru */
            position: relative;
            box-shadow: 0 4px 12px var(--shadow-color);
        }
        
        /* AI Mesajı */
        .ai-message-row { justify-content: flex-start; }
        .ai-message-row .message-content {
            background-color: var(--ai-message-bg);
            border-top-left-radius: 5px;
            color: var(--text-primary);
        }

        /* Kullanıcı Mesajı */
        .user-message-row { justify-content: flex-end; margin-left: auto; }
        .user-message-row .message-content {
            background-color: var(--user-message-bg);
            color: var(--text-primary); 
            border-top-right-radius: 5px;
        }
        .light-mode .user-message-row .message-content {
             color: #202123; /* Açık temada kullanıcı metni */
        }
        .dark-mode .user-message-row .message-content {
             color: var(--text-primary); /* Koyu temada kullanıcı metni */
        }
        
        /* Sistem Mesajı */
        .system-message-row { justify-content: center; max-width: 100%; }
        .system-message-row .message-content {
            background-color: transparent;
            color: var(--text-secondary);
            font-size: 0.8rem;
            font-style: italic;
            text-align: center;
            box-shadow: none;
        }
        .system-message-row .error {
            color: #FF6B6B;
            font-weight: 500;
        }

        /* Görsel Kutusu Stili */
        .image-container {
            max-width: 400px; /* Görsel boyutu */
            margin-top: 10px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--input-border);
        }
        .image-container img { width: 100%; height: auto; display: block; }
        
        /* Eklenen (Yüklenen) Görsel Önizlemesi */
        .attachment-preview {
            display: none; /* JS ile yönetilir */
            position: absolute;
            bottom: 100%; /* Input alanının üstünde */
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 10px;
            padding: 8px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 12px;
            box-shadow: 0 -4px 15px var(--shadow-color);
            max-width: 300px;
        }
        .attachment-preview img {
            max-height: 150px;
            width: auto;
            border-radius: 8px;
        }
        .attachment-preview .remove-attachment {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: #FF6B6B;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 12px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Girdi Kutusu (Input Area) */
        .input-area-wrapper {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 24px;
            background: linear-gradient(to top, var(--bg-primary) 70%, transparent);
            pointer-events: none; /* Sadece sarmalayıcı için */
        }
        .input-area {
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            padding: 8px 12px;
            background-color: var(--input-bg);
            border: 1px solid var(--input-border);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-color);
            pointer-events: auto; /* İçerik için */
        }
        
        .input-area textarea {
            flex-grow: 1;
            padding: 10px 8px;
            border: none;
            background: transparent;
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            resize: none; /* Yeniden boyutlandırmayı engelle */
            max-height: 150px; /* Maksimum yükseklik */
            overflow-y: auto; /* Gerekirse kaydır */
            /* FONTU UYGULA */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        
        .input-area textarea:disabled {
            background-color: transparent;
        }

        .icon-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: color 0.2s, background-color 0.2s;
        }
        .icon-btn:hover:not(:disabled) {
            color: var(--text-primary);
            background-color: var(--btn-hover);
        }
        .icon-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .send-btn {
            background-color: var(--highlight-color);
            color: #fff;
            width: 36px;
            height: 36px;
            border-radius: 8px;
            margin-left: 8px;
            font-weight: 700;
        }
        .dark-mode .send-btn {
            color: #1A1A1A; /* Koyu temada, gri buton üstü siyah yazı */
        }
        .send-btn:disabled {
            background-color: var(--text-secondary);
            opacity: 0.6;
        }
        .send-btn:not(:disabled):hover {
             background-color: color-mix(in srgb, var(--highlight-color) 85%, black);
        }

        /* Yapay Zeka Yazma Animasyonu (Zıplayan Noktalar) */
        .ai-typing-indicator {
            display: none; /* JS ile yönetilir */
            align-items: center;
            height: 20px;
            margin: 5px 0 15px 0;
        }
        .ai-typing-indicator.visible { display: flex; }
        .dot {
            width: 8px; height: 8px; background-color: var(--highlight-color); border-radius: 50%;
            margin-right: 5px; animation: bounce 0.8s infinite;
        }
        .dot:nth-child(2) { animation-delay: 0.1s; }
        .dot:nth-child(3) { animation-delay: 0.2s; }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }

        /* Modal Stilleri */
        .modal { z-index: 50; }
        .modal-overlay {
            backdrop-filter: blur(5px);
            transition: opacity 0.3s;
        }
        .modal-content {
            background-color: var(--modal-bg);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
            border: 1px solid var(--input-border);
        }
        .modal input {
            background-color: var(--input-bg);
            color: var(--text-primary);
            border: 1px solid var(--input-border);
            /* FONTU UYGULA */
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
        }
        .social-btn {
            border: 1px solid var(--btn-border);
            transition: background-color 0.2s;
        }
        .social-btn:hover { background-color: var(--btn-hover); }
        .light-mode .social-btn:hover { background-color: #E0E0E0; }

        /* Responsive Tasarım */
        @media (max-width: 768px) {
            .sidebar {
                position: absolute;
                left: -300px; /* Kapalı */
                width: 280px;
                height: 100%;
                z-index: 40;
                box-shadow: 4px 0 15px rgba(0,0,0,0.2);
                transition: left 0.3s ease;
            }
            .sidebar.open {
                left: 0; /* Açık */
            }
            .chat-area {
                width: 100%;
            }
            /* Hamburger Menü (Chat Alanına Eklenir) */
            .hamburger-btn {
                position: absolute;
                top: 15px;
                left: 15px;
                z-index: 30;
                background-color: var(--input-bg);
                border: 1px solid var(--input-border);
                border-radius: 8px;
                padding: 8px 10px;
                box-shadow: 0 4px 10px var(--shadow-color);
            }
            /* Ekranı karartma */
            .mobile-overlay {
                position: absolute;
                inset: 0;
                background-color: rgba(0,0,0,0.5);
                z-index: 39;
                display: none; /* JS ile yönetilir */
            }
            .sidebar.open + .chat-area .mobile-overlay {
                display: block;
            }
            .input-area-wrapper {
                padding: 12px;
            }
            .input-area {
                padding: 6px 8px;
            }
            .messages-container {
                padding: 10px;
                padding-top: 70px; /* Hamburger menü için boşluk */
                padding-bottom: 100px;
            }
            .message-row {
                max-width: 95%;
            }
            /* Mobilde Plus butonunu hamburger menüsünün sağına al */
            #plus-btn {
                top: 15px;
                right: 15px;
                left: auto;
            }
            /* YENİ: Mobilde alta kaydırma butonu */
            #scroll-to-bottom-btn {
                bottom: 110px; /* Mobil input alanı daha yüksekte */
                right: 15px;
            }
        }
    </style>
</head>
<body class="dark-mode"> <!-- VARSAYILAN TEMA: KOYU (GRİ/BEYAZ) -->
    <div class="app-container">
        <!-- Sol Kenar Çubuğu -->
        <aside class="sidebar" id="sidebar">
            <header class="sidebar-header">
                <div class="logo-container">
                    <div class="logo-svg">N</div>
                    <span class="logo-text">N0thingAI</span>
                </div>
                <!-- Mobil için Kapatma Butonu -->
                <button class="icon-btn md:hidden" id="close-sidebar-btn">
                    <i class="fas fa-times"></i>
                </button>
            </header>

            <button class="new-chat-btn" id="new-chat-btn">
                <i class="fas fa-plus"></i> Yeni Sohbet
            </button>
            
            <!-- YENİ: PREMIUM BUTONU (Buradan kaldırıldı) -->


            <!-- Sohbet Geçmişi (Geri Eklendi) -->
            <nav class="chat-history">
                <ul id="chat-history-list" class="space-y-1">
                    <li id="current-mode-display" class="text-xs px-3 py-2 rounded-lg font-semibold border" >
                        Sohbet Modu
                    </li>
                    <!-- Geçmiş buraya dinamik olarak yüklenecek -->
                </ul>
            </nav>
            
            <!-- Profil ve Ayarlar (Dinamik Auth Alanı) -->
            <footer class="sidebar-footer">
                <div id="auth-container" class="w-full">
                    
                    <!-- Oturum Açıkken (Giriş yapıldıktan sonra görünür) -->
                    <div id="user-profile-view" class="hidden flex items-center justify-between cursor-pointer p-2 rounded-lg" onclick="window.openSettingsModal()">
                        <div class="flex items-center space-x-3 min-w-0">
                            <span id="profile-pic" class="w-8 h-8 rounded-full flex-shrink-0 flex items-center justify-center font-bold text-sm"></span>
                            <span id="user-name" class="text-sm font-semibold truncate">Kullanıcı Adı</span>
                        </div>
                        <i class="fas fa-cog text-lg opacity-70"></i>
                    </div>
                    
                    <!-- Oturum Kapalıyken (Varsayılan görünüm) -->
                    <div id="login-view" class="">
                        <button id="login-btn" class="w-full py-3 login-btn rounded-xl font-semibold" onclick="window.openSettingsModal()">
                            Giriş Yap / Kayıt Ol
                        </button>
                    </div>

                </div>
            </footer>
        </aside>

        <!-- Sohbet Alanı -->
        <main class="chat-area">
            <!-- Mobil Hamburger Menü Butonu -->
            <button class="icon-btn hamburger-btn md:hidden" id="open-sidebar-btn">
                <i class="fas fa-bars"></i>
            </button>
            
            <!-- YENİ: PREMIUM BUTONU (Buraya taşındı) -->
            <button id="plus-btn" class="absolute top-4 right-4 z-10 py-1 px-3 login-btn rounded-xl font-semibold text-xs flex items-center gap-2">
                <i class="fas fa-star"></i> Plus
            </button>

            <!-- Mobil Overlay (Sidebar açıkken) -->
            <div class="mobile-overlay md:hidden" id="mobile-overlay"></div>

            <!-- YENİ: EN ALTA KAYDIRMA BUTONU -->
            <button id="scroll-to-bottom-btn" class="items-center justify-center">
                <i class="fas fa-arrow-down"></i>
            </button>

            <div class="messages-container" id="messages-container">
                <!-- Başlangıç Mesajı (JS ile oluşturulur) -->
            </div>
            
            <!-- Yazma Animsyonu (Buraya taşınır) -->
            <div class="ai-typing-indicator" id="typing-indicator">
                <span class="dot"></span>
                <span class="dot"></span>
                <span class="dot"></span>
                <span id="loading-text" class="ml-2 text-sm" style="color: var(--text-secondary);"></span>
            </div>

            <!-- Eklenen Görsel Önizlemesi -->
            <div class="attachment-preview" id="attachment-preview">
                <img id="preview-image" src="" alt="Ek önizlemesi">
                <button class="remove-attachment" id="remove-attachment-btn">&times;</button>
            </div>

            <!-- Girdi Kutusu (Input Area) -->
            <div class="input-area-wrapper">
                <div class="input-area">
                    
                    <!-- Ataş (Dosya Yükleme) butonu -->
                    <button class="icon-btn" id="attachment-btn" title="Dosya Ekle (Görsel Analiz)">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-input" accept="image/*" class="hidden">

                    <!-- Görsel Oluşturma butonu (Hugging Face'e bağlı) -->
                    <button class="icon-btn" id="image-mode-btn" title="Görsel Oluşturma Modu">
                        <i class="fas fa-palette"></i>
                    </button>

                    <textarea id="chat-input" placeholder="N0thingAI'a bir mesaj gönder..." rows="1"></textarea>
                    
                    <button class="send-btn icon-btn" title="Gönder" id="send-btn">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Ayarlar ve Giriş Modalı -->
    <div id="settings-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-md modal-content relative">
            
            <!-- GİRİŞ YAP EKRANI (Varsayılan) -->
            <div id="modal-login-view" class="">
                <h2 class="text-xl font-bold mb-4 text-center">Giriş Yap</h2>
                <p class="text-center text-sm opacity-80 mb-4" style="color: var(--text-secondary);">Ayarlarınıza erişmek için giriş yapın.</p>
                
                <!-- HATA MESAJI ALANI (E-POSTA İÇİN) -->
                <p id="auth-error-message" class="text-center text-sm text-red-500 mb-4 hidden"></p>

                <div class="space-y-4">
                    <!-- SOSYAL GİRİŞ (KALDIRILDI) -->

                    <!-- Email/Şifre Alanı -->
                    <input id="email-input" type="email" placeholder="Email adresiniz" class="w-full p-3 rounded-lg border">
                    <input id="password-input" type="password" placeholder="Şifreniz" class="w-full p-3 rounded-lg border">
                    
                    <button id="email-signin-btn" class="w-full py-3 login-btn rounded-xl font-semibold">
                        Email ile Giriş Yap
                    </button>
                    <p class="text-xs text-center" style="color: var(--text-secondary);">
                        Hesabınız yok mu? 
                        <button id="show-signup-btn" class="font-bold underline hover:opacity-100" style="color: var(--text-primary);">Yeni Hesap Oluşturun</button>
                    </p>
                </div>
            </div>

            <!-- KAYIT OL EKRANI -->
            <div id="modal-signup-view" class="hidden">
                <h2 class="text-xl font-bold mb-4 text-center">Yeni Hesap Oluştur</h2>
                <!-- HATA MESAJI ALANI (KAYIT İÇİN) -->
                <p id="signup-error-message" class="text-center text-sm text-red-500 mb-4 hidden"></p>

                <input id="signup-email-input" type="email" placeholder="Email adresiniz" class="w-full p-3 rounded-lg border mb-4">
                <input id="signup-password-input" type="password" placeholder="Yeni şifreniz" class="w-full p-3 rounded-lg border mb-4">
                <button id="signup-btn" class="w-full py-3 login-btn rounded-xl font-semibold">
                    Kayıt Ol (Sign Up)
                </button>
                <p class="text-xs text-center mt-4" style="color: var(--text-secondary);">
                    Zaten bir hesabınız var mı? 
                    <button id="show-signin-btn" class="font-bold underline hover:opacity-100" style="color: var(--text-primary);">Giriş Yapın</button>
                </p>
            </div>


            <!-- Ayarlar Ekranı (Oturum Açıkken) -->
            <div id="modal-settings-view" class="hidden">
                 <h2 class="text-xl font-bold mb-6" id="modal-title-settings">Ayarlar</h2>
                 <div class="mb-4">
                    <label for="theme-selector" class="block text-sm font-medium mb-2" style="color: var(--text-secondary);">Tema Seçimi</label>
                    <select id="theme-selector" class="w-full p-3 rounded-lg border" style="background-color: var(--input-bg); color: var(--text-primary); border-color: var(--input-border);">
                        <!-- Düzeltildi: Varsayılan Gri/Beyaz Tema -->
                        <option value="dark-mode">Koyu Tema (Gri/Beyaz)</option> 
                        <option value="light-mode">Açık Tema (Beyaz/Gri)</option>
                    </select>
                 </div>
                 <button id="signout-btn" class="w-full p-3 mt-4 rounded-lg font-semibold border" style="border-color: var(--btn-border); transition: background-color 0.2s;">
                    <i class="fas fa-sign-out-alt mr-2"></i> Çıkış Yap
                 </button>
            </div>
            
            <button onclick="window.closeSettingsModal()" class="absolute top-4 right-4 text-xl opacity-70 hover:opacity-100" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <!-- YENİ: PREMIUM MODALI (ÖDEME İPTAL) -->
    <div id="premium-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center modal-overlay">
        <div class="p-6 rounded-xl shadow-2xl w-full max-w-md modal-content relative">
            <h2 class="text-xl font-bold mb-4 text-center">
                <i class="fas fa-star-half-alt mr-2" style="color: var(--highlight-color);"></i>
                N0thingAI Plus
            </h2>
            <p class="text-center text-sm opacity-80 mb-6" style="color: var(--text-secondary);">
                Limitleri kaldırın ve en gelişmiş özelliklere erişin.
            </p>
            
            <!-- ÖZELLİK LİSTESİ -->
            <div class="p-6 rounded-lg mb-6" style="background-color: var(--input-bg);">
                <ul class="space-y-3">
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        <span class="font-medium">Sınırsız</span> Mesaj
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        <span class="font-medium">Sınırsız</span> Görsel Oluşturma
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        <span class="font-medium">Sınırsız</span> Dosya Yükleme
                    </li>
                    <li class="flex items-center">
                        <i class="fas fa-check-circle text-green-500 mr-3"></i>
                        Gelecek tüm yeni özelliklere erken erişim
                    </li>
                </ul>
            </div>

            <!-- BUTON VE ÖDEME TALİMATLARI KALDIRILDI -->
            <p class="text-xs text-center mt-2" style="color: var(--text-secondary);">
                Otomatik ödeme sistemleri yakında eklenecektir.
            </p>
            
            <button onclick="window.closePremiumModal()" class="absolute top-4 right-4 text-xl opacity-70 hover:opacity-100" style="color: var(--text-secondary);">
                <i class="fas fa-times"></i>
            </button>
        </div>
    </div>
    
    <script type="module">
        // Firebase ve Google API Entegrasyonu
        // --- FIRESTORE IMPORTLARI YENİDEN EKLENDİ ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, signInAnonymously, 
            onAuthStateChanged, signOut,
            createUserWithEmailAndPassword, // Email ile kayıt için
            signInWithEmailAndPassword // Email ile giriş için
            // SOSYAL GİRİŞ IMPORTLARI KALDIRILDI
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        // --- FIRESTORE IMPORTLARI (Geçmiş ve KOTA için) ---
        import { 
            getFirestore, doc, setDoc, addDoc, collection, onSnapshot, 
            query, orderBy, serverTimestamp, getDoc,
            Timestamp // YENİ: Zaman damgası için
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- HİBRİT API Keys ve Modeller ---
        // 1. SOHBET + GÖRSEL ANALİZ (Google)
        const GEMINI_API_KEY = "AIzaSyCx4u1qHGlysIGpm1Zw0YBfXlqEXJ1BlvM"; 
        const CHAT_MODEL = "gemini-2.5-flash-preview-09-2025";
        
        // 2. GÖRSEL OLUŞTURMA (Hugging Face)
        const HUGGINGFACE_API_KEY = "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"; // Bu anahtarı kullan
        const IMAGE_GEN_MODEL = "https://api-inference.huggingface.co/models/stabilityai/stable-diffusion-xl-base-1.0";
        
        
        // --- KULLANICININ YENİ FIREBASE CONFIG BİLGİSİ ---
        const firebaseConfig = {
          apiKey: "AIzaSyAUM0DoLRAUoXsAxbcJOrerJIb_vT0GhS4",
          authDomain: "n0thingai-e8f3c.firebaseapp.com",
          projectId: "n0thingai-e8f3c",
          storageBucket: "n0thingai-e8f3c.firebasestorage.app",
          messagingSenderId: "266636496490",
          appId: "1:266636496490:web:b5250f6ba01a66bf860413"
          // measurementId Gerekli değil
        };
        
        // Firebase Servislerini Başlatma
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app); // Firestore (veritabanı) geri eklendi
            console.log("Firebase başarıyla başlatıldı."); // Başarı logu
        } catch (e) {
            console.error("Firebase başlatılamadı:", e);
            renderSystemMessage("**HATA:** Kimlik doğrulama servisi yüklenemedi.", "error");
        }
        
        // --- DOM Elements ---
        const MESSAGES_CONTAINER = document.getElementById('messages-container');
        const CHAT_INPUT = document.getElementById('chat-input');
        const SEND_BTN = document.getElementById('send-btn');
        const IMAGE_MODE_BTN = document.getElementById('image-mode-btn'); // Palet ikonu
        const NEW_CHAT_BTN = document.getElementById('new-chat-btn');
        const CURRENT_MODE_DISPLAY = document.getElementById('current-mode-display');
        const TYPING_INDICATOR = document.getElementById('typing-indicator');
        const LOADING_TEXT = document.getElementById('loading-text');
        
        // Sohbet Geçmişi Listesi (Geri Eklendi)
        const CHAT_HISTORY_LIST = document.getElementById('chat-history-list');

        // Attachment (Görsel Yükleme) Elements
        const ATTACHMENT_BTN = document.getElementById('attachment-btn');
        const FILE_INPUT = document.getElementById('file-input');
        const ATTACHMENT_PREVIEW = document.getElementById('attachment-preview');
        const PREVIEW_IMAGE = document.getElementById('preview-image');
        const REMOVE_ATTACHMENT_BTN = document.getElementById('remove-attachment-btn');
        
        // Auth/Modal Elements
        const AUTH_CONTAINER = document.getElementById('auth-container');
        const USER_PROFILE_VIEW = document.getElementById('user-profile-view');
        const LOGIN_VIEW = document.getElementById('login-view'); 
        const PROFILE_PIC = document.getElementById('profile-pic');
        const USER_NAME = document.getElementById('user-name');
        
        const SETTINGS_MODAL = document.getElementById('settings-modal');
        const MODAL_LOGIN_VIEW = document.getElementById('modal-login-view');
        const MODAL_SIGNUP_VIEW = document.getElementById('modal-signup-view');
        const MODAL_SETTINGS_VIEW = document.getElementById('modal-settings-view');
        const THEME_SELECTOR = document.getElementById('theme-selector');
        
        // YENİ: Premium Modal Elements
        const PREMIUM_MODAL = document.getElementById('premium-modal');
        const PLUS_BTN = document.getElementById('plus-btn');
        // const CHECKOUT_BTN = document.getElementById('checkout-btn'); // MANUEL İPTAL

        // Hata Mesajı Alanları
        const AUTH_ERROR_MESSAGE = document.getElementById('auth-error-message');
        const SIGNUP_ERROR_MESSAGE = document.getElementById('signup-error-message');

        // Giriş/Kayıt Butonları
        // SOSYAL GİRİŞ BUTONLARI KALDIRILDI
        const EMAIL_INPUT = document.getElementById('email-input');
        const PASSWORD_INPUT = document.getElementById('password-input');
        const EMAIL_SIGNIN_BTN = document.getElementById('email-signin-btn');
        const SIGNUP_BTN = document.getElementById('signup-btn');
        const SIGNOUT_BTN = document.getElementById('signout-btn');
        const SHOW_SIGNUP_BTN = document.getElementById('show-signup-btn');
        const SHOW_SIGNIN_BTN = document.getElementById('show-signin-btn');
        const SIGNUP_EMAIL_INPUT = document.getElementById('signup-email-input');
        const SIGNUP_PASSWORD_INPUT = document.getElementById('signup-password-input');

        // Mobil Sidebar
        const SIDEBAR = document.getElementById('sidebar');
        const OPEN_SIDEBAR_BTN = document.getElementById('open-sidebar-btn');
        const CLOSE_SIDEBAR_BTN = document.getElementById('close-sidebar-btn');
        const MOBILE_OVERLAY = document.getElementById('mobile-overlay');
        
        // YENİ: En Alta Kaydırma
        const SCROLL_TO_BOTTOM_BTN = document.getElementById('scroll-to-bottom-btn');

        // --- YENİ: KOTA LİMİTLERİ ---
        const QUOTAS = {
            anonymous: {
                messages: 5, // Toplam (Günlük değil)
                images: 0,
                files: 0
            },
            normal: {
                messages: 50, // Günlük
                images: 1,  // Günlük
                files: 5    // Günlük
            },
            plus: {
                messages: Infinity,
                images: Infinity,
                files: Infinity
            }
        };

        // --- Global State (Geçmiş Eklendi) ---
        let chatMode = 'text'; // 'text' (Chat) or 'image' (Generation)
        let isWaitingForResponse = false;
        let attachedImageBase64 = null; // Base64 string for multimodal chat
        
        let currentUserId = null; // Firebase Auth User ID
        let currentChatId = null; // Aktif sohbetin Firestore ID'si
        let unsubscribeChat = null; // Aktif sohbet dinleyicisini
        let unsubscribeHistory = null; // Sohbet listesi dinleyicisini
        
        // YENİ: KOTA DURUMU
        let currentUserRole = 'anonymous'; // 'anonymous', 'normal', 'plus'
        let anonymousMessageCount = 0; // Sadece anonim için toplam sayaç
        let dailyUsage = {}; // Firestore'dan gelen günlük kullanım
        

        /**
         * API Çağrısını Üstlenir (HİBRİT: Gemini ve Hugging Face)
         * model: 'gemini' or 'huggingface'
         * payload: API'ye gönderilecek JSON gövdesi
         * apiKey: Kullanılacak API anahtarı
         */
        async function fetchWithRetry(model, payload, apiKey) {
            let url = '';
            let headers = { 'Content-Type': 'application/json' };
            let responseType = 'json'; // Varsayılan yanıt tipi

            if (model === 'gemini') {
                url = `https://generativelanguage.googleapis.com/v1beta/models/${CHAT_MODEL}:generateContent?key=${apiKey}`;
            } else if (model === 'huggingface') {
                url = IMAGE_GEN_MODEL; // HF URL
                headers['Authorization'] = `Bearer ${apiKey}`; // HF Auth Header
                responseType = 'blob'; // HF görsel yanıtı blob'dur
            } else {
                renderSystemMessage("Hata: Geçersiz API modeli.", "error");
                return null;
            }

            const MAX_RETRIES = 3;
            let attempt = 0;

            while (attempt < MAX_RETRIES) {
                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: headers,
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 503) { // HF Model yükleniyor
                        throw new Error("503");
                    }
                    if (!response.ok) {
                        // HF hatası (JSON değilse)
                        if (responseType === 'blob') {
                            const errorText = await response.text();
                            throw new Error(`API Hatası (${response.status}): ${errorText}`);
                        }
                        const errorData = await response.json();
                        throw new Error(`API Hatası (${response.status}): ${errorData.error?.message || 'Bilinmeyen Hata'}`);
                    }
                    
                    // Başarılı yanıt
                    if (responseType === 'json') {
                        return await response.json();
                    } else if (responseType === 'blob') {
                        return await response.blob();
                    }

                } catch (error) {
                    attempt++;
                    if (error.message === "503") {
                        showTypingIndicator("Hugging Face modeli yükleniyor... (Bu 1-2 dk sürebilir)");
                        await new Promise(resolve => setTimeout(resolve, 10000 * attempt)); // HF için gecikmeyi artır
                    } else {
                        console.error(`API Denemesi ${attempt} başarısız:`, error);
                        if (attempt >= MAX_RETRIES) {
                             renderSystemMessage(`**HATA:** ${error.message}`, "error");
                             return null; // Null döndür
                        }
                    }
                }
            }
            // Döngü bittiyse ve hala hata varsa
            return null;
        }

        // --- UI Helper Functions ---

        function autoScroll() {
            MESSAGES_CONTAINER.scrollTop = MESSAGES_CONTAINER.scrollHeight;
            if (SCROLL_TO_BOTTOM_BTN) SCROLL_TO_BOTTOM_BTN.style.display = 'none'; // YENİ: Otomatik kaydırınca butonu gizle
        }

        function showTypingIndicator(text = "") {
            isWaitingForResponse = true;
            toggleInput(true); // Girdiyi kilitle
            if(LOADING_TEXT) LOADING_TEXT.textContent = text || "N0thingAI düşünüyor...";
            if(TYPING_INDICATOR) TYPING_INDICATOR.classList.add('visible');
            // İndikatörü mesajların sonuna taşı
            if(MESSAGES_CONTAINER) MESSAGES_CONTAINER.appendChild(TYPING_INDICATOR);
            autoScroll();
        }

        function hideTypingIndicator() {
            isWaitingForResponse = false;
            toggleInput(false); // Girdiyi aç
            if(TYPING_INDICATOR) TYPING_INDICATOR.classList.remove('visible');
        }

        function toggleInput(disabled) {
            CHAT_INPUT.disabled = disabled;
            SEND_BTN.disabled = disabled;
            ATTACHMENT_BTN.disabled = disabled;
            IMAGE_MODE_BTN.disabled = disabled; // API çağrısı sırasında mod değiştirilemesin
            
            if (disabled) {
                CHAT_INPUT.placeholder = "Yanıt bekleniyor...";
            } else {
                setChatMode(chatMode, false); // Modu ve placeholder'ı yenile
            }
        }

        function renderSystemMessage(text, type = "info") {
             const systemMessageHTML = `
                <div class="message-row system-message-row">
                    <div class="message-content ${type === 'error' ? 'error' : ''}">
                        ${text}
                    </div>
                </div>
             `;
             MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', systemMessageHTML);
             autoScroll();
        }

        function addMessageToUI(text, sender) {
             const messageClass = sender === 'user' ? 'user-message-row' : 'ai-message-row';
             // Metni güvenli hale getir (HTML enjeksiyonunu önle)
             const safeText = document.createTextNode(text).textContent;
             
             const messageHTML = `
                <div class="message-row ${messageClass}">
                    <div class="message-content">
                        ${safeText.replace(/\n/g, '<br>')}
                    </div>
                </div>
             `;
             MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', messageHTML);
        }
        
        function addImageToUI(imageUrl, altText) {
            // Görseli AI mesajı olarak ekle
             const imageHTML = `
                <div class="message-row ai-message-row">
                    <div class="message-content">
                        <p class="text-sm italic mb-2" style="color: var(--text-secondary);">${altText}</p>
                        <div class="image-container">
                            <img src="${imageUrl}" alt="${altText}" loading="lazy" />
                        </div>
                    </div>
                </div>
             `;
             MESSAGES_CONTAINER.insertAdjacentHTML('beforeend', imageHTML);
        }
        
        // --- Core Application Logic (Firestore Eklendi) ---

        function setChatMode(mode, notify = true) {
            chatMode = mode;
            
            if (mode === 'image') {
                // GÖRSEL MODU (Hugging Face)
                if(CURRENT_MODE_DISPLAY) CURRENT_MODE_DISPLAY.textContent = "Görsel Modu"; // "HF" kaldırıldı
                if(CHAT_INPUT) CHAT_INPUT.placeholder = "Görsel tanımını (prompt) girin...";
                if(IMAGE_MODE_BTN) IMAGE_MODE_BTN.classList.add('text-green-500'); // Aktif olduğunu göstermek için yeşil yap
                if(notify) renderSystemMessage("Görsel Modu **AKTİF**. (Sohbet etmek için 'Sohbet Modu'na geçin)"); // "Hugging Face" kaldırıldı
                
            } else {
                // Sohbet Modu (Gemini)
                if(CURRENT_MODE_DISPLAY) CURRENT_MODE_DISPLAY.textContent = "Sohbet Modu"; // "Gemini" kaldırıldı
                if(CHAT_INPUT) CHAT_INPUT.placeholder = "N0thingAI'a bir mesaj gönder...";
                if(IMAGE_MODE_BTN) IMAGE_MODE_BTN.classList.remove('text-green-500'); // Varsa yeşil vurguyu kaldır
                if(notify) {
                     // Anonimse ve yeni sohbetse limiti göster
                    if (currentUserRole === 'anonymous' && !currentChatId) {
                         renderSystemMessage(`Sohbet Modu **AKTİF**. (Toplam ${QUOTAS.anonymous.messages} mesaj hakkınız var. Daha fazlası için lütfen giriş yapın.)`);
                    } else if (currentUserRole === 'normal' && !currentChatId) {
                         // Günlük kalan hakkı göstermek için 'dailyUsage'in yüklenmiş olması lazım
                         const remainingMessages = QUOTAS.normal.messages - (dailyUsage.messages || 0);
                         renderSystemMessage(`Sohbet Modu **AKTİF**. (Bugün ${remainingMessages} mesaj hakkınız kaldı)`);
                    } else if (!currentChatId) { // Plus ve yeni sohbetse
                         renderSystemMessage("Sohbet Modu **AKTİF**.");
                    }
                    // (Eski sohbete tıklandıysa (currentChatId var), sistem mesajı gösterme)
                }
            }
            autoScroll();
        }

        function toggleChatMode() {
            // Mod değiştirme
            if (chatMode === 'text') {
                setChatMode('image', true);
            } else {
                setChatMode('text', true);
            }
        }

        async function startNewChat() {
            if (isWaitingForResponse) return;
            
            // Aktif sohbeti ve dinleyiciyi durdur
            if (unsubscribeChat) unsubscribeChat();
            unsubscribeChat = null;
            currentChatId = null;
            
            MESSAGES_CONTAINER.innerHTML = '';
            removeAttachment(); // Varsa ekli görseli temizle
            
            // YENİ: Başlangıç mesajını role göre ayarla
            if (currentUserRole === 'anonymous') {
                anonymousMessageCount = 0; // Toplam sayacı sıfırla
                // DÜZELTME: Giriş yapma uyarısı eklendi
                renderSystemMessage(`Sohbet Modu **AKTİF**. (Toplam ${QUOTAS.anonymous.messages} mesaj hakkınız var. Daha fazlası için lütfen giriş yapın.)`);
            } else if (currentUserRole === 'normal') {
                // Kalan hakkı göster
                const remainingMessages = QUOTAS.normal.messages - (dailyUsage.messages || 0);
                renderSystemMessage(`Sohbet Modu **AKTİF**. (Bugün ${remainingMessages} mesaj hakkınız kaldı)`);
            } else {
                renderSystemMessage("Sohbet Modu **AKTİF**. N0thingAI ile konuşmaya başlayın.");
            }

            setChatMode('text', false); // Modu 'text' olarak ayarla, bildirim (notify) yapma
            
            // Sidebar'daki aktif seçimi kaldır
            document.querySelectorAll('#chat-history-list .chat-item.active').forEach(item => {
                item.classList.remove('active');
            });
        }
        
        /**
         * Mesajları Firebase'e kaydeder
         */
        async function saveMessage(text, sender, imageUrl = null) {
            // YENİ: Anonim kullanıcılar UI'a kaydeder (veritabanına değil)
            if (currentUserRole === 'anonymous') {
                // UI'ı yine de güncelle (geçici)
                if (imageUrl) addImageToUI(imageUrl, text);
                else addMessageToUI(text, sender);
                return; // Kaydetmeden çık
            }

            // Buradan sonrası sadece giriş yapmış kullanıcılar için çalışır (normal, plus)
            const userId = auth.currentUser.uid;
            let chatToUse = currentChatId;

            try {
                // Eğer bu yeni bir sohbetse (currentChatId null),
                // önce bir sohbet dokümanı oluştur.
                if (!chatToUse) {
                    // Güvenlik kurallarına uygun yolu kullan
                    const chatRef = await addDoc(collection(db, "users", userId, "chats"), {
                        title: text.substring(0, 30) + "...", // İlk mesajdan başlık
                        createdAt: serverTimestamp()
                    });
                    chatToUse = chatRef.id;
                    currentChatId = chatToUse; // Global ID'yi güncelle
                    
                    // Yeni sohbeti dinlemeye başla (history listener bunu otomatik yakalamaz)
                    listenToChat(userId, chatToUse); 
                }

                // Mesajı o sohbetin 'messages' alt koleksiyonuna ekle
                await addDoc(collection(db, "users", userId, "chats", chatToUse, "messages"), {
                    sender: sender,
                    text: text,
                    imageUrl: imageUrl || null,
                    createdAt: serverTimestamp()
                });

            } catch (error) {
                console.error("Mesaj kaydedilemedi:", error);
                renderSystemMessage(`**HATA:** Mesajınız veritabanına kaydedilemedi. ${error.message}`, "error");
            }
            // Not: Artık onSnapshot dinleyicisi UI'ı güncelleyecek.
        }
        
        // --- GÖRSEL OLUŞTURMA (Hugging Face) ---
        
        /**
         * Türkçe prompt'u alıp, optimize edilmiş İngilizce prompt'a çevirir (Gemini ile)
         */
        async function translateAndOptimizePrompt(turkishPrompt) {
            showTypingIndicator("Görsel tanımı optimize ediliyor...");

            const systemInstruction = `You are a professional prompt engineer specializing in image generation (like Midjourney/DALL-E). Your task is to take the user's Turkish description and turn it into a single, detailed, highly descriptive English prompt, optimized for quality image output. 
            Do not add any conversational text, just the prompt.`;

            const payload = {
                contents: [{ parts: [{ text: `Translate and optimize this Turkish prompt for image generation: ${turkishPrompt}` }] }],
                systemInstruction: { parts: [{ text: systemInstruction }] },
            };

            try {
                // Çeviri için 'gemini' modelini kullan
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY);
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;
                
                if (text) {
                     return text.trim().replace(/^['"]|['"]$/g, '');
                }
                return turkishPrompt; // Optimize edilemezse orijinalini döndür
            } catch (error) {
                console.error('Prompt Çeviri/Optimizasyon Hatası:', error);
                return turkishPrompt; 
            }
        }
        
        /**
         * Kullanıcı mesajını ve (varsa) görseli AI'ye gönderir (Gemini Sohbet)
         */
        async function fetchGeminiResponse(userPrompt) {
            showTypingIndicator("N0thingAI düşünüyor...");
            
            let parts = [{ "text": userPrompt }];
            
            // Eğer ekli bir görsel varsa, API isteğine ekle (Görsel Analiz)
            if (attachedImageBase64) {
                parts.unshift({ // Görseli metinden önce ekle
                    "inline_data": {
                        "mime_type": "image/jpeg", // Varsayılan tip, handleFileSelect'te ayarlanabilir
                        "data": attachedImageBase64
                    }
                });
            }

            const payload = {
                "contents": [
                    { "parts": parts }
                ],
                // "generationConfig": { ... } // Gerekirse
            };

            let responseText = "Üzgünüm, bir hata oluştu. Lütfen tekrar deneyin.";

            try {
                const result = await fetchWithRetry('gemini', payload, GEMINI_API_KEY);
                
                if (result && result.candidates && result.candidates[0].content) {
                    responseText = result.candidates[0].content.parts[0].text;
                } else {
                    responseText = "API'den geçerli bir yanıt alınamadı.";
                }

            } catch (error) {
                console.error("Gemini Hatası:", error);
                responseText = `Hata: ${error.message}`;
            } finally {
                hideTypingIndicator();
                removeAttachment(); // Mesaj gönderildikten sonra eki temizle
                await saveMessage(responseText, 'ai'); // AI yanıtını kaydet
            }
        }
        
        /**
         * Hugging Face (SDXL) kullanarak görsel oluşturur
         */
        async function generateImage(userPrompt) {
            // 1. Türkçe prompt'u optimize et (Gemini ile)
            const optimizedPrompt = await translateAndOptimizePrompt(userPrompt);

            // 2. Hugging Face'e istek at
            showTypingIndicator(`Görsel oluşturuluyor: "${optimizedPrompt.substring(0, 40)}..."`);
            
            const payload = { 
                inputs: optimizedPrompt
            };

            let generatedBase64 = null;
            let aiMessage = "Görsel oluşturma başarısız oldu. Lütfen daha açıklayıcı bir tanım deneyin veya API anahtarınızı kontrol edin.";

            try {
                // 'huggingface' modelini çağır
                const imageBlob = await fetchWithRetry('huggingface', payload, HUGGINGFACE_API_KEY);
                
                if (imageBlob && imageBlob.size > 0) {
                    // Blob'u Base64'e çevir
                    generatedBase64 = await new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result); // Bu data:image/png... içerir
                        reader.onerror = reject;
                        reader.readAsDataURL(imageBlob);
                    });
                } else if (imageBlob) { // Hata (null değil) ama blob boş
                    aiMessage = "API'den görsel alınamadı, ancak hata da dönmedi. Lütfen tekrar deneyin.";
                    await saveMessage(aiMessage, 'ai');
                }
                // (Eğer result null ise, fetchWithRetry zaten sistem mesajı göstermiştir)

            } catch (error) {
                console.error('Görsel API Çağrısı Hatası:', error);
                // (fetchWithRetry zaten hatayı gösterdi)
            } finally {
                hideTypingIndicator();
                
                if (generatedBase64) {
                    // AI yanıtını görsel (base64) ve prompt metni olarak kaydet
                    await saveMessage(optimizedPrompt, 'ai', generatedBase64); // Base64 URL olarak kaydet
                }
            }
        }
        
        // --- YENİ: GÜNLÜK KOTA KONTROLÜ (Usage Check) ---
        
        /**
         * Bugünün tarihini YYYY-MM-DD formatında döndürür
         */
        function getTodayDateString() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }

        /**
         * HATA DÜZELTMESİ: Veri yolunu (users/{uid}/profile/usage) olarak güncelledim.
         */
        async function checkUsageLimit(userId, actionType) { // actionType: 'messages', 'images', 'files'
            if (!db || !userId) return false; // Veritabanı yoksa engelle

            // 1. Kullanıcının rolünü (isPremium) ve günlük kullanımını al
            // (Güvenlik kurallarına uygun olarak /profile/usage yolunu kullan)
            const profileRef = doc(db, "users", userId, "profile", "usage");
            const profileDoc = await getDoc(profileRef);
            
            let isPremium = false;
            let currentUsage = {
                date: getTodayDateString(),
                messages: 0,
                images: 0,
                files: 0
            };
            
            if (profileDoc.exists()) {
                const data = profileDoc.data();
                if (data.isPremium === true) {
                    isPremium = true;
                    currentUserRole = 'plus'; // Global rolü güncelle
                } else {
                    currentUserRole = 'normal'; // Global rolü güncelle
                }

                // Günlük kullanımı kontrol et
                const todayStr = getTodayDateString();
                if (data.date === todayStr) {
                    currentUsage = data; // Dünkü veriyi değil, bugünkü veriyi al
                }
                // (Eğer tarih farklıysa, 'currentUsage' (sıfırlanmış hali) kullanılır)
                
            } else {
                 currentUserRole = 'normal'; // Varsayılan
            }


            // 2. Plus kullanıcıysa, limiti kontrol etme
            if (isPremium) {
                return true; // Sınırsız
            }
            
            // 3. Normal kullanıcıysa, günlük kotayı kontrol et
            const limit = QUOTAS.normal[actionType];
            const currentCount = currentUsage[actionType] || 0;
            
            if (currentCount >= limit) {
                // Limit aşıldı
                let actionName = "";
                if(actionType === 'messages') actionName = "mesaj";
                else if(actionType === 'images') actionName = "görsel oluşturma";
                else if(actionType === 'files') actionName = "dosya yükleme";
                
                renderSystemMessage(`Günlük ${actionName} limitinize ulaştınız (${limit}/${limit}). Sınırsız kullanım için lütfen N0thingAI Plus'a geçin.`, "error");
                window.openPremiumModal(); // Premium modalını aç
                return false;
            }
            
            // 4. Limite ulaşılmadı, sayacı artır ve veritabanını güncelle
            currentUsage[actionType] = currentCount + 1;
            currentUsage.date = getTodayDateString(); // Tarihi güncelle
            
            // 'isPremium' durumunu (varsa) koruyarak yaz
            // (Mevcut veriyi okuyup üzerine yazmak daha güvenli olur)
            const existingData = profileDoc.exists() ? profileDoc.data() : {};
            await setDoc(profileRef, { ...existingData, ...currentUsage }); 
            dailyUsage = currentUsage; // Global kullanımı güncelle
            
            return true; // İzin verildi
        }


        async function sendMessage() {
            const text = CHAT_INPUT.value.trim();
            if (text === "" && !attachedImageBase64) return; // Gönderecek bir şey yoksa
            
            if (!auth || !auth.currentUser) {
                renderSystemMessage("Mesaj göndermek için lütfen giriş yapın.", "error");
                window.openSettingsModal();
                return;
            }
            
            const userId = auth.currentUser.uid;
            let action = 'messages'; // Varsayılan sohbet
            
            if (chatMode === 'image') action = 'images';
            if (attachedImageBase64) action = 'files'; // Dosya yükleme (mesajdan daha öncelikli)

            // --- YENİ: LİMİT KONTROLÜ (sendMessage) ---
            if (auth.currentUser.isAnonymous) {
                // ANONİM KULLANICI
                
                // Görsel veya dosya yüklemeye çalışırsa engelle
                if (action === 'images' || action === 'files') {
                     renderSystemMessage("Görsel oluşturmak veya dosya yüklemek için lütfen giriş yapın.", "error");
                     window.openSettingsModal();
                     return;
                }
                
                // Mesaj limitini kontrol et
                if (anonymousMessageCount >= QUOTAS.anonymous.messages) {
                    renderSystemMessage("Mesaj limitinize ulaştınız. Devam etmek için lütfen giriş yapın.", "error");
                    window.openSettingsModal(); // Giriş modalını aç
                    return; // Mesajı göndermeyi engelle
                }
                anonymousMessageCount++;
                const remaining = QUOTAS.anonymous.messages - anonymousMessageCount;
                if (remaining > 0) {
                     renderSystemMessage(`(Kalan ${remaining} mesaj hakkınız.)`, "info");
                } else {
                     renderSystemMessage("Son mesaj hakkınızı kullandınız. Lütfen giriş yapın.", "info");
                }
            } else {
                // GİRİŞ YAPMIŞ KULLANICI (Normal veya Plus)
                const allowed = await checkUsageLimit(userId, action);
                if (!allowed) {
                    return; // Limit aşıldı, gönderme
                }
            }
            // --- LİMİT KONTROLÜ SONU ---


            // Mesajı göndermeden ÖNCE kaydet (UI ve/veya DB için)
            await saveMessage(text || "(Görsel eklendi)", 'user');

            CHAT_INPUT.value = '';
            autoResizeTextarea(); // Textarea'yı küçült

            if (chatMode === 'image') {
                // Görsel modu (Hugging Face)
                await generateImage(text);
            } else {
                // Sohbet modu (Gemini) veya Görsel Analiz (Gemini)
                await fetchGeminiResponse(text);
            }
        }

        function handleKey(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault(); // Yeni satır oluşturmayı engelle
                sendMessage();
            }
        }
        
        // --- Attachment (Görsel Yükleme) Fonksiyonları ---

        async function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!auth || !auth.currentUser) {
                renderSystemMessage("Dosya yüklemek için lütfen giriş yapın.", "error");
                window.openSettingsModal();
                return;
            }
            
            // --- YENİ: LİMİT KONTROLÜ (handleFileSelect) ---
            if (auth.currentUser.isAnonymous) {
                renderSystemMessage("Dosya yüklemek için lütfen giriş yapın.", "error");
                window.openSettingsModal();
                return;
            } 
            // (Limit kontrolü artık sendMessage içinde yapılıyor, eklendiğinde değil)
            // --- LİMİT KONTROLÜ SONU ---

            
            // Sadece resim dosyalarına izin ver
            if (!file.type.startsWith('image/')) {
                renderSystemMessage("Hata: Yalnızca resim dosyaları yüklenebilir.", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                attachedImageBase64 = e.target.result.split(',')[1]; // Base64 datasını al (header olmadan)
                if (PREVIEW_IMAGE) PREVIEW_IMAGE.src = e.target.result;
                if (ATTACHMENT_PREVIEW) ATTACHMENT_PREVIEW.style.display = 'block';
                if (ATTACHMENT_BTN) ATTACHMENT_BTN.classList.add('text-green-500'); // Buton rengini değiştir
                
                // Görsel ekliyken sohbet moduna zorla (görsel analiz için)
                if (chatMode === 'image') {
                    setChatMode('text', false);
                }
                CHAT_INPUT.placeholder = "Görsel hakkında bir soru sorun...";
            };
            reader.onerror = (e) => {
                console.error("Dosya okuma hatası:", e);
                renderSystemMessage("Hata: Dosya okunurken bir sorun oluştu.", "error");
            };
            reader.readAsDataURL(file);
            
            // Aynı dosyayı tekrar seçebilmek için inputu sıfırla
            event.target.value = null;
        }

        function removeAttachment() {
            attachedImageBase64 = null;
            if (ATTACHMENT_PREVIEW) ATTACHMENT_PREVIEW.style.display = 'none';
            if (PREVIEW_IMAGE) PREVIEW_IMAGE.src = '';
            if (ATTACHMENT_BTN) ATTACHMENT_BTN.classList.remove('text-green-500');
            // Placeholder'ı normale döndür
            setChatMode(chatMode, false);
        }

        // Textarea'yı içeriğe göre otomatik büyüt/küçült
        function autoResizeTextarea() {
            CHAT_INPUT.style.height = 'auto'; // Yüksekliği sıfırla
            CHAT_INPUT.style.height = (CHAT_INPUT.scrollHeight) + 'px'; // İçerik yüksekliğine ayarla
        }

        
        // --- Auth Functions (Global Scope'a Taşıma) ---
        
        window.openSettingsModal = () => {
            if (!SETTINGS_MODAL || !MODAL_SETTINGS_VIEW || !MODAL_LOGIN_VIEW) {
                console.error("Modal elementleri bulunamadı.");
                return;
            }
            // Hata mesajlarını temizle
            if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden');
            if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden');
            
            SETTINGS_MODAL.classList.remove('hidden');
            
            // Auth durumunu kontrol et
            if (auth && auth.currentUser && !auth.currentUser.isAnonymous) {
                // Giriş yapmış kullanıcı -> Ayarları göster
                MODAL_LOGIN_VIEW.classList.add('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                MODAL_SETTINGS_VIEW.classList.remove('hidden');
            } else {
                // Giriş yapmamış/Anonim -> Giriş ekranını göster
                MODAL_LOGIN_VIEW.classList.remove('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                MODAL_SETTINGS_VIEW.classList.add('hidden');
            }
            
            updateThemeSpecificElements();
        };

        window.closeSettingsModal = () => {
            if (SETTINGS_MODAL) SETTINGS_MODAL.classList.add('hidden');
        };
        
        // YENİ: Premium Modal Fonksiyonları
        window.openPremiumModal = () => {
            // Giriş yapmamışsa, önce giriş modalını aç
            if (auth && auth.currentUser && auth.currentUser.isAnonymous) {
                window.openSettingsModal();
                return;
            }
            if (PREMIUM_MODAL) PREMIUM_MODAL.classList.remove('hidden');
        };
        window.closePremiumModal = () => {
            if (PREMIUM_MODAL) PREMIUM_MODAL.classList.add('hidden');
        };
        
        // ÖDEME BUTONU KALDIRILDI
        // window.handleCheckout = () => { ... };

        // (SOSYAL GİRİŞ FONKSİYONLARI KALDIRILDI)

        // Hata mesajlarını merkezileştirme ve Modal'da gösterme
        function renderAuthError(error, view = 'login') {
            let errorMessage = "Bilinmeyen bir hata oluştu.";
            if (error.code === 'auth/wrong-password' || error.code === 'auth/user-not-found' || error.code === 'auth/invalid-credential') {
                errorMessage = "Girdiğiniz e-posta veya şifre yanlış.";
            } else if (error.code === 'auth/email-already-in-use') {
                errorMessage = "Bu e-posta adresi zaten kayıtlı.";
            } else if (error.code === 'auth/weak-password') {
                errorMessage = "Şifre en az 6 karakter olmalıdır.";
            } else if (error.code === 'auth/invalid-email') {
                errorMessage = "Geçersiz e-posta adresi formatı.";
            } else if (error.code === 'auth/configuration-not-found') {
                 errorMessage = "Giriş yöntemi (Email) Firebase'de etkin değil.";
            } else {
                errorMessage = error.message;
            }

            if (view === 'login' && AUTH_ERROR_MESSAGE) {
                AUTH_ERROR_MESSAGE.textContent = errorMessage;
                AUTH_ERROR_MESSAGE.classList.remove('hidden');
            } else if (view === 'signup' && SIGNUP_ERROR_MESSAGE) {
                SIGNUP_ERROR_MESSAGE.textContent = errorMessage;
                SIGNUP_ERROR_MESSAGE.classList.remove('hidden');
            } else {
                // Modal'da değilse sistem mesajı olarak göster
                renderSystemMessage(`**Giriş Hatası:** ${errorMessage}`, "error");
            }
        }


        async function signInWithEmail() {
            if (!auth) return;
            try {
                const email = EMAIL_INPUT.value;
                const password = PASSWORD_INPUT.value;
                if (!email || !password) {
                    renderAuthError({ code: 'auth/missing-fields', message: "Email ve şifre alanları boş bırakılamaz." }, 'login');
                    return;
                }
                await signInWithEmailAndPassword(auth, email, password);
                window.closeSettingsModal();
            } catch (error) {
                console.error("Email Giriş Hatası:", error);
                renderAuthError(error, "login");
            }
        }

        async function signUpWithEmail() {
            if (!auth) return;
            try {
                const email = SIGNUP_EMAIL_INPUT.value;
                const password = SIGNUP_PASSWORD_INPUT.value;
                if (!email || !password) {
                    renderAuthError({ code: 'auth/missing-fields', message: "Email ve şifre alanları boş bırakılamaz." }, 'signup');
                    return;
                }
                if (password.length < 6) {
                    renderAuthError({ code: 'auth/weak-password' }, 'signup');
                    return;
                }
                
                const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                
                // YENİ: Kayıt olunca, kullanıcıya 'users' ve 'userUsage' koleksiyonlarında varsayılan kayıtları oluştur
                if (userCredential.user && db) {
                    const userId = userCredential.user.uid;
                    
                    // HATA DÜZELTMESİ: Güvenlik kurallarına uygun yolu kullan
                    // (Artık users/{uid}/profile/usage kullanıyoruz)
                    const profileRef = doc(db, "users", userId, "profile", "usage");
                    await setDoc(profileRef, {
                        email: userCredential.user.email,
                        isPremium: false, // Varsayılan olarak premium değil
                        date: getTodayDateString(),
                        messages: 0,
                        images: 0,
                        files: 0
                    });
                }
                
                window.closeSettingsModal();
                renderSystemMessage("**Başarılı:** Kayıt oldunuz ve giriş yaptınız.");
            } catch (error) {
                console.error("Email Kayıt Hatası:", error);
                renderAuthError(error, "signup");
            }
        }


        async function signOutUser() {
            if (!auth) return;
            try {
                await signOut(auth);
                window.closeSettingsModal();
                renderSystemMessage("Başarıyla çıkış yaptınız.");
            } catch (error) {
                 console.error("Çıkış Hatası:", error);
            }
        }
        
        
        // --- YENİ: Sohbet ve Geçmiş Dinleyicileri ---
        
        /**
         * Belirli bir sohbetin mesajlarını dinler
         */
        function listenToChat(userId, chatId) {
            if (!db) return;
            if (unsubscribeChat) unsubscribeChat(); // Önceki sohbeti dinlemeyi bırak

            currentChatId = chatId;
            MESSAGES_CONTAINER.innerHTML = ''; // Yeni sohbet için ekranı temizle

            const messagesQuery = query(
                collection(db, "users", userId, "chats", chatId, "messages"),
                orderBy("createdAt", "asc")
            );

            unsubscribeChat = onSnapshot(messagesQuery, (snapshot) => {
                MESSAGES_CONTAINER.innerHTML = ''; // Her güncellemede temizle ve yeniden çiz
                if (snapshot.empty) {
                    renderSystemMessage("Sohbet Modu **AKTİF**...");
                }
                snapshot.forEach(doc => {
                    const msg = doc.data();
                    // GÖRSEL OLUŞTURMA AKTİF: UI'ı güncelle
                    if (msg.imageUrl && msg.sender === 'ai') { // Sadece AI görsellerini
                        // Base64 verisi (kaydedilmişse) veya URL
                        const imageUrl = msg.imageUrl; // Veritabanına data:image olarak kaydettik
                        addImageToUI(imageUrl, `Görsel tanımı: "${msg.text}"`);
                    } else {
                        addMessageToUI(msg.text, msg.sender);
                    }
                });
                autoScroll();
            }, (error) => {
                console.error("Sohbet dinlenirken hata:", error);
                renderSystemMessage(`**HATA:** Sohbet yüklenemedi. ${error.message}`, "error");
            });
        }
        
        /**
         * Kullanıcının sohbet listesini dinler (Sidebar için)
         */
        function listenToChatHistory(userId) {
            if (!db) return;
            if (unsubscribeHistory) unsubscribeHistory(); // Önceki listeyi dinlemeyi bırak

            const historyQuery = query(
                collection(db, "users", userId, "chats"),
                orderBy("createdAt", "desc")
            );

            unsubscribeHistory = onSnapshot(historyQuery, (snapshot) => {
                // Mevcut DOM'daki item'ları temizle (mod göstergesi hariç)
                document.querySelectorAll('#chat-history-list .chat-item').forEach(item => item.remove());
                
                snapshot.forEach(doc => {
                    const chat = doc.data();
                    const chatId = doc.id;
                    const li = document.createElement('li');
                    li.className = 'chat-item'; // CSS değişkenlerini kullanan stil
                    li.textContent = chat.title || "Yeni Sohbet";
                    li.dataset.chatId = chatId; // ID'yi sakla
                    
                    if (chatId === currentChatId) {
                        li.classList.add('active'); // Aktif stili uygula
                    }

                    li.onclick = () => {
                        // Aktif stili ayarla
                        document.querySelectorAll('#chat-history-list .chat-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        li.classList.add('active');
                        
                        listenToChat(userId, chatId);
                    };
                    CHAT_HISTORY_LIST.appendChild(li);
                });
            }, (error) => {
                console.error("Geçmiş listesi dinlenirken hata:", error);
            });
        }


        /**
         * Auth durumunu dinler ve UI'ı günceller
         */
        async function setupAuthListener() {
            if (!auth) {
                console.log("Firebase Auth bulunamadı, giriş yapılamaz.");
                if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
                startNewChat(); // Sohbeti başlat
                renderSystemMessage("Kimlik doğrulama hizmeti yüklenemedi. Lütfen giriş yapmayı denemeyin.", "error");
                return;
            }
            
            onAuthStateChanged(auth, async (user) => {
                
                // YENİ: KOTA SIFIRLAMA ve ROL AYARLAMA
                // Önceki dinleyicileri (varsa) temizle
                if (unsubscribeChat) unsubscribeChat();
                if (unsubscribeHistory) unsubscribeHistory();
                unsubscribeChat = null;
                unsubscribeHistory = null;
                dailyUsage = {}; // Günlük kullanımı sıfırla
                
                if (user) {
                    // Kullanıcı var (Giriş yapmış veya Anonim)
                    console.log("Auth durumu değişti. Kullanıcı:", user.uid, "Anonim mi:", user.isAnonymous);
                    currentUserId = user.uid;
                    
                    if (user.isAnonymous) {
                        // Anonim Kullanıcı
                        currentUserRole = 'anonymous'; // Rolü ayarla
                        anonymousMessageCount = 0; // Toplam sayacı sıfırla
                        
                        if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                        if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
                        if (USER_NAME) USER_NAME.textContent = "Anonim Kullanıcı";
                        if (PROFILE_PIC) PROFILE_PIC.textContent = "A";
                        
                        document.querySelectorAll('#chat-history-list .chat-item').forEach(item => item.remove());
                        
                        // DÜZELTME: "Plus" butonunu anonimken GÖSTER
                        if (PLUS_BTN) PLUS_BTN.classList.remove('hidden');

                    } else {
                        // Giriş Yapmış Kullanıcı (Email)
                        currentUserRole = 'normal'; // Varsayılan rol (aşağıda değişebilir)
                        
                        if(LOGIN_VIEW) LOGIN_VIEW.classList.add('hidden');
                        if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.remove('hidden');
                        
                        if (USER_NAME) USER_NAME.textContent = user.email || "Kullanıcı";
                        if (PROFILE_PIC) PROFILE_PIC.textContent = (user.email || "K")[0].toUpperCase();
                        
                        // HATA DÜZELTMESİ: Veri yolunu (users/{uid}/profile/usage) olarak güncelledim.
                        const profileRef = doc(db, "users", user.uid, "profile", "usage");
                        const profileDoc = await getDoc(profileRef);
                        
                        if (profileDoc.exists() && profileDoc.data().isPremium === true) {
                            currentUserRole = 'plus';
                            if (PLUS_BTN) PLUS_BTN.classList.add('hidden'); // Zaten Plus ise butonu gizle
                        } else {
                             if (PLUS_BTN) PLUS_BTN.classList.remove('hidden'); // Plus değilse butonu göster
                        }
                        
                        // Kullanıcı giriş yaptı, sohbet geçmişini dinlemeye başla
                        listenToChatHistory(user.uid);
                    }
                    
                    // Auth durumu değiştiğinde (yeni giriş/çıkış/anonim), sohbeti temizle
                    await startNewChat();
                    
                } else {
                    // Kullanıcı yok (Çıkış yapmış)
                    console.log("Kullanıcı oturumu kapalı (null).");
                    currentUserId = null;
                    currentUserRole = 'anonymous'; // Rolü anonime çek
                    anonymousMessageCount = 0; // Sayacı sıfırla
                    
                    if(LOGIN_VIEW) LOGIN_VIEW.classList.remove('hidden');
                    if(USER_PROFILE_VIEW) USER_PROFILE_VIEW.classList.add('hidden');
                    
                    // Sohbet geçmişini (varsa) durdur
                    document.querySelectorAll('#chat-history-list .chat-item').forEach(item => item.remove());
                    
                    // HATA DÜZELTMESİ: Çıkış yapıldığında, tekrar anonim giriş yap.
                    try {
                        await signInAnonymously(auth);
                        console.log("Çıkış yapıldı, anonim olarak tekrar giriş yapıldı.");
                    } catch (error) {
                         console.error("Anonim giriş hatası (çıkış sonrası):", error);
                         renderSystemMessage(`**Kritik Hata:** Anonim oturum başlatılamadı. ${error.message}. Firebase konsolunda 'Anonymous' (Anonim) giriş yöntemini etkinleştirin.`, "error");
                    }
                }
                
                updateThemeSpecificElements();
            });
        }
        
        // --- Tema Fonksiyonları ---

        function applyTheme(themeName) {
            document.body.className = themeName; // Sınıfı değiştir
            localStorage.setItem('n0thingai_theme', themeName);
            updateThemeSpecificElements();
        }

        // Tema değişiminden etkilenen (CSS değişkeni kullanmayan) elemanları güncelle
        function updateThemeSpecificElements() {
            // Logo rengini güncelle (eğer tema değişirse)
            const theme = localStorage.getItem('n0thingai_theme') || 'dark-mode'; // Varsayılan Koyu (Gri/Beyaz)
            const logoSvg = document.querySelector('.logo-svg');
            if (logoSvg) {
                if (theme === 'light-mode') {
                    logoSvg.style.color = '#FFFFFF';
                } else {
                    logoSvg.style.color = '#FFFFFF'; // Koyu temada da beyaz (kontrast için)
                }
            }
        }

        // --- Mobil Sidebar Fonksiyonları ---
        function toggleSidebar(open) {
            if (open) {
                SIDEBAR.classList.add('open');
                MOBILE_OVERLAY.style.display = 'block';
            } else {
                SIDEBAR.classList.remove('open');
                MOBILE_OVERLAY.style.display = 'none';
            }
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', async () => {
            
            // Olay Dinleyicilerini Ata
            
            // Sohbet
            NEW_CHAT_BTN.addEventListener('click', startNewChat);
            SEND_BTN.addEventListener('click', sendMessage);
            CHAT_INPUT.addEventListener('keydown', handleKey);
            CHAT_INPUT.addEventListener('input', autoResizeTextarea); // Otomatik büyütme
            
            // Mod Değişimi
            IMAGE_MODE_BTN.addEventListener('click', toggleChatMode); // GÖRSEL AKTİF

            // Görsel Yükleme
            ATTACHMENT_BTN.addEventListener('click', () => FILE_INPUT.click());
            FILE_INPUT.addEventListener('change', handleFileSelect);
            REMOVE_ATTACHMENT_BTN.addEventListener('click', removeAttachment);

            // Auth Modal
            // (Global scope'a taşındığı için butonlara direkt onclick verildi)
            
            // Auth Modal Butonları
            // SOSYAL GİRİŞ BUTONLARI KALDIRILDI
            EMAIL_SIGNIN_BTN.addEventListener('click', signInWithEmail);
            SIGNUP_BTN.addEventListener('click', signUpWithEmail);
            SIGNOUT_BTN.addEventListener('click', signOutUser);
            
            // YENİ: Premium Modal Butonları
            PLUS_BTN.addEventListener('click', window.openPremiumModal);
            // CHECKOUT_BTN.addEventListener('click', window.handleCheckout); // MANUEL İPTAL


            // Modal geçiş butonları
            SHOW_SIGNUP_BTN.addEventListener('click', () => {
                MODAL_LOGIN_VIEW.classList.add('hidden');
                MODAL_SIGNUP_VIEW.classList.remove('hidden');
                if(AUTH_ERROR_MESSAGE) AUTH_ERROR_MESSAGE.classList.add('hidden'); // Hataları temizle
            });
            SHOW_SIGNIN_BTN.addEventListener('click', () => {
                MODAL_LOGIN_VIEW.classList.remove('hidden');
                MODAL_SIGNUP_VIEW.classList.add('hidden');
                if(SIGNUP_ERROR_MESSAGE) SIGNUP_ERROR_MESSAGE.classList.add('hidden'); // Hataları temizle
            });
            
            // Tema Değişimi
            THEME_SELECTOR.addEventListener('change', (e) => {
                applyTheme(e.target.value);
            });
            
            // Mobil Sidebar
            OPEN_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar(true));
            CLOSE_SIDEBAR_BTN.addEventListener('click', () => toggleSidebar(false));
            MOBILE_OVERLAY.addEventListener('click', () => toggleSidebar(false));

            // Kayıtlı Temayı Yükle
            const savedTheme = localStorage.getItem('n0thingai_theme') || 'dark-mode'; // VARSAYILAN: KOYU TEMA (Gri/Beyaz)
            applyTheme(savedTheme);
            THEME_SELECTOR.value = savedTheme;
            
            // YENİ: En Alta Kaydırma Olayları
            if (MESSAGES_CONTAINER && SCROLL_TO_BOTTOM_BTN) {
                MESSAGES_CONTAINER.addEventListener('scroll', () => {
                    const isAtBottom = (MESSAGES_CONTAINER.scrollHeight - MESSAGES_CONTAINER.scrollTop - MESSAGES_CONTAINER.clientHeight) < 100;
                    if (isAtBottom) {
                        SCROLL_TO_BOTTOM_BTN.style.display = 'none';
                    } else {
                        SCROLL_TO_BOTTOM_BTN.style.display = 'flex';
                    }
                });
                SCROLL_TO_BOTTOM_BTN.addEventListener('click', autoScroll);
            }

            // --- Uygulamayı Başlat ---
            
            // 1. Auth dinleyicisini kur
            setupAuthListener(); 
            
            // 2. Başlangıçta anonim giriş yapmayı dene
            // (Bu, 'auth/configuration-not-found' hatası verirse,
            // Firebase konsolunda 'Anonymous' girişi etkinleştirilmemiştir)
            if (auth && !auth.currentUser) {
                try {
                    await signInAnonymously(auth);
                    console.log("Başarılı anonim giriş.");
                } catch (error) {
                    console.error("Başlangıç anonim giriş hatası:", error);
                    renderSystemMessage(`**Kritik Hata:** Oturum başlatılamadı. ${error.message}. Lütfen Firebase konsolunuzda 'Anonymous' (Anonim) giriş yöntemini etkinleştirdiğinizden emin olun.`, "error");
                }
            }
        });
    </script>
</body>
</html>
